{% extends "tenant/base.html" %}
{% load static %}

{% block title %}Email Gönderim Logları{% endblock %}

{% block content %}
<div class="content-body">
    <div class="groupbox">
        <div class="groupbox-header">
            <i class="fas fa-list"></i> Email Gönderim Logları
        </div>
        <div class="groupbox-body">
            <!-- İstatistikler -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                <div style="padding: 15px; background: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #495057;">{{ total_logs }}</div>
                    <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">Toplam</div>
                </div>
                <div style="padding: 15px; background: #d4edda; border-radius: 5px; border: 1px solid #c3e6cb; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #155724;">{{ sent_logs }}</div>
                    <div style="font-size: 12px; color: #155724; margin-top: 5px;">Gönderildi</div>
                </div>
                <div style="padding: 15px; background: #d1ecf1; border-radius: 5px; border: 1px solid #bee5eb; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #0c5460;">{{ logs|length }}</div>
                    <div style="font-size: 12px; color: #0c5460; margin-top: 5px;">Bu Sayfada</div>
                </div>
                <div style="padding: 15px; background: #f8d7da; border-radius: 5px; border: 1px solid #f5c6cb; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #721c24;">{{ failed_logs }}</div>
                    <div style="font-size: 12px; color: #721c24; margin-top: 5px;">Başarısız</div>
                </div>
            </div>
            
            <!-- Filtreler -->
            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6;">
                <form method="get" style="display: flex; gap: 15px; align-items: flex-end;">
                    <div style="flex: 1;">
                        <label style="font-size: 12px; color: #495057; margin-bottom: 5px; display: block;">Durum</label>
                        <select name="status" class="form-control" style="font-size: 13px;">
                            <option value="">Tümü</option>
                            <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Beklemede</option>
                            <option value="sent" {% if status_filter == 'sent' %}selected{% endif %}>Gönderildi</option>
                            <option value="delivered" {% if status_filter == 'delivered' %}selected{% endif %}>Teslim Edildi</option>
                            <option value="failed" {% if status_filter == 'failed' %}selected{% endif %}>Başarısız</option>
                            <option value="bounced" {% if status_filter == 'bounced' %}selected{% endif %}>Geri Döndü</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label style="font-size: 12px; color: #495057; margin-bottom: 5px; display: block;">Gateway</label>
                        <select name="gateway" class="form-control" style="font-size: 13px;">
                            <option value="">Tümü</option>
                            {% for gw in gateways %}
                            <option value="{{ gw.pk }}" {% if gateway_filter == gw.pk|stringformat:"s" %}selected{% endif %}>{{ gw.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="flex: 2;">
                        <label style="font-size: 12px; color: #495057; margin-bottom: 5px; display: block;">Ara</label>
                        <input type="text" name="search" class="form-control" placeholder="Email, konu veya alıcı adı..." value="{{ search }}" style="font-size: 13px;">
                    </div>
                    <div>
                        <button type="submit" class="vb-button">
                            <i class="fas fa-filter"></i> Filtrele
                        </button>
                        <a href="{% url 'settings:email_log_list' %}" class="vb-button">
                            <i class="fas fa-times"></i> Temizle
                        </a>
                    </div>
                </form>
            </div>
            
            <!-- Log Listesi -->
            <table class="vb-table">
                <thead>
                    <tr>
                        <th>Tarih</th>
                        <th>Alıcı</th>
                        <th>Konu</th>
                        <th>Gateway</th>
                        <th>Şablon</th>
                        <th>Durum</th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr>
                        <td>{{ log.created_at|date:"d.m.Y H:i" }}</td>
                        <td>{{ log.recipient_email }}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">{{ log.subject|truncatewords:5 }}</td>
                        <td>{{ log.gateway.name|default:"-" }}</td>
                        <td>{{ log.template.name|default:"-" }}</td>
                        <td>
                            {% if log.status == 'sent' %}
                                <span class="badge badge-info">Gönderildi</span>
                            {% elif log.status == 'delivered' %}
                                <span class="badge badge-success">Teslim Edildi</span>
                            {% elif log.status == 'failed' %}
                                <span class="badge badge-danger">Başarısız</span>
                            {% elif log.status == 'pending' %}
                                <span class="badge badge-warning">Beklemede</span>
                            {% elif log.status == 'bounced' %}
                                <span class="badge badge-danger">Geri Döndü</span>
                            {% else %}
                                <span class="badge badge-secondary">{{ log.get_status_display }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'settings:email_log_detail' log.pk %}" class="vb-button small">
                                <i class="fas fa-eye"></i> Detay
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 20px;">
                            <i class="fas fa-info-circle"></i> Henüz email gönderilmemiş.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <!-- Sayfalama -->
            {% if logs.has_other_pages %}
            <div style="margin-top: 20px; display: flex; justify-content: center; gap: 10px;">
                {% if logs.has_previous %}
                <a href="?page={{ logs.previous_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if gateway_filter %}&gateway={{ gateway_filter }}{% endif %}{% if search %}&search={{ search }}{% endif %}" class="vb-button small">
                    <i class="fas fa-chevron-left"></i> Önceki
                </a>
                {% endif %}
                
                <span style="padding: 8px 15px; background: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6;">
                    Sayfa {{ logs.number }} / {{ logs.paginator.num_pages }}
                </span>
                
                {% if logs.has_next %}
                <a href="?page={{ logs.next_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if gateway_filter %}&gateway={{ gateway_filter }}{% endif %}{% if search %}&search={{ search }}{% endif %}" class="vb-button small">
                    Sonraki <i class="fas fa-chevron-right"></i>
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}



{% load static %}

{% block title %}Email Gönderim Logları{% endblock %}

{% block content %}
<div class="content-body">
    <div class="groupbox">
        <div class="groupbox-header">
            <i class="fas fa-list"></i> Email Gönderim Logları
        </div>
        <div class="groupbox-body">
            <!-- İstatistikler -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                <div style="padding: 15px; background: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #495057;">{{ total_logs }}</div>
                    <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">Toplam</div>
                </div>
                <div style="padding: 15px; background: #d4edda; border-radius: 5px; border: 1px solid #c3e6cb; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #155724;">{{ sent_logs }}</div>
                    <div style="font-size: 12px; color: #155724; margin-top: 5px;">Gönderildi</div>
                </div>
                <div style="padding: 15px; background: #d1ecf1; border-radius: 5px; border: 1px solid #bee5eb; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #0c5460;">{{ logs|length }}</div>
                    <div style="font-size: 12px; color: #0c5460; margin-top: 5px;">Bu Sayfada</div>
                </div>
                <div style="padding: 15px; background: #f8d7da; border-radius: 5px; border: 1px solid #f5c6cb; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #721c24;">{{ failed_logs }}</div>
                    <div style="font-size: 12px; color: #721c24; margin-top: 5px;">Başarısız</div>
                </div>
            </div>
            
            <!-- Filtreler -->
            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6;">
                <form method="get" style="display: flex; gap: 15px; align-items: flex-end;">
                    <div style="flex: 1;">
                        <label style="font-size: 12px; color: #495057; margin-bottom: 5px; display: block;">Durum</label>
                        <select name="status" class="form-control" style="font-size: 13px;">
                            <option value="">Tümü</option>
                            <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Beklemede</option>
                            <option value="sent" {% if status_filter == 'sent' %}selected{% endif %}>Gönderildi</option>
                            <option value="delivered" {% if status_filter == 'delivered' %}selected{% endif %}>Teslim Edildi</option>
                            <option value="failed" {% if status_filter == 'failed' %}selected{% endif %}>Başarısız</option>
                            <option value="bounced" {% if status_filter == 'bounced' %}selected{% endif %}>Geri Döndü</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label style="font-size: 12px; color: #495057; margin-bottom: 5px; display: block;">Gateway</label>
                        <select name="gateway" class="form-control" style="font-size: 13px;">
                            <option value="">Tümü</option>
                            {% for gw in gateways %}
                            <option value="{{ gw.pk }}" {% if gateway_filter == gw.pk|stringformat:"s" %}selected{% endif %}>{{ gw.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="flex: 2;">
                        <label style="font-size: 12px; color: #495057; margin-bottom: 5px; display: block;">Ara</label>
                        <input type="text" name="search" class="form-control" placeholder="Email, konu veya alıcı adı..." value="{{ search }}" style="font-size: 13px;">
                    </div>
                    <div>
                        <button type="submit" class="vb-button">
                            <i class="fas fa-filter"></i> Filtrele
                        </button>
                        <a href="{% url 'settings:email_log_list' %}" class="vb-button">
                            <i class="fas fa-times"></i> Temizle
                        </a>
                    </div>
                </form>
            </div>
            
            <!-- Log Listesi -->
            <table class="vb-table">
                <thead>
                    <tr>
                        <th>Tarih</th>
                        <th>Alıcı</th>
                        <th>Konu</th>
                        <th>Gateway</th>
                        <th>Şablon</th>
                        <th>Durum</th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr>
                        <td>{{ log.created_at|date:"d.m.Y H:i" }}</td>
                        <td>{{ log.recipient_email }}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">{{ log.subject|truncatewords:5 }}</td>
                        <td>{{ log.gateway.name|default:"-" }}</td>
                        <td>{{ log.template.name|default:"-" }}</td>
                        <td>
                            {% if log.status == 'sent' %}
                                <span class="badge badge-info">Gönderildi</span>
                            {% elif log.status == 'delivered' %}
                                <span class="badge badge-success">Teslim Edildi</span>
                            {% elif log.status == 'failed' %}
                                <span class="badge badge-danger">Başarısız</span>
                            {% elif log.status == 'pending' %}
                                <span class="badge badge-warning">Beklemede</span>
                            {% elif log.status == 'bounced' %}
                                <span class="badge badge-danger">Geri Döndü</span>
                            {% else %}
                                <span class="badge badge-secondary">{{ log.get_status_display }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'settings:email_log_detail' log.pk %}" class="vb-button small">
                                <i class="fas fa-eye"></i> Detay
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 20px;">
                            <i class="fas fa-info-circle"></i> Henüz email gönderilmemiş.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <!-- Sayfalama -->
            {% if logs.has_other_pages %}
            <div style="margin-top: 20px; display: flex; justify-content: center; gap: 10px;">
                {% if logs.has_previous %}
                <a href="?page={{ logs.previous_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if gateway_filter %}&gateway={{ gateway_filter }}{% endif %}{% if search %}&search={{ search }}{% endif %}" class="vb-button small">
                    <i class="fas fa-chevron-left"></i> Önceki
                </a>
                {% endif %}
                
                <span style="padding: 8px 15px; background: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6;">
                    Sayfa {{ logs.number }} / {{ logs.paginator.num_pages }}
                </span>
                
                {% if logs.has_next %}
                <a href="?page={{ logs.next_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if gateway_filter %}&gateway={{ gateway_filter }}{% endif %}{% if search %}&search={{ search }}{% endif %}" class="vb-button small">
                    Sonraki <i class="fas fa-chevron-right"></i>
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}




