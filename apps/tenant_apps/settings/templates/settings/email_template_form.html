{% extends "tenant/base.html" %}
{% load static %}

{% block title %}{% if template %}Email Şablonu Düzenle{% else %}Yeni Email Şablonu{% endif %}{% endblock %}

{% block content %}
<div class="content-body">
    <div class="groupbox">
        <div class="groupbox-header">
            <i class="fas fa-{% if template %}edit{% else %}plus{% endif %}"></i>
            {% if template %}Email Şablonu Düzenle{% else %}Yeni Email Şablonu{% endif %}
            <div style="float: right;">
                <a href="{% url 'settings:email_template_list' %}" class="vb-button">
                    <i class="fas fa-arrow-left"></i> Geri
                </a>
            </div>
        </div>
        <div class="groupbox-body">
            <form method="post">
                {% csrf_token %}
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div class="form-group">
                        <label for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
                        {{ form.name }}
                        {% if form.name.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.name.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.code.id_for_label }}">{{ form.code.label }}</label>
                        {{ form.code }}
                        {% if form.code.help_text %}
                        <small style="font-size: 11px; color: #666; display: block; margin-top: 4px;">{{ form.code.help_text }}</small>
                        {% endif %}
                        {% if form.code.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.code.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.category.id_for_label }}">{{ form.category.label }}</label>
                        {{ form.category }}
                        {% if form.category.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.category.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.module_usage.id_for_label }}">{{ form.module_usage.label }}</label>
                        {{ form.module_usage }}
                        {% if form.module_usage.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.module_usage.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="{{ form.subject.id_for_label }}">{{ form.subject.label }}</label>
                        {{ form.subject }}
                        <small style="font-size: 11px; color: #666; display: block; margin-top: 4px;">
                            <i class="fas fa-info-circle"></i> Değişkenler için <code>&#123;&#123;değişken_adı&#125;&#125;</code> formatını kullanın.
                            Örnek: <code>&#123;&#123;guest_name&#125;&#125;</code>, <code>&#123;&#123;check_in_date&#125;&#125;</code>
                        </small>
                        {% if form.subject.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.subject.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="{{ form.template_html.id_for_label }}">{{ form.template_html.label }}</label>
                        {{ form.template_html }}
                        <small style="font-size: 11px; color: #666; display: block; margin-top: 4px;">
                            <i class="fas fa-info-circle"></i> HTML formatında email şablonu. Değişkenler için <code>&#123;&#123;değişken_adı&#125;&#125;</code> formatını kullanın.
                        </small>
                        {% if form.template_html.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.template_html.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="{{ form.template_text.id_for_label }}">{{ form.template_text.label }}</label>
                        {{ form.template_text }}
                        <small style="font-size: 11px; color: #666; display: block; margin-top: 4px;">
                            <i class="fas fa-info-circle"></i> Plain text alternatifi (HTML desteklemeyen email istemcileri için). HTML yoksa bu kullanılır.
                        </small>
                        {% if form.template_text.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.template_text.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label><strong>Kullanılabilir Değişkenler</strong></label>
                        <div id="variables-container" style="background: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">
                            <div id="variables-list">
                                <!-- JavaScript ile dinamik olarak doldurulacak -->
                            </div>
                            <button type="button" onclick="addVariable()" class="vb-button small" style="margin-top: 10px;">
                                <i class="fas fa-plus"></i> Değişken Ekle
                            </button>
                        </div>
                        {{ form.available_variables }}
                        <small style="font-size: 11px; color: #666; display: block; margin-top: 4px;">
                            Şablonda kullanılabilecek değişkenler ve açıklamaları
                        </small>
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="{{ form.description.id_for_label }}">{{ form.description.label }}</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.description.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            {{ form.is_active }}
                            <span>{{ form.is_active.label }}</span>
                        </label>
                    </div>
                </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <a href="{% url 'settings:email_template_list' %}" class="vb-button">
                        <i class="fas fa-times"></i> İptal
                    </a>
                    <button type="submit" class="vb-button primary">
                        <i class="fas fa-save"></i> Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const templateHtml = document.getElementById('id_template_html');
    const templateText = document.getElementById('id_template_text');
    const subjectInput = document.getElementById('id_subject');
    const availableVariablesInput = document.getElementById('id_available_variables');
    const variablesList = document.getElementById('variables-list');
    
    // Mevcut değişkenleri yükle
    function loadVariables() {
        if (availableVariablesInput && availableVariablesInput.value) {
            try {
                const variables = JSON.parse(availableVariablesInput.value);
                renderVariables(variables);
            } catch (e) {
                console.error('Variables parse hatası:', e);
            }
        } else {
            // Şablondan değişkenleri otomatik bul
            const allText = (templateHtml ? templateHtml.value : '') + ' ' + 
                          (templateText ? templateText.value : '') + ' ' + 
                          (subjectInput ? subjectInput.value : '');
            const matches = allText.match(/\{\{(\w+)\}\}/g);
            if (matches) {
                const variables = {};
                matches.forEach(match => {
                    const varName = match.replace(/\{\{|\}\}/g, '');
                    if (!variables[varName]) {
                        variables[varName] = varName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    }
                });
                renderVariables(variables);
                updateVariablesInput();
            }
        }
    }
    
    // Değişkenleri render et
    function renderVariables(variables) {
        if (!variables || Object.keys(variables).length === 0) {
            variablesList.innerHTML = '<p style="color: #6c757d; font-size: 13px;">Henüz değişken eklenmemiş.</p>';
            return;
        }
        
        let html = '';
        for (const [key, value] of Object.entries(variables)) {
            html += `
                <div style="display: flex; gap: 10px; margin-bottom: 10px; padding: 10px; background: #fff; border-radius: 3px; border: 1px solid #dee2e6;">
                    <div style="flex: 1;">
                        <input type="text" class="form-control variable-key" value="${key}" placeholder="Değişken adı" style="font-size: 12px; font-family: monospace;" readonly>
                    </div>
                    <div style="flex: 2;">
                        <input type="text" class="form-control variable-value" value="${value}" placeholder="Açıklama" style="font-size: 12px;">
                    </div>
                    <div>
                        <button type="button" onclick="removeVariable(this)" class="vb-button small" style="background: #dc3545; color: white;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }
        variablesList.innerHTML = html;
        
        // Değişken değerleri değiştiğinde güncelle
        document.querySelectorAll('.variable-value').forEach(function(input) {
            input.addEventListener('input', updateVariablesInput);
        });
    }
    
    // Değişkenleri input'a yaz
    function updateVariablesInput() {
        const variables = {};
        document.querySelectorAll('.variable-key').forEach(function(keyInput) {
            const key = keyInput.value.trim();
            const valueInput = keyInput.closest('div').nextElementSibling.querySelector('.variable-value');
            const value = valueInput ? valueInput.value.trim() : '';
            if (key) {
                variables[key] = value || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            }
        });
        
        if (availableVariablesInput) {
            availableVariablesInput.value = JSON.stringify(variables);
        }
    }
    
    // Değişken ekle
    window.addVariable = function() {
        const key = prompt('Değişken adı giriniz (örn: guest_name):', '');
        if (!key || !/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(key)) {
            alert('Geçersiz değişken adı. Sadece harf, rakam ve alt çizgi kullanabilirsiniz.');
            return;
        }
        
        const variables = {};
        if (availableVariablesInput && availableVariablesInput.value) {
            try {
                Object.assign(variables, JSON.parse(availableVariablesInput.value));
            } catch (e) {}
        }
        
        if (variables[key]) {
            alert('Bu değişken zaten ekli.');
            return;
        }
        
        variables[key] = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        renderVariables(variables);
        updateVariablesInput();
    };
    
    // Değişken sil
    window.removeVariable = function(button) {
        if (confirm('Bu değişkeni silmek istediğinize emin misiniz?')) {
            button.closest('div').parentElement.remove();
            updateVariablesInput();
            if (document.querySelectorAll('.variable-key').length === 0) {
                variablesList.innerHTML = '<p style="color: #6c757d; font-size: 13px;">Henüz değişken eklenmemiş.</p>';
            }
        }
    };
    
    // Şablon metinleri değiştiğinde değişkenleri otomatik bul
    [templateHtml, templateText, subjectInput].forEach(function(input) {
        if (input) {
            input.addEventListener('blur', function() {
                const allText = (templateHtml ? templateHtml.value : '') + ' ' + 
                              (templateText ? templateText.value : '') + ' ' + 
                              (subjectInput ? subjectInput.value : '');
                const matches = allText.match(/\{\{(\w+)\}\}/g);
                if (matches) {
                    const variables = {};
                    if (availableVariablesInput && availableVariablesInput.value) {
                        try {
                            Object.assign(variables, JSON.parse(availableVariablesInput.value));
                        } catch (e) {}
                    }
                    
                    matches.forEach(match => {
                        const varName = match.replace(/\{\{|\}\}/g, '');
                        if (!variables[varName]) {
                            variables[varName] = varName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        }
                    });
                    
                    renderVariables(variables);
                    updateVariablesInput();
                }
            });
        }
    });
    
    // İlk yüklemede değişkenleri yükle
    loadVariables();
});
</script>
{% endblock %}



{% load static %}

{% block title %}{% if template %}Email Şablonu Düzenle{% else %}Yeni Email Şablonu{% endif %}{% endblock %}

{% block content %}
<div class="content-body">
    <div class="groupbox">
        <div class="groupbox-header">
            <i class="fas fa-{% if template %}edit{% else %}plus{% endif %}"></i>
            {% if template %}Email Şablonu Düzenle{% else %}Yeni Email Şablonu{% endif %}
            <div style="float: right;">
                <a href="{% url 'settings:email_template_list' %}" class="vb-button">
                    <i class="fas fa-arrow-left"></i> Geri
                </a>
            </div>
        </div>
        <div class="groupbox-body">
            <form method="post">
                {% csrf_token %}
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div class="form-group">
                        <label for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
                        {{ form.name }}
                        {% if form.name.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.name.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.code.id_for_label }}">{{ form.code.label }}</label>
                        {{ form.code }}
                        {% if form.code.help_text %}
                        <small style="font-size: 11px; color: #666; display: block; margin-top: 4px;">{{ form.code.help_text }}</small>
                        {% endif %}
                        {% if form.code.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.code.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.category.id_for_label }}">{{ form.category.label }}</label>
                        {{ form.category }}
                        {% if form.category.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.category.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.module_usage.id_for_label }}">{{ form.module_usage.label }}</label>
                        {{ form.module_usage }}
                        {% if form.module_usage.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.module_usage.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="{{ form.subject.id_for_label }}">{{ form.subject.label }}</label>
                        {{ form.subject }}
                        <small style="font-size: 11px; color: #666; display: block; margin-top: 4px;">
                            <i class="fas fa-info-circle"></i> Değişkenler için <code>&#123;&#123;değişken_adı&#125;&#125;</code> formatını kullanın.
                            Örnek: <code>&#123;&#123;guest_name&#125;&#125;</code>, <code>&#123;&#123;check_in_date&#125;&#125;</code>
                        </small>
                        {% if form.subject.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.subject.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="{{ form.template_html.id_for_label }}">{{ form.template_html.label }}</label>
                        {{ form.template_html }}
                        <small style="font-size: 11px; color: #666; display: block; margin-top: 4px;">
                            <i class="fas fa-info-circle"></i> HTML formatında email şablonu. Değişkenler için <code>&#123;&#123;değişken_adı&#125;&#125;</code> formatını kullanın.
                        </small>
                        {% if form.template_html.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.template_html.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="{{ form.template_text.id_for_label }}">{{ form.template_text.label }}</label>
                        {{ form.template_text }}
                        <small style="font-size: 11px; color: #666; display: block; margin-top: 4px;">
                            <i class="fas fa-info-circle"></i> Plain text alternatifi (HTML desteklemeyen email istemcileri için). HTML yoksa bu kullanılır.
                        </small>
                        {% if form.template_text.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.template_text.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label><strong>Kullanılabilir Değişkenler</strong></label>
                        <div id="variables-container" style="background: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">
                            <div id="variables-list">
                                <!-- JavaScript ile dinamik olarak doldurulacak -->
                            </div>
                            <button type="button" onclick="addVariable()" class="vb-button small" style="margin-top: 10px;">
                                <i class="fas fa-plus"></i> Değişken Ekle
                            </button>
                        </div>
                        {{ form.available_variables }}
                        <small style="font-size: 11px; color: #666; display: block; margin-top: 4px;">
                            Şablonda kullanılabilecek değişkenler ve açıklamaları
                        </small>
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="{{ form.description.id_for_label }}">{{ form.description.label }}</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.description.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            {{ form.is_active }}
                            <span>{{ form.is_active.label }}</span>
                        </label>
                    </div>
                </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <a href="{% url 'settings:email_template_list' %}" class="vb-button">
                        <i class="fas fa-times"></i> İptal
                    </a>
                    <button type="submit" class="vb-button primary">
                        <i class="fas fa-save"></i> Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const templateHtml = document.getElementById('id_template_html');
    const templateText = document.getElementById('id_template_text');
    const subjectInput = document.getElementById('id_subject');
    const availableVariablesInput = document.getElementById('id_available_variables');
    const variablesList = document.getElementById('variables-list');
    
    // Mevcut değişkenleri yükle
    function loadVariables() {
        if (availableVariablesInput && availableVariablesInput.value) {
            try {
                const variables = JSON.parse(availableVariablesInput.value);
                renderVariables(variables);
            } catch (e) {
                console.error('Variables parse hatası:', e);
            }
        } else {
            // Şablondan değişkenleri otomatik bul
            const allText = (templateHtml ? templateHtml.value : '') + ' ' + 
                          (templateText ? templateText.value : '') + ' ' + 
                          (subjectInput ? subjectInput.value : '');
            const matches = allText.match(/\{\{(\w+)\}\}/g);
            if (matches) {
                const variables = {};
                matches.forEach(match => {
                    const varName = match.replace(/\{\{|\}\}/g, '');
                    if (!variables[varName]) {
                        variables[varName] = varName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    }
                });
                renderVariables(variables);
                updateVariablesInput();
            }
        }
    }
    
    // Değişkenleri render et
    function renderVariables(variables) {
        if (!variables || Object.keys(variables).length === 0) {
            variablesList.innerHTML = '<p style="color: #6c757d; font-size: 13px;">Henüz değişken eklenmemiş.</p>';
            return;
        }
        
        let html = '';
        for (const [key, value] of Object.entries(variables)) {
            html += `
                <div style="display: flex; gap: 10px; margin-bottom: 10px; padding: 10px; background: #fff; border-radius: 3px; border: 1px solid #dee2e6;">
                    <div style="flex: 1;">
                        <input type="text" class="form-control variable-key" value="${key}" placeholder="Değişken adı" style="font-size: 12px; font-family: monospace;" readonly>
                    </div>
                    <div style="flex: 2;">
                        <input type="text" class="form-control variable-value" value="${value}" placeholder="Açıklama" style="font-size: 12px;">
                    </div>
                    <div>
                        <button type="button" onclick="removeVariable(this)" class="vb-button small" style="background: #dc3545; color: white;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }
        variablesList.innerHTML = html;
        
        // Değişken değerleri değiştiğinde güncelle
        document.querySelectorAll('.variable-value').forEach(function(input) {
            input.addEventListener('input', updateVariablesInput);
        });
    }
    
    // Değişkenleri input'a yaz
    function updateVariablesInput() {
        const variables = {};
        document.querySelectorAll('.variable-key').forEach(function(keyInput) {
            const key = keyInput.value.trim();
            const valueInput = keyInput.closest('div').nextElementSibling.querySelector('.variable-value');
            const value = valueInput ? valueInput.value.trim() : '';
            if (key) {
                variables[key] = value || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            }
        });
        
        if (availableVariablesInput) {
            availableVariablesInput.value = JSON.stringify(variables);
        }
    }
    
    // Değişken ekle
    window.addVariable = function() {
        const key = prompt('Değişken adı giriniz (örn: guest_name):', '');
        if (!key || !/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(key)) {
            alert('Geçersiz değişken adı. Sadece harf, rakam ve alt çizgi kullanabilirsiniz.');
            return;
        }
        
        const variables = {};
        if (availableVariablesInput && availableVariablesInput.value) {
            try {
                Object.assign(variables, JSON.parse(availableVariablesInput.value));
            } catch (e) {}
        }
        
        if (variables[key]) {
            alert('Bu değişken zaten ekli.');
            return;
        }
        
        variables[key] = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        renderVariables(variables);
        updateVariablesInput();
    };
    
    // Değişken sil
    window.removeVariable = function(button) {
        if (confirm('Bu değişkeni silmek istediğinize emin misiniz?')) {
            button.closest('div').parentElement.remove();
            updateVariablesInput();
            if (document.querySelectorAll('.variable-key').length === 0) {
                variablesList.innerHTML = '<p style="color: #6c757d; font-size: 13px;">Henüz değişken eklenmemiş.</p>';
            }
        }
    };
    
    // Şablon metinleri değiştiğinde değişkenleri otomatik bul
    [templateHtml, templateText, subjectInput].forEach(function(input) {
        if (input) {
            input.addEventListener('blur', function() {
                const allText = (templateHtml ? templateHtml.value : '') + ' ' + 
                              (templateText ? templateText.value : '') + ' ' + 
                              (subjectInput ? subjectInput.value : '');
                const matches = allText.match(/\{\{(\w+)\}\}/g);
                if (matches) {
                    const variables = {};
                    if (availableVariablesInput && availableVariablesInput.value) {
                        try {
                            Object.assign(variables, JSON.parse(availableVariablesInput.value));
                        } catch (e) {}
                    }
                    
                    matches.forEach(match => {
                        const varName = match.replace(/\{\{|\}\}/g, '');
                        if (!variables[varName]) {
                            variables[varName] = varName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        }
                    });
                    
                    renderVariables(variables);
                    updateVariablesInput();
                }
            });
        }
    });
    
    // İlk yüklemede değişkenleri yükle
    loadVariables();
});
</script>
{% endblock %}




