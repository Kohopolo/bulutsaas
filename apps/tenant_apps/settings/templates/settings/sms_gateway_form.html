{% extends "tenant/base.html" %}
{% load static %}

{% block title %}{% if gateway %}SMS Gateway Düzenle{% else %}Yeni SMS Gateway{% endif %}{% endblock %}

{% block content %}
<div class="content-body">
    <div class="groupbox">
        <div class="groupbox-header">
            <i class="fas fa-{% if gateway %}edit{% else %}plus{% endif %}"></i>
            {% if gateway %}SMS Gateway Düzenle{% else %}Yeni SMS Gateway{% endif %}
            <div style="float: right;">
                <a href="{% url 'settings:sms_gateway_list' %}" class="vb-button">
                    <i class="fas fa-arrow-left"></i> Geri
                </a>
            </div>
        </div>
        <div class="groupbox-body">
            <form method="post" id="sms-gateway-form">
                {% csrf_token %}
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
                        {{ form.name }}
                        {% if form.name.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.name.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="{{ form.gateway_type.id_for_label }}">{{ form.gateway_type.label }}</label>
                        {{ form.gateway_type }}
                        {% if form.gateway_type.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.gateway_type.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <!-- API Bilgileri - Dinamik Form Alanları -->
                    <div class="form-group" style="grid-column: span 2;">
                        <label><strong>API Bilgileri</strong></label>
                        <div id="api-credentials-container" style="background: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">
                            <div id="gateway-fields-container">
                                <!-- JavaScript ile dinamik olarak doldurulacak -->
                                <div style="color: #6c757d; font-size: 13px; padding: 10px; background: #fff; border-radius: 3px; border: 1px dashed #ced4da;">
                                    <i class="fas fa-info-circle"></i> Gateway tipi seçiniz.
                                </div>
                            </div>
                        </div>
                        <!-- Gizli alan - JSON verisi buraya yazılacak -->
                        {{ form.api_credentials }}
                        {% if form.api_credentials.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.api_credentials.errors }}</div>
                        {% endif %}
                        <small style="font-size: 11px; color: #666; display: block; margin-top: 8px;">
                            <i class="fas fa-lock"></i> API bilgileriniz güvenli bir şekilde saklanacaktır.
                        </small>
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="{{ form.api_endpoint.id_for_label }}">{{ form.api_endpoint.label }}</label>
                        {{ form.api_endpoint }}
                        {% if form.api_endpoint.help_text %}
                        <small style="font-size: 11px; color: #666; display: block; margin-top: 4px;">{{ form.api_endpoint.help_text }}</small>
                        {% endif %}
                        {% if form.api_endpoint.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.api_endpoint.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.api_timeout.id_for_label }}">{{ form.api_timeout.label }}</label>
                        {{ form.api_timeout }}
                        {% if form.api_timeout.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.api_timeout.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.api_retry_count.id_for_label }}">{{ form.api_retry_count.label }}</label>
                        {{ form.api_retry_count }}
                        {% if form.api_retry_count.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.api_retry_count.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.sender_id.id_for_label }}">{{ form.sender_id.label }}</label>
                        {{ form.sender_id }}
                        {% if form.sender_id.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.sender_id.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.default_country_code.id_for_label }}">{{ form.default_country_code.label }}</label>
                        {{ form.default_country_code }}
                        {% if form.default_country_code.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.default_country_code.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            {{ form.is_active }}
                            <span>{{ form.is_active.label }}</span>
                        </label>
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            {{ form.is_default }}
                            <span>{{ form.is_default.label }}</span>
                        </label>
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            {{ form.is_test_mode }}
                            <span>{{ form.is_test_mode.label }}</span>
                        </label>
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="{{ form.notes.id_for_label }}">{{ form.notes.label }}</label>
                        {{ form.notes }}
                        {% if form.notes.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.notes.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <a href="{% url 'settings:sms_gateway_list' %}" class="vb-button">
                        <i class="fas fa-times"></i> İptal
                    </a>
                    <button type="submit" class="vb-button primary">
                        <i class="fas fa-save"></i> Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const gatewayTypeSelect = document.getElementById('id_gateway_type');
    const apiCredentialsInput = document.getElementById('id_api_credentials');
    const fieldsContainer = document.getElementById('gateway-fields-container');
    const form = document.getElementById('sms-gateway-form');
    
    // Gateway tipine göre alan tanımları
    const gatewayFields = {
        'twilio': {
            required: {
                'account_sid': 'Account SID',
                'auth_token': 'Auth Token'
            },
            optional: {
                'from_number': 'Gönderen Numara (opsiyonel)'
            }
        },
        'netgsm': {
            required: {
                'username': 'Kullanıcı Adı',
                'password': 'Şifre'
            },
            optional: {}
        },
        'verimor': {
            required: {
                'username': 'Kullanıcı Adı',
                'password': 'Şifre'
            },
            optional: {}
        }
    };
    
    // Gateway tipine göre alanları oluştur
    function renderGatewayFields(gatewayType) {
        if (!gatewayType || !gatewayFields[gatewayType]) {
            fieldsContainer.innerHTML = `
                <div style="color: #6c757d; font-size: 13px; padding: 10px; background: #fff; border-radius: 3px; border: 1px dashed #ced4da;">
                    <i class="fas fa-info-circle"></i> Gateway tipi seçiniz.
                </div>
            `;
            return;
        }
        
        const fields = gatewayFields[gatewayType];
        let html = '';
        
        // Gerekli alanlar
        if (fields.required && Object.keys(fields.required).length > 0) {
            html += '<div style="margin-bottom: 15px;">';
            html += '<strong style="color: #495057; font-size: 13px; margin-bottom: 10px; display: block;">';
            html += '<i class="fas fa-asterisk" style="color: #dc3545; font-size: 10px;"></i> Gerekli Alanlar';
            html += '</strong>';
            
            for (const [key, label] of Object.entries(fields.required)) {
                const isPassword = key.toLowerCase().includes('password') || key.toLowerCase().includes('token') || key.toLowerCase().includes('secret');
                html += `
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label for="api_field_${key}" style="font-size: 13px; font-weight: 500; color: #495057; margin-bottom: 5px; display: block;">
                            ${label} <span style="color: #dc3545;">*</span>
                        </label>
                        <input 
                            type="${isPassword ? 'password' : 'text'}" 
                            id="api_field_${key}" 
                            name="api_field_${key}"
                            class="form-control api-credential-field" 
                            data-field-key="${key}"
                            placeholder="${label} giriniz"
                            style="font-size: 13px;"
                        />
                    </div>
                `;
            }
            html += '</div>';
        }
        
        // Opsiyonel alanlar
        if (fields.optional && Object.keys(fields.optional).length > 0) {
            html += '<div>';
            html += '<strong style="color: #495057; font-size: 13px; margin-bottom: 10px; display: block;">';
            html += '<i class="fas fa-info-circle" style="color: #17a2b8; font-size: 10px;"></i> Opsiyonel Alanlar';
            html += '</strong>';
            
            for (const [key, label] of Object.entries(fields.optional)) {
                html += `
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label for="api_field_${key}" style="font-size: 13px; font-weight: 500; color: #495057; margin-bottom: 5px; display: block;">
                            ${label}
                        </label>
                        <input 
                            type="text" 
                            id="api_field_${key}" 
                            name="api_field_${key}"
                            class="form-control api-credential-field" 
                            data-field-key="${key}"
                            placeholder="${label} giriniz (opsiyonel)"
                            style="font-size: 13px;"
                        />
                    </div>
                `;
            }
            html += '</div>';
        }
        
        fieldsContainer.innerHTML = html;
        
        // Mevcut değerleri yükle
        loadExistingCredentials();
    }
    
    // Mevcut API credentials'ı yükle
    function loadExistingCredentials() {
        if (apiCredentialsInput && apiCredentialsInput.value) {
            try {
                const credentials = JSON.parse(apiCredentialsInput.value);
                document.querySelectorAll('.api-credential-field').forEach(function(field) {
                    const fieldKey = field.getAttribute('data-field-key');
                    if (credentials[fieldKey]) {
                        field.value = credentials[fieldKey];
                    }
                });
            } catch (e) {
                console.error('API credentials parse hatası:', e);
            }
        }
    }
    
    // API alanlarını JSON'a dönüştür
    function updateApiCredentials() {
        const credentials = {};
        document.querySelectorAll('.api-credential-field').forEach(function(field) {
            const fieldKey = field.getAttribute('data-field-key');
            const value = field.value.trim();
            if (value) {
                credentials[fieldKey] = value;
            }
        });
        
        if (apiCredentialsInput) {
            apiCredentialsInput.value = JSON.stringify(credentials);
        }
    }
    
    // Gateway tipi değiştiğinde alanları güncelle
    if (gatewayTypeSelect) {
        gatewayTypeSelect.addEventListener('change', function() {
            renderGatewayFields(this.value);
        });
        
        // İlk yüklemede alanları oluştur
        renderGatewayFields(gatewayTypeSelect.value);
    }
    
    // Her alan değiştiğinde JSON'u güncelle
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('api-credential-field')) {
            updateApiCredentials();
        }
    });
    
    // Form gönderilmeden önce JSON'u güncelle
    if (form) {
        form.addEventListener('submit', function(e) {
            updateApiCredentials();
            
            // Gerekli alanları kontrol et
            const gatewayType = gatewayTypeSelect ? gatewayTypeSelect.value : '';
            const fields = gatewayFields[gatewayType];
            
            if (fields && fields.required) {
                let hasError = false;
                const errorMessages = [];
                
                for (const key of Object.keys(fields.required)) {
                    const field = document.querySelector(`.api-credential-field[data-field-key="${key}"]`);
                    if (field && !field.value.trim()) {
                        field.style.borderColor = '#dc3545';
                        hasError = true;
                        errorMessages.push(fields.required[key]);
                    } else if (field) {
                        field.style.borderColor = '';
                    }
                }
                
                if (hasError) {
                    e.preventDefault();
                    alert('Lütfen tüm gerekli alanları doldurunuz:\n- ' + errorMessages.join('\n- '));
                    return false;
                }
            }
        });
    }
    
    // İlk yüklemede JSON'u güncelle
    updateApiCredentials();
});
</script>
{% endblock %}



{% load static %}

{% block title %}{% if gateway %}SMS Gateway Düzenle{% else %}Yeni SMS Gateway{% endif %}{% endblock %}

{% block content %}
<div class="content-body">
    <div class="groupbox">
        <div class="groupbox-header">
            <i class="fas fa-{% if gateway %}edit{% else %}plus{% endif %}"></i>
            {% if gateway %}SMS Gateway Düzenle{% else %}Yeni SMS Gateway{% endif %}
            <div style="float: right;">
                <a href="{% url 'settings:sms_gateway_list' %}" class="vb-button">
                    <i class="fas fa-arrow-left"></i> Geri
                </a>
            </div>
        </div>
        <div class="groupbox-body">
            <form method="post" id="sms-gateway-form">
                {% csrf_token %}
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
                        {{ form.name }}
                        {% if form.name.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.name.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="{{ form.gateway_type.id_for_label }}">{{ form.gateway_type.label }}</label>
                        {{ form.gateway_type }}
                        {% if form.gateway_type.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.gateway_type.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <!-- API Bilgileri - Dinamik Form Alanları -->
                    <div class="form-group" style="grid-column: span 2;">
                        <label><strong>API Bilgileri</strong></label>
                        <div id="api-credentials-container" style="background: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">
                            <div id="gateway-fields-container">
                                <!-- JavaScript ile dinamik olarak doldurulacak -->
                                <div style="color: #6c757d; font-size: 13px; padding: 10px; background: #fff; border-radius: 3px; border: 1px dashed #ced4da;">
                                    <i class="fas fa-info-circle"></i> Gateway tipi seçiniz.
                                </div>
                            </div>
                        </div>
                        <!-- Gizli alan - JSON verisi buraya yazılacak -->
                        {{ form.api_credentials }}
                        {% if form.api_credentials.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.api_credentials.errors }}</div>
                        {% endif %}
                        <small style="font-size: 11px; color: #666; display: block; margin-top: 8px;">
                            <i class="fas fa-lock"></i> API bilgileriniz güvenli bir şekilde saklanacaktır.
                        </small>
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="{{ form.api_endpoint.id_for_label }}">{{ form.api_endpoint.label }}</label>
                        {{ form.api_endpoint }}
                        {% if form.api_endpoint.help_text %}
                        <small style="font-size: 11px; color: #666; display: block; margin-top: 4px;">{{ form.api_endpoint.help_text }}</small>
                        {% endif %}
                        {% if form.api_endpoint.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.api_endpoint.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.api_timeout.id_for_label }}">{{ form.api_timeout.label }}</label>
                        {{ form.api_timeout }}
                        {% if form.api_timeout.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.api_timeout.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.api_retry_count.id_for_label }}">{{ form.api_retry_count.label }}</label>
                        {{ form.api_retry_count }}
                        {% if form.api_retry_count.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.api_retry_count.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.sender_id.id_for_label }}">{{ form.sender_id.label }}</label>
                        {{ form.sender_id }}
                        {% if form.sender_id.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.sender_id.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.default_country_code.id_for_label }}">{{ form.default_country_code.label }}</label>
                        {{ form.default_country_code }}
                        {% if form.default_country_code.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.default_country_code.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            {{ form.is_active }}
                            <span>{{ form.is_active.label }}</span>
                        </label>
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            {{ form.is_default }}
                            <span>{{ form.is_default.label }}</span>
                        </label>
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            {{ form.is_test_mode }}
                            <span>{{ form.is_test_mode.label }}</span>
                        </label>
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="{{ form.notes.id_for_label }}">{{ form.notes.label }}</label>
                        {{ form.notes }}
                        {% if form.notes.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.notes.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <a href="{% url 'settings:sms_gateway_list' %}" class="vb-button">
                        <i class="fas fa-times"></i> İptal
                    </a>
                    <button type="submit" class="vb-button primary">
                        <i class="fas fa-save"></i> Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const gatewayTypeSelect = document.getElementById('id_gateway_type');
    const apiCredentialsInput = document.getElementById('id_api_credentials');
    const fieldsContainer = document.getElementById('gateway-fields-container');
    const form = document.getElementById('sms-gateway-form');
    
    // Gateway tipine göre alan tanımları
    const gatewayFields = {
        'twilio': {
            required: {
                'account_sid': 'Account SID',
                'auth_token': 'Auth Token'
            },
            optional: {
                'from_number': 'Gönderen Numara (opsiyonel)'
            }
        },
        'netgsm': {
            required: {
                'username': 'Kullanıcı Adı',
                'password': 'Şifre'
            },
            optional: {}
        },
        'verimor': {
            required: {
                'username': 'Kullanıcı Adı',
                'password': 'Şifre'
            },
            optional: {}
        }
    };
    
    // Gateway tipine göre alanları oluştur
    function renderGatewayFields(gatewayType) {
        if (!gatewayType || !gatewayFields[gatewayType]) {
            fieldsContainer.innerHTML = `
                <div style="color: #6c757d; font-size: 13px; padding: 10px; background: #fff; border-radius: 3px; border: 1px dashed #ced4da;">
                    <i class="fas fa-info-circle"></i> Gateway tipi seçiniz.
                </div>
            `;
            return;
        }
        
        const fields = gatewayFields[gatewayType];
        let html = '';
        
        // Gerekli alanlar
        if (fields.required && Object.keys(fields.required).length > 0) {
            html += '<div style="margin-bottom: 15px;">';
            html += '<strong style="color: #495057; font-size: 13px; margin-bottom: 10px; display: block;">';
            html += '<i class="fas fa-asterisk" style="color: #dc3545; font-size: 10px;"></i> Gerekli Alanlar';
            html += '</strong>';
            
            for (const [key, label] of Object.entries(fields.required)) {
                const isPassword = key.toLowerCase().includes('password') || key.toLowerCase().includes('token') || key.toLowerCase().includes('secret');
                html += `
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label for="api_field_${key}" style="font-size: 13px; font-weight: 500; color: #495057; margin-bottom: 5px; display: block;">
                            ${label} <span style="color: #dc3545;">*</span>
                        </label>
                        <input 
                            type="${isPassword ? 'password' : 'text'}" 
                            id="api_field_${key}" 
                            name="api_field_${key}"
                            class="form-control api-credential-field" 
                            data-field-key="${key}"
                            placeholder="${label} giriniz"
                            style="font-size: 13px;"
                        />
                    </div>
                `;
            }
            html += '</div>';
        }
        
        // Opsiyonel alanlar
        if (fields.optional && Object.keys(fields.optional).length > 0) {
            html += '<div>';
            html += '<strong style="color: #495057; font-size: 13px; margin-bottom: 10px; display: block;">';
            html += '<i class="fas fa-info-circle" style="color: #17a2b8; font-size: 10px;"></i> Opsiyonel Alanlar';
            html += '</strong>';
            
            for (const [key, label] of Object.entries(fields.optional)) {
                html += `
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label for="api_field_${key}" style="font-size: 13px; font-weight: 500; color: #495057; margin-bottom: 5px; display: block;">
                            ${label}
                        </label>
                        <input 
                            type="text" 
                            id="api_field_${key}" 
                            name="api_field_${key}"
                            class="form-control api-credential-field" 
                            data-field-key="${key}"
                            placeholder="${label} giriniz (opsiyonel)"
                            style="font-size: 13px;"
                        />
                    </div>
                `;
            }
            html += '</div>';
        }
        
        fieldsContainer.innerHTML = html;
        
        // Mevcut değerleri yükle
        loadExistingCredentials();
    }
    
    // Mevcut API credentials'ı yükle
    function loadExistingCredentials() {
        if (apiCredentialsInput && apiCredentialsInput.value) {
            try {
                const credentials = JSON.parse(apiCredentialsInput.value);
                document.querySelectorAll('.api-credential-field').forEach(function(field) {
                    const fieldKey = field.getAttribute('data-field-key');
                    if (credentials[fieldKey]) {
                        field.value = credentials[fieldKey];
                    }
                });
            } catch (e) {
                console.error('API credentials parse hatası:', e);
            }
        }
    }
    
    // API alanlarını JSON'a dönüştür
    function updateApiCredentials() {
        const credentials = {};
        document.querySelectorAll('.api-credential-field').forEach(function(field) {
            const fieldKey = field.getAttribute('data-field-key');
            const value = field.value.trim();
            if (value) {
                credentials[fieldKey] = value;
            }
        });
        
        if (apiCredentialsInput) {
            apiCredentialsInput.value = JSON.stringify(credentials);
        }
    }
    
    // Gateway tipi değiştiğinde alanları güncelle
    if (gatewayTypeSelect) {
        gatewayTypeSelect.addEventListener('change', function() {
            renderGatewayFields(this.value);
        });
        
        // İlk yüklemede alanları oluştur
        renderGatewayFields(gatewayTypeSelect.value);
    }
    
    // Her alan değiştiğinde JSON'u güncelle
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('api-credential-field')) {
            updateApiCredentials();
        }
    });
    
    // Form gönderilmeden önce JSON'u güncelle
    if (form) {
        form.addEventListener('submit', function(e) {
            updateApiCredentials();
            
            // Gerekli alanları kontrol et
            const gatewayType = gatewayTypeSelect ? gatewayTypeSelect.value : '';
            const fields = gatewayFields[gatewayType];
            
            if (fields && fields.required) {
                let hasError = false;
                const errorMessages = [];
                
                for (const key of Object.keys(fields.required)) {
                    const field = document.querySelector(`.api-credential-field[data-field-key="${key}"]`);
                    if (field && !field.value.trim()) {
                        field.style.borderColor = '#dc3545';
                        hasError = true;
                        errorMessages.push(fields.required[key]);
                    } else if (field) {
                        field.style.borderColor = '';
                    }
                }
                
                if (hasError) {
                    e.preventDefault();
                    alert('Lütfen tüm gerekli alanları doldurunuz:\n- ' + errorMessages.join('\n- '));
                    return false;
                }
            }
        });
    }
    
    // İlk yüklemede JSON'u güncelle
    updateApiCredentials();
});
</script>
{% endblock %}




