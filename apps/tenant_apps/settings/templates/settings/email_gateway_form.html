{% extends "tenant/base.html" %}
{% load static %}

{% block title %}{% if gateway %}Email Gateway Düzenle{% else %}Yeni Email Gateway{% endif %}{% endblock %}

{% block content %}
<div class="content-body">
    <div class="groupbox">
        <div class="groupbox-header">
            <i class="fas fa-{% if gateway %}edit{% else %}plus{% endif %}"></i>
            {% if gateway %}Email Gateway Düzenle{% else %}Yeni Email Gateway{% endif %}
            <div style="float: right;">
                <a href="{% url 'settings:email_gateway_list' %}" class="vb-button">
                    <i class="fas fa-arrow-left"></i> Geri
                </a>
            </div>
        </div>
        <div class="groupbox-body">
            <form method="post" id="email-gateway-form">
                {% csrf_token %}
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
                        {{ form.name }}
                        {% if form.name.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.name.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="{{ form.gateway_type.id_for_label }}">{{ form.gateway_type.label }}</label>
                        {{ form.gateway_type }}
                        {% if form.gateway_type.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.gateway_type.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <!-- SMTP Bilgileri - Dinamik Form Alanları -->
                    <div class="form-group" style="grid-column: span 2;">
                        <label><strong>SMTP Bilgileri</strong></label>
                        <div id="smtp-credentials-container" style="background: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">
                            <div id="gateway-fields-container">
                                <!-- JavaScript ile dinamik olarak doldurulacak -->
                                <div style="color: #6c757d; font-size: 13px; padding: 10px; background: #fff; border-radius: 3px; border: 1px dashed #ced4da;">
                                    <i class="fas fa-info-circle"></i> Gateway tipi seçiniz.
                                </div>
                            </div>
                        </div>
                        <!-- Gizli alan - JSON verisi buraya yazılacak -->
                        {{ form.smtp_credentials }}
                        {% if form.smtp_credentials.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.smtp_credentials.errors }}</div>
                        {% endif %}
                        <small style="font-size: 11px; color: #666; display: block; margin-top: 8px;">
                            <i class="fas fa-lock"></i> SMTP bilgileriniz güvenli bir şekilde saklanacaktır.
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.smtp_host.id_for_label }}">{{ form.smtp_host.label }}</label>
                        {{ form.smtp_host }}
                        {% if form.smtp_host.help_text %}
                        <small style="font-size: 11px; color: #666; display: block; margin-top: 4px;">{{ form.smtp_host.help_text }}</small>
                        {% endif %}
                        {% if form.smtp_host.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.smtp_host.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.smtp_port.id_for_label }}">{{ form.smtp_port.label }}</label>
                        {{ form.smtp_port }}
                        {% if form.smtp_port.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.smtp_port.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            {{ form.use_tls }}
                            <span>{{ form.use_tls.label }}</span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            {{ form.use_ssl }}
                            <span>{{ form.use_ssl.label }}</span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.smtp_timeout.id_for_label }}">{{ form.smtp_timeout.label }}</label>
                        {{ form.smtp_timeout }}
                        {% if form.smtp_timeout.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.smtp_timeout.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="{{ form.from_email.id_for_label }}">{{ form.from_email.label }}</label>
                        {{ form.from_email }}
                        {% if form.from_email.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.from_email.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.from_name.id_for_label }}">{{ form.from_name.label }}</label>
                        {{ form.from_name }}
                        {% if form.from_name.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.from_name.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.reply_to.id_for_label }}">{{ form.reply_to.label }}</label>
                        {{ form.reply_to }}
                        {% if form.reply_to.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.reply_to.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            {{ form.is_active }}
                            <span>{{ form.is_active.label }}</span>
                        </label>
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            {{ form.is_default }}
                            <span>{{ form.is_default.label }}</span>
                        </label>
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            {{ form.is_test_mode }}
                            <span>{{ form.is_test_mode.label }}</span>
                        </label>
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="{{ form.notes.id_for_label }}">{{ form.notes.label }}</label>
                        {{ form.notes }}
                        {% if form.notes.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.notes.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <a href="{% url 'settings:email_gateway_list' %}" class="vb-button">
                        <i class="fas fa-times"></i> İptal
                    </a>
                    <button type="submit" class="vb-button primary">
                        <i class="fas fa-save"></i> Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const gatewayTypeSelect = document.getElementById('id_gateway_type');
    const smtpCredentialsInput = document.getElementById('id_smtp_credentials');
    const fieldsContainer = document.getElementById('gateway-fields-container');
    const smtpHostInput = document.getElementById('id_smtp_host');
    const smtpPortInput = document.getElementById('id_smtp_port');
    const useTlsInput = document.getElementById('id_use_tls');
    const form = document.getElementById('email-gateway-form');
    
    // Gateway tipine göre alan tanımları
    const gatewayFields = {
        'gmail': {
            required: {
                'username': 'Gmail Adresi (Email)',
                'password': 'Uygulama Şifresi'
            },
            optional: {},
            defaults: {
                'smtp_host': 'smtp.gmail.com',
                'smtp_port': 587,
                'use_tls': true
            }
        },
        'outlook': {
            required: {
                'username': 'Outlook Adresi (Email)',
                'password': 'Şifre'
            },
            optional: {},
            defaults: {
                'smtp_host': 'smtp.office365.com',
                'smtp_port': 587,
                'use_tls': true
            }
        },
        'custom': {
            required: {
                'username': 'SMTP Kullanıcı Adı',
                'password': 'SMTP Şifre'
            },
            optional: {},
            defaults: {}
        }
    };
    
    // Gateway tipine göre alanları oluştur
    function renderGatewayFields(gatewayType) {
        if (!gatewayType || !gatewayFields[gatewayType]) {
            fieldsContainer.innerHTML = `
                <div style="color: #6c757d; font-size: 13px; padding: 10px; background: #fff; border-radius: 3px; border: 1px dashed #ced4da;">
                    <i class="fas fa-info-circle"></i> Gateway tipi seçiniz.
                </div>
            `;
            return;
        }
        
        const fields = gatewayFields[gatewayType];
        let html = '';
        
        // Gerekli alanlar
        if (fields.required && Object.keys(fields.required).length > 0) {
            html += '<div style="margin-bottom: 15px;">';
            html += '<strong style="color: #495057; font-size: 13px; margin-bottom: 10px; display: block;">';
            html += '<i class="fas fa-asterisk" style="color: #dc3545; font-size: 10px;"></i> Gerekli Alanlar';
            html += '</strong>';
            
            for (const [key, label] of Object.entries(fields.required)) {
                const isPassword = key.toLowerCase().includes('password') || key.toLowerCase().includes('token') || key.toLowerCase().includes('secret');
                html += `
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label for="smtp_field_${key}" style="font-size: 13px; font-weight: 500; color: #495057; margin-bottom: 5px; display: block;">
                            ${label} <span style="color: #dc3545;">*</span>
                        </label>
                        <input 
                            type="${isPassword ? 'password' : 'text'}" 
                            id="smtp_field_${key}" 
                            name="smtp_field_${key}"
                            class="form-control smtp-credential-field" 
                            data-field-key="${key}"
                            placeholder="${label} giriniz"
                            style="font-size: 13px;"
                        />
                    </div>
                `;
            }
            html += '</div>';
        }
        
        // Opsiyonel alanlar
        if (fields.optional && Object.keys(fields.optional).length > 0) {
            html += '<div>';
            html += '<strong style="color: #495057; font-size: 13px; margin-bottom: 10px; display: block;">';
            html += '<i class="fas fa-info-circle" style="color: #17a2b8; font-size: 10px;"></i> Opsiyonel Alanlar';
            html += '</strong>';
            
            for (const [key, label] of Object.entries(fields.optional)) {
                html += `
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label for="smtp_field_${key}" style="font-size: 13px; font-weight: 500; color: #495057; margin-bottom: 5px; display: block;">
                            ${label}
                        </label>
                        <input 
                            type="text" 
                            id="smtp_field_${key}" 
                            name="smtp_field_${key}"
                            class="form-control smtp-credential-field" 
                            data-field-key="${key}"
                            placeholder="${label} giriniz (opsiyonel)"
                            style="font-size: 13px;"
                        />
                    </div>
                `;
            }
            html += '</div>';
        }
        
        fieldsContainer.innerHTML = html;
        
        // Varsayılan değerleri ayarla
        if (fields.defaults) {
            if (fields.defaults.smtp_host && smtpHostInput && !smtpHostInput.value) {
                smtpHostInput.value = fields.defaults.smtp_host;
            }
            if (fields.defaults.smtp_port && smtpPortInput && !smtpPortInput.value) {
                smtpPortInput.value = fields.defaults.smtp_port;
            }
            if (fields.defaults.use_tls !== undefined && useTlsInput) {
                useTlsInput.checked = fields.defaults.use_tls;
            }
        }
        
        // Mevcut değerleri yükle
        loadExistingCredentials();
    }
    
    // Mevcut SMTP credentials'ı yükle
    function loadExistingCredentials() {
        if (smtpCredentialsInput && smtpCredentialsInput.value) {
            try {
                const credentials = JSON.parse(smtpCredentialsInput.value);
                document.querySelectorAll('.smtp-credential-field').forEach(function(field) {
                    const fieldKey = field.getAttribute('data-field-key');
                    if (credentials[fieldKey]) {
                        field.value = credentials[fieldKey];
                    }
                });
            } catch (e) {
                console.error('SMTP credentials parse hatası:', e);
            }
        }
    }
    
    // SMTP alanlarını JSON'a dönüştür
    function updateSmtpCredentials() {
        const credentials = {};
        document.querySelectorAll('.smtp-credential-field').forEach(function(field) {
            const fieldKey = field.getAttribute('data-field-key');
            const value = field.value.trim();
            if (value) {
                credentials[fieldKey] = value;
            }
        });
        
        if (smtpCredentialsInput) {
            smtpCredentialsInput.value = JSON.stringify(credentials);
        }
    }
    
    // Gateway tipi değiştiğinde alanları güncelle
    if (gatewayTypeSelect) {
        gatewayTypeSelect.addEventListener('change', function() {
            renderGatewayFields(this.value);
        });
        
        // İlk yüklemede alanları oluştur
        renderGatewayFields(gatewayTypeSelect.value);
    }
    
    // Her alan değiştiğinde JSON'u güncelle
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('smtp-credential-field')) {
            updateSmtpCredentials();
        }
    });
    
    // Form gönderilmeden önce JSON'u güncelle
    if (form) {
        form.addEventListener('submit', function(e) {
            updateSmtpCredentials();
            
            // Gerekli alanları kontrol et
            const gatewayType = gatewayTypeSelect ? gatewayTypeSelect.value : '';
            const fields = gatewayFields[gatewayType];
            
            if (fields && fields.required) {
                let hasError = false;
                const errorMessages = [];
                
                for (const key of Object.keys(fields.required)) {
                    const field = document.querySelector(`.smtp-credential-field[data-field-key="${key}"]`);
                    if (field && !field.value.trim()) {
                        field.style.borderColor = '#dc3545';
                        hasError = true;
                        errorMessages.push(fields.required[key]);
                    } else if (field) {
                        field.style.borderColor = '';
                    }
                }
                
                if (hasError) {
                    e.preventDefault();
                    alert('Lütfen tüm gerekli alanları doldurunuz:\n- ' + errorMessages.join('\n- '));
                    return false;
                }
            }
        });
    }
    
    // İlk yüklemede JSON'u güncelle
    updateSmtpCredentials();
});
</script>
{% endblock %}



{% load static %}

{% block title %}{% if gateway %}Email Gateway Düzenle{% else %}Yeni Email Gateway{% endif %}{% endblock %}

{% block content %}
<div class="content-body">
    <div class="groupbox">
        <div class="groupbox-header">
            <i class="fas fa-{% if gateway %}edit{% else %}plus{% endif %}"></i>
            {% if gateway %}Email Gateway Düzenle{% else %}Yeni Email Gateway{% endif %}
            <div style="float: right;">
                <a href="{% url 'settings:email_gateway_list' %}" class="vb-button">
                    <i class="fas fa-arrow-left"></i> Geri
                </a>
            </div>
        </div>
        <div class="groupbox-body">
            <form method="post" id="email-gateway-form">
                {% csrf_token %}
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
                        {{ form.name }}
                        {% if form.name.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.name.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="{{ form.gateway_type.id_for_label }}">{{ form.gateway_type.label }}</label>
                        {{ form.gateway_type }}
                        {% if form.gateway_type.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.gateway_type.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <!-- SMTP Bilgileri - Dinamik Form Alanları -->
                    <div class="form-group" style="grid-column: span 2;">
                        <label><strong>SMTP Bilgileri</strong></label>
                        <div id="smtp-credentials-container" style="background: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">
                            <div id="gateway-fields-container">
                                <!-- JavaScript ile dinamik olarak doldurulacak -->
                                <div style="color: #6c757d; font-size: 13px; padding: 10px; background: #fff; border-radius: 3px; border: 1px dashed #ced4da;">
                                    <i class="fas fa-info-circle"></i> Gateway tipi seçiniz.
                                </div>
                            </div>
                        </div>
                        <!-- Gizli alan - JSON verisi buraya yazılacak -->
                        {{ form.smtp_credentials }}
                        {% if form.smtp_credentials.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.smtp_credentials.errors }}</div>
                        {% endif %}
                        <small style="font-size: 11px; color: #666; display: block; margin-top: 8px;">
                            <i class="fas fa-lock"></i> SMTP bilgileriniz güvenli bir şekilde saklanacaktır.
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.smtp_host.id_for_label }}">{{ form.smtp_host.label }}</label>
                        {{ form.smtp_host }}
                        {% if form.smtp_host.help_text %}
                        <small style="font-size: 11px; color: #666; display: block; margin-top: 4px;">{{ form.smtp_host.help_text }}</small>
                        {% endif %}
                        {% if form.smtp_host.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.smtp_host.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.smtp_port.id_for_label }}">{{ form.smtp_port.label }}</label>
                        {{ form.smtp_port }}
                        {% if form.smtp_port.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.smtp_port.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            {{ form.use_tls }}
                            <span>{{ form.use_tls.label }}</span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            {{ form.use_ssl }}
                            <span>{{ form.use_ssl.label }}</span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.smtp_timeout.id_for_label }}">{{ form.smtp_timeout.label }}</label>
                        {{ form.smtp_timeout }}
                        {% if form.smtp_timeout.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.smtp_timeout.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="{{ form.from_email.id_for_label }}">{{ form.from_email.label }}</label>
                        {{ form.from_email }}
                        {% if form.from_email.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.from_email.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.from_name.id_for_label }}">{{ form.from_name.label }}</label>
                        {{ form.from_name }}
                        {% if form.from_name.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.from_name.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.reply_to.id_for_label }}">{{ form.reply_to.label }}</label>
                        {{ form.reply_to }}
                        {% if form.reply_to.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.reply_to.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            {{ form.is_active }}
                            <span>{{ form.is_active.label }}</span>
                        </label>
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            {{ form.is_default }}
                            <span>{{ form.is_default.label }}</span>
                        </label>
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            {{ form.is_test_mode }}
                            <span>{{ form.is_test_mode.label }}</span>
                        </label>
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="{{ form.notes.id_for_label }}">{{ form.notes.label }}</label>
                        {{ form.notes }}
                        {% if form.notes.errors %}
                        <div class="error-message" style="color: #dc3545; font-size: 12px; margin-top: 4px;">{{ form.notes.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <a href="{% url 'settings:email_gateway_list' %}" class="vb-button">
                        <i class="fas fa-times"></i> İptal
                    </a>
                    <button type="submit" class="vb-button primary">
                        <i class="fas fa-save"></i> Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const gatewayTypeSelect = document.getElementById('id_gateway_type');
    const smtpCredentialsInput = document.getElementById('id_smtp_credentials');
    const fieldsContainer = document.getElementById('gateway-fields-container');
    const smtpHostInput = document.getElementById('id_smtp_host');
    const smtpPortInput = document.getElementById('id_smtp_port');
    const useTlsInput = document.getElementById('id_use_tls');
    const form = document.getElementById('email-gateway-form');
    
    // Gateway tipine göre alan tanımları
    const gatewayFields = {
        'gmail': {
            required: {
                'username': 'Gmail Adresi (Email)',
                'password': 'Uygulama Şifresi'
            },
            optional: {},
            defaults: {
                'smtp_host': 'smtp.gmail.com',
                'smtp_port': 587,
                'use_tls': true
            }
        },
        'outlook': {
            required: {
                'username': 'Outlook Adresi (Email)',
                'password': 'Şifre'
            },
            optional: {},
            defaults: {
                'smtp_host': 'smtp.office365.com',
                'smtp_port': 587,
                'use_tls': true
            }
        },
        'custom': {
            required: {
                'username': 'SMTP Kullanıcı Adı',
                'password': 'SMTP Şifre'
            },
            optional: {},
            defaults: {}
        }
    };
    
    // Gateway tipine göre alanları oluştur
    function renderGatewayFields(gatewayType) {
        if (!gatewayType || !gatewayFields[gatewayType]) {
            fieldsContainer.innerHTML = `
                <div style="color: #6c757d; font-size: 13px; padding: 10px; background: #fff; border-radius: 3px; border: 1px dashed #ced4da;">
                    <i class="fas fa-info-circle"></i> Gateway tipi seçiniz.
                </div>
            `;
            return;
        }
        
        const fields = gatewayFields[gatewayType];
        let html = '';
        
        // Gerekli alanlar
        if (fields.required && Object.keys(fields.required).length > 0) {
            html += '<div style="margin-bottom: 15px;">';
            html += '<strong style="color: #495057; font-size: 13px; margin-bottom: 10px; display: block;">';
            html += '<i class="fas fa-asterisk" style="color: #dc3545; font-size: 10px;"></i> Gerekli Alanlar';
            html += '</strong>';
            
            for (const [key, label] of Object.entries(fields.required)) {
                const isPassword = key.toLowerCase().includes('password') || key.toLowerCase().includes('token') || key.toLowerCase().includes('secret');
                html += `
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label for="smtp_field_${key}" style="font-size: 13px; font-weight: 500; color: #495057; margin-bottom: 5px; display: block;">
                            ${label} <span style="color: #dc3545;">*</span>
                        </label>
                        <input 
                            type="${isPassword ? 'password' : 'text'}" 
                            id="smtp_field_${key}" 
                            name="smtp_field_${key}"
                            class="form-control smtp-credential-field" 
                            data-field-key="${key}"
                            placeholder="${label} giriniz"
                            style="font-size: 13px;"
                        />
                    </div>
                `;
            }
            html += '</div>';
        }
        
        // Opsiyonel alanlar
        if (fields.optional && Object.keys(fields.optional).length > 0) {
            html += '<div>';
            html += '<strong style="color: #495057; font-size: 13px; margin-bottom: 10px; display: block;">';
            html += '<i class="fas fa-info-circle" style="color: #17a2b8; font-size: 10px;"></i> Opsiyonel Alanlar';
            html += '</strong>';
            
            for (const [key, label] of Object.entries(fields.optional)) {
                html += `
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label for="smtp_field_${key}" style="font-size: 13px; font-weight: 500; color: #495057; margin-bottom: 5px; display: block;">
                            ${label}
                        </label>
                        <input 
                            type="text" 
                            id="smtp_field_${key}" 
                            name="smtp_field_${key}"
                            class="form-control smtp-credential-field" 
                            data-field-key="${key}"
                            placeholder="${label} giriniz (opsiyonel)"
                            style="font-size: 13px;"
                        />
                    </div>
                `;
            }
            html += '</div>';
        }
        
        fieldsContainer.innerHTML = html;
        
        // Varsayılan değerleri ayarla
        if (fields.defaults) {
            if (fields.defaults.smtp_host && smtpHostInput && !smtpHostInput.value) {
                smtpHostInput.value = fields.defaults.smtp_host;
            }
            if (fields.defaults.smtp_port && smtpPortInput && !smtpPortInput.value) {
                smtpPortInput.value = fields.defaults.smtp_port;
            }
            if (fields.defaults.use_tls !== undefined && useTlsInput) {
                useTlsInput.checked = fields.defaults.use_tls;
            }
        }
        
        // Mevcut değerleri yükle
        loadExistingCredentials();
    }
    
    // Mevcut SMTP credentials'ı yükle
    function loadExistingCredentials() {
        if (smtpCredentialsInput && smtpCredentialsInput.value) {
            try {
                const credentials = JSON.parse(smtpCredentialsInput.value);
                document.querySelectorAll('.smtp-credential-field').forEach(function(field) {
                    const fieldKey = field.getAttribute('data-field-key');
                    if (credentials[fieldKey]) {
                        field.value = credentials[fieldKey];
                    }
                });
            } catch (e) {
                console.error('SMTP credentials parse hatası:', e);
            }
        }
    }
    
    // SMTP alanlarını JSON'a dönüştür
    function updateSmtpCredentials() {
        const credentials = {};
        document.querySelectorAll('.smtp-credential-field').forEach(function(field) {
            const fieldKey = field.getAttribute('data-field-key');
            const value = field.value.trim();
            if (value) {
                credentials[fieldKey] = value;
            }
        });
        
        if (smtpCredentialsInput) {
            smtpCredentialsInput.value = JSON.stringify(credentials);
        }
    }
    
    // Gateway tipi değiştiğinde alanları güncelle
    if (gatewayTypeSelect) {
        gatewayTypeSelect.addEventListener('change', function() {
            renderGatewayFields(this.value);
        });
        
        // İlk yüklemede alanları oluştur
        renderGatewayFields(gatewayTypeSelect.value);
    }
    
    // Her alan değiştiğinde JSON'u güncelle
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('smtp-credential-field')) {
            updateSmtpCredentials();
        }
    });
    
    // Form gönderilmeden önce JSON'u güncelle
    if (form) {
        form.addEventListener('submit', function(e) {
            updateSmtpCredentials();
            
            // Gerekli alanları kontrol et
            const gatewayType = gatewayTypeSelect ? gatewayTypeSelect.value : '';
            const fields = gatewayFields[gatewayType];
            
            if (fields && fields.required) {
                let hasError = false;
                const errorMessages = [];
                
                for (const key of Object.keys(fields.required)) {
                    const field = document.querySelector(`.smtp-credential-field[data-field-key="${key}"]`);
                    if (field && !field.value.trim()) {
                        field.style.borderColor = '#dc3545';
                        hasError = true;
                        errorMessages.push(fields.required[key]);
                    } else if (field) {
                        field.style.borderColor = '';
                    }
                }
                
                if (hasError) {
                    e.preventDefault();
                    alert('Lütfen tüm gerekli alanları doldurunuz:\n- ' + errorMessages.join('\n- '));
                    return false;
                }
            }
        });
    }
    
    // İlk yüklemede JSON'u güncelle
    updateSmtpCredentials();
});
</script>
{% endblock %}




