{% extends "tenant/base.html" %}
{% load static %}

{% block title %}Voucher Detay - {{ voucher.voucher_code }}{% endblock %}

{% block content %}
<div class="content-body">
    <div class="groupbox">
        <div class="groupbox-header">
            <i class="fas fa-ticket-alt"></i> Voucher Detay: {{ voucher.voucher_code }}
            <div style="float: right;">
                <button onclick="sendVoucherWhatsApp()" class="vb-button" style="background: #25D366; color: white; border-color: #25D366;">
                    <i class="fab fa-whatsapp"></i> WhatsApp Gönder
                </button>
                <button onclick="sendVoucherEmail()" class="vb-button" style="background: #007bff; color: white; border-color: #007bff;">
                    <i class="fas fa-envelope"></i> Email Gönder
                </button>
                <button onclick="copyVoucherLink()" class="vb-button" style="background: #6c757d; color: white; border-color: #6c757d;">
                    <i class="fas fa-link"></i> Link Kopyala
                </button>
                <a href="{% url 'reception:reservation_voucher_pdf' voucher.pk %}" class="vb-button primary" target="_blank">
                    <i class="fas fa-file-pdf"></i> PDF İndir
                </a>
                <a href="{% url 'reception:reservation_detail' voucher.reservation.pk %}" class="vb-button">
                    <i class="fas fa-arrow-left"></i> Rezervasyona Dön
                </a>
            </div>
        </div>
        <div class="groupbox-body">
            <!-- Voucher Bilgileri -->
            <div class="form-groupbox" style="margin-bottom: 20px;">
                <div class="groupbox-header">
                    <i class="fas fa-info-circle"></i> Voucher Bilgileri
                </div>
                <div class="groupbox-body">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <div>
                            <strong>Voucher Kodu:</strong> {{ voucher.voucher_code }}
                        </div>
                        <div>
                            <strong>Rezervasyon:</strong> 
                            <a href="{% url 'reception:reservation_detail' voucher.reservation.pk %}">
                                {{ voucher.reservation.reservation_code }}
                            </a>
                        </div>
                        <div>
                            <strong>Oluşturulma Tarihi:</strong> {{ voucher.created_at|date:"d.m.Y H:i" }}
                        </div>
                        {% if voucher.voucher_template %}
                        <div>
                            <strong>Şablon:</strong> {{ voucher.voucher_template.name }}
                        </div>
                        {% endif %}
                        {% if voucher.is_sent %}
                        <div>
                            <strong>Gönderildi:</strong> {{ voucher.sent_at|date:"d.m.Y H:i" }} ({{ voucher.get_sent_via_display }})
                        </div>
                        {% endif %}
                        <div>
                            <strong>Ödeme Durumu:</strong> 
                            <span class="badge badge-{{ voucher.payment_status }}">
                                {{ voucher.get_payment_status_display }}
                            </span>
                        </div>
                        {% if voucher.payment_amount > 0 %}
                        <div>
                            <strong>Ödeme Tutarı:</strong> {{ voucher.payment_amount|floatformat:2 }} {{ voucher.payment_currency }}
                        </div>
                        {% endif %}
                        {% if voucher.access_token %}
                        <div>
                            <strong>Token Link:</strong> 
                            <input type="text" id="voucherLink" value="{{ request.scheme }}://{{ request.get_host }}{{ voucher.get_public_url }}" 
                                   readonly style="width: 100%; padding: 4px; font-size: 11px; border: 1px solid #d4d4d4; border-radius: 3px;">
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Voucher HTML İçeriği -->
            <div class="form-groupbox">
                <div class="groupbox-header">
                    <i class="fas fa-file-alt"></i> Voucher İçeriği
                </div>
                <div class="groupbox-body">
                    <div style="border: 1px solid #d4d4d4; padding: 20px; background: white; border-radius: 3px;">
                        {{ voucher_html|safe }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function sendVoucherWhatsApp() {
    const whatsappUrl = '{{ voucher.get_whatsapp_url }}';
    if (whatsappUrl && whatsappUrl !== 'None') {
        window.open(whatsappUrl, '_blank');
        
        // Gönderim durumunu güncelle
        fetch('{% url "reception:voucher_send" voucher.pk %}?method=whatsapp', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
    } else {
        alert('Müşteri telefon numarası bulunamadı.');
    }
}

function sendVoucherEmail() {
    if (confirm('Voucher email ile gönderilecek. Devam etmek istiyor musunuz?')) {
        fetch('{% url "reception:voucher_send" voucher.pk %}?method=email', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Email başarıyla gönderildi!');
                location.reload();
            } else {
                alert('Email gönderilirken hata oluştu: ' + (data.error || 'Bilinmeyen hata'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Email gönderilirken bir hata oluştu.');
        });
    }
}

function copyVoucherLink() {
    const linkInput = document.getElementById('voucherLink');
    if (linkInput) {
        linkInput.select();
        linkInput.setSelectionRange(0, 99999); // Mobil için
        document.execCommand('copy');
        alert('Voucher linki kopyalandı!');
    }
}
</script>
{% endblock %}

