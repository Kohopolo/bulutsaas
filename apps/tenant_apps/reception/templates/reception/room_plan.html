{% extends "tenant/base.html" %}
{% load static %}
{% load dict_filters %}

{% block title %}Oda Planı - {{ hotel.name }}{% endblock %}

{% block content %}
<div class="content-body">
    <div class="groupbox">
        <div class="groupbox-header">
            <i class="fas fa-building"></i> Oda Planı - {{ hotel.name }}
            <div style="float: right;">
                <a href="{% url 'reception:room_status' %}" class="vb-button">
                    <i class="fas fa-list"></i> Oda Durumu Listesi
                </a>
                <a href="{% url 'reception:dashboard' %}" class="vb-button">
                    <i class="fas fa-arrow-left"></i> Dashboard
                </a>
            </div>
        </div>
        <div class="groupbox-body">
            {% if floors %}
                {% for floor in floors %}
                <div class="form-groupbox" style="margin-bottom: 20px;">
                    <div class="groupbox-header">
                        <i class="fas fa-layer-group"></i> {{ floor.name }} ({{ floor.floor_number }}. Kat)
                    </div>
                    <div class="groupbox-body">
                        <div class="room-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px;">
                            {% with rooms_list=floor_rooms|get_item:floor.id %}
                            {% if rooms_list %}
                                {% for item in rooms_list %}
                                {% with room=item.room reservation=item.reservation %}
                                <div class="room-card" 
                                     data-room-id="{{ room.id }}"
                                     data-status="{{ room.status }}"
                                     data-reservation-id="{% if reservation %}{{ reservation.id }}{% endif %}"
                                     onclick="showRoomDetails({{ room.id }})"
                                     style="
                                         background: {% if room.status == 'available' %}#d4edda{% elif room.status == 'occupied' %}#f8d7da{% elif room.status == 'maintenance' %}#fff3cd{% elif room.status == 'cleaning' %}#cfe2ff{% else %}#e2e3e5{% endif %};
                                         border: 2px solid {% if room.status == 'available' %}#28a745{% elif room.status == 'occupied' %}#dc3545{% elif room.status == 'maintenance' %}#ffc107{% elif room.status == 'cleaning' %}#0d6efd{% else %}#6c757d{% endif %};
                                         padding: 10px;
                                         border-radius: 3px;
                                         cursor: pointer;
                                         text-align: center;
                                         transition: all 0.2s;
                                     ">
                                    <div style="font-weight: bold; font-size: 16px; margin-bottom: 5px;">{{ room.number }}</div>
                                    <div style="font-size: 12px; color: #666; margin-bottom: 3px;">{% if room.room %}{{ room.room.name|truncatewords:2 }}{% else %}Oda Tipi Yok{% endif %}</div>
                                    <div style="font-size: 11px; color: #999;">
                                        {% if reservation %}
                                            <i class="fas fa-user"></i> {{ reservation.customer.get_full_name|truncatewords:1 }}
                                        {% else %}
                                            {{ room.get_status_display }}
                                        {% endif %}
                                    </div>
                                </div>
                                {% endwith %}
                                {% endfor %}
                            {% else %}
                                <div style="grid-column: 1 / -1; text-align: center; color: #999; padding: 20px;">
                                    Bu katta henüz oda numarası tanımlanmamış.
                                </div>
                            {% endif %}
                            {% endwith %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div style="text-align: center; color: #999; padding: 40px; background: #f8f9fa; border: 1px solid #d4d4d4; border-radius: 3px;">
                    <i class="fas fa-info-circle" style="font-size: 48px; margin-bottom: 15px; display: block; color: #0078d4;"></i>
                    <h3 style="color: #333; margin-bottom: 10px;">Oda Planı Tanımlanmamış</h3>
                    <p style="margin-bottom: 20px;">
                        Oda planını görüntülemek için önce kat ve oda numaralarını tanımlamanız gerekmektedir.
                    </p>
                    <div style="margin-top: 20px;">
                        <a href="{% url 'hotels:floor_list' %}" class="vb-button primary" style="margin-right: 10px;">
                            <i class="fas fa-layer-group"></i> Kat Tanımla
                        </a>
                        <a href="{% url 'hotels:room_number_list' %}" class="vb-button primary">
                            <i class="fas fa-door-open"></i> Oda Numarası Tanımla
                        </a>
                    </div>
                </div>
            {% endif %}
            
            <!-- Durum Açıklamaları -->
            <div class="form-groupbox" style="margin-top: 20px;">
                <div class="groupbox-header">
                    <i class="fas fa-info-circle"></i> Durum Açıklamaları
                </div>
                <div class="groupbox-body">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 30px; height: 30px; background: #d4edda; border: 2px solid #28a745; border-radius: 3px;"></div>
                            <span>Müsait</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 30px; height: 30px; background: #f8d7da; border: 2px solid #dc3545; border-radius: 3px;"></div>
                            <span>Dolu</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 30px; height: 30px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 3px;"></div>
                            <span>Bakım</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 30px; height: 30px; background: #cfe2ff; border: 2px solid #0d6efd; border-radius: 3px;"></div>
                            <span>Temizlik</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 30px; height: 30px; background: #e2e3e5; border: 2px solid #6c757d; border-radius: 3px;"></div>
                            <span>Diğer</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Oda Detay Modal -->
<div id="roomDetailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; overflow-y: auto;">
    <div style="position: relative; max-width: 900px; margin: 50px auto; background: white; border: 2px solid #0078d4; border-radius: 3px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div style="background: #0078d4; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; font-size: 18px;">
                <i class="fas fa-door-open"></i> Oda Detayları
            </h2>
            <button onclick="closeRoomDetailModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px;">&times;</button>
        </div>
        <div id="roomDetailContent" style="padding: 20px; max-height: calc(100vh - 150px); overflow-y: auto;">
            <div style="text-align: center; padding: 40px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: #0078d4;"></i>
                <p style="margin-top: 15px; color: #666;">Yükleniyor...</p>
            </div>
        </div>
    </div>
</div>

<style>
.room-card:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.form-groupbox {
    background: #f8f9fa;
    border: 1px solid #d4d4d4;
    border-radius: 3px;
    padding: 0;
}

.groupbox-header {
    background: #e8f4f8;
    border-bottom: 1px solid #c0d4e0;
    padding: 8px 12px;
    font-weight: bold;
    font-size: 14px;
    color: #2c5f8d;
}

.groupbox-body {
    padding: 12px;
}

#roomDetailModal .form-groupbox {
    margin-bottom: 15px;
}

#roomDetailModal .form-grid {
    display: grid;
    grid-template-columns: 150px 1fr;
    gap: 10px;
    align-items: start;
    padding: 10px 0;
}

#roomDetailModal .form-label {
    font-weight: 600;
    font-size: 13px;
    color: #333;
}

#roomDetailModal .form-value {
    font-size: 13px;
    color: #666;
}
</style>

<script>
function showRoomDetails(roomId) {
    const modal = document.getElementById('roomDetailModal');
    const content = document.getElementById('roomDetailContent');
    
    // Modal'ı göster
    modal.style.display = 'block';
    
    // Loading göster
    content.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: #0078d4;"></i>
            <p style="margin-top: 15px; color: #666;">Yükleniyor...</p>
        </div>
    `;
    
    // API'den veri çek
    fetch(`/reception/api/room-detail/${roomId}/`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            renderRoomDetails(data);
        } else {
            content.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #d13438;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 15px;"></i>
                    <p>${data.error || 'Oda bilgileri yüklenemedi.'}</p>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Oda detay yükleme hatası:', error);
        content.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #d13438;">
                <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 15px;"></i>
                <p>Oda bilgileri yüklenirken bir hata oluştu.</p>
            </div>
        `;
    });
}

function renderRoomDetails(data) {
    const room = data.room;
    const reservation = data.current_reservation;
    const pastReservations = data.past_reservations;
    
    let html = '';
    
    // Oda Bilgileri
    html += `
        <div class="form-groupbox">
            <div class="groupbox-header">
                <i class="fas fa-door-open"></i> Oda Bilgileri
            </div>
            <div class="groupbox-body">
                <div class="form-grid">
                    <div class="form-label">Oda Numarası:</div>
                    <div class="form-value"><strong>${room.number}</strong></div>
                    
                    <div class="form-label">Durum:</div>
                    <div class="form-value">
                        <span class="badge badge-${room.status}">${room.status_display}</span>
                    </div>
                    
                    ${room.room_type ? `
                        <div class="form-label">Oda Tipi:</div>
                        <div class="form-value">${room.room_type.name}</div>
                    ` : ''}
                    
                    ${room.floor ? `
                        <div class="form-label">Kat:</div>
                        <div class="form-value">${room.floor.name} (${room.floor.floor_number}. Kat)</div>
                    ` : ''}
                    
                    ${room.block ? `
                        <div class="form-label">Blok:</div>
                        <div class="form-value">${room.block.name}${room.block.code ? ' (' + room.block.code + ')' : ''}</div>
                    ` : ''}
                    
                    ${room.notes ? `
                        <div class="form-label">Notlar:</div>
                        <div class="form-value">${room.notes}</div>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
    
    // Mevcut Rezervasyon
    if (reservation) {
        html += `
            <div class="form-groupbox">
                <div class="groupbox-header">
                    <i class="fas fa-calendar-check"></i> Mevcut Rezervasyon
                </div>
                <div class="groupbox-body">
                    <div class="form-grid">
                        <div class="form-label">Rezervasyon Kodu:</div>
                        <div class="form-value"><strong>${reservation.reservation_code}</strong></div>
                        
                        <div class="form-label">Müşteri:</div>
                        <div class="form-value">
                            ${reservation.customer ? `
                                <strong>${reservation.customer.full_name}</strong><br>
                                ${reservation.customer.phone ? '<small>Tel: ' + reservation.customer.phone + '</small><br>' : ''}
                                ${reservation.customer.email ? '<small>Email: ' + reservation.customer.email + '</small>' : ''}
                            ` : 'Müşteri Yok'}
                        </div>
                        
                        <div class="form-label">Check-in:</div>
                        <div class="form-value">${reservation.check_in_date} ${reservation.check_in_time || ''}</div>
                        
                        <div class="form-label">Check-out:</div>
                        <div class="form-value">${reservation.check_out_date} ${reservation.check_out_time || ''}</div>
                        
                        <div class="form-label">Geceleme:</div>
                        <div class="form-value">${reservation.total_nights} gece</div>
                        
                        <div class="form-label">Misafir:</div>
                        <div class="form-value">${reservation.adult_count} yetişkin, ${reservation.child_count} çocuk</div>
                        
                        <div class="form-label">Toplam Tutar:</div>
                        <div class="form-value"><strong>${reservation.total_amount.toFixed(2)} ${reservation.currency}</strong></div>
                        
                        <div class="form-label">Ödenen:</div>
                        <div class="form-value" style="color: #28a745;"><strong>${reservation.total_paid.toFixed(2)} ${reservation.currency}</strong></div>
                        
                        <div class="form-label">Kalan:</div>
                        <div class="form-value" style="color: #dc3545;"><strong>${reservation.remaining_amount.toFixed(2)} ${reservation.currency}</strong></div>
                        
                        <div class="form-label">Durum:</div>
                        <div class="form-value">
                            <span class="badge badge-${reservation.status}">${reservation.status_display}</span>
                        </div>
                        
                        <div class="form-label">Ödeme Durumu:</div>
                        <div class="form-value">
                            ${reservation.total_paid >= reservation.total_amount ? 
                                '<span class="badge badge-success">Tamamlandı</span>' : 
                                '<span class="badge badge-warning">Beklemede</span>'}
                        </div>
                    </div>
                    
                    ${reservation.guests && reservation.guests.length > 0 ? `
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #d4d4d4;">
                            <h4 style="margin-bottom: 10px; font-size: 14px;">Misafirler:</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                                ${reservation.guests.map(guest => `
                                    <div style="padding: 8px; background: #f8f9fa; border: 1px solid #d4d4d4; border-radius: 3px;">
                                        <strong>${guest.first_name} ${guest.last_name}</strong><br>
                                        <small>${guest.is_adult ? 'Yetişkin' : 'Çocuk'}${guest.age ? ' (' + guest.age + ' yaş)' : ''}</small>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${reservation.payments && reservation.payments.length > 0 ? `
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #d4d4d4;">
                            <h4 style="margin-bottom: 10px; font-size: 14px;">Ödemeler:</h4>
                            <div class="datagrid">
                                <div class="vb-datagrid-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Tarih</th>
                                                <th>Tutar</th>
                                                <th>Yöntem</th>
                                                <th>Tip</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${reservation.payments.map(payment => `
                                                <tr>
                                                    <td>${payment.payment_date || '-'}</td>
                                                    <td>${payment.amount.toFixed(2)} ${payment.currency}</td>
                                                    <td>${payment.payment_method_display || '-'}</td>
                                                    <td><span class="badge badge-info">${payment.payment_type_display || payment.payment_type || '-'}</span></td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 15px; text-align: right;">
                        <a href="/reception/reservations/${reservation.id}/" class="vb-button primary">
                            <i class="fas fa-eye"></i> Rezervasyon Detayı
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `;
    } else {
        html += `
            <div class="form-groupbox">
                <div class="groupbox-header">
                    <i class="fas fa-calendar-times"></i> Mevcut Rezervasyon
                </div>
                <div class="groupbox-body">
                    <p style="text-align: center; color: #999; padding: 20px;">
                        Bu oda için şu anda aktif rezervasyon bulunmamaktadır.
                    </p>
                </div>
            </div>
        `;
    }
    
    // Geçmiş Rezervasyonlar
    if (pastReservations && pastReservations.length > 0) {
        html += `
            <div class="form-groupbox">
                <div class="groupbox-header">
                    <i class="fas fa-history"></i> Geçmiş Rezervasyonlar (Son 10)
                </div>
                <div class="groupbox-body">
                    <div class="datagrid">
                        <div class="vb-datagrid-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Rezervasyon Kodu</th>
                                        <th>Müşteri</th>
                                        <th>Check-in</th>
                                        <th>Check-out</th>
                                        <th>Durum</th>
                                        <th>İşlem</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pastReservations.map(res => `
                                        <tr>
                                            <td><strong>${res.reservation_code}</strong></td>
                                            <td>${res.customer_name}</td>
                                            <td>${res.check_in_date}</td>
                                            <td>${res.check_out_date}</td>
                                            <td><span class="badge badge-${res.status}">${res.status_display}</span></td>
                                            <td>
                                                <a href="/reception/reservations/${res.id}/" class="vb-button small">Detay</a>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    document.getElementById('roomDetailContent').innerHTML = html;
}

function closeRoomDetailModal() {
    document.getElementById('roomDetailModal').style.display = 'none';
}

// Modal dışına tıklanınca kapat
document.addEventListener('click', function(event) {
    const modal = document.getElementById('roomDetailModal');
    if (event.target === modal) {
        closeRoomDetailModal();
    }
});

// ESC tuşu ile kapat
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeRoomDetailModal();
    }
});
</script>
{% endblock %}
