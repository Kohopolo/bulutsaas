{% extends "tenant/base.html" %}
{% load static %}

{% block title %}Oda Durumu - {{ hotel.name }}{% endblock %}

{% block content %}
<div class="content-body">
    <div class="groupbox">
        <div class="groupbox-header">
            <i class="fas fa-list"></i> Oda Durumu - {{ hotel.name }}
            <div style="float: right;">
                <a href="{% url 'reception:room_plan' %}" class="vb-button">
                    <i class="fas fa-building"></i> Oda Planı
                </a>
                <a href="{% url 'reception:dashboard' %}" class="vb-button">
                    <i class="fas fa-arrow-left"></i> Dashboard
                </a>
            </div>
        </div>
        <div class="groupbox-body">
            <!-- Filtreler -->
            <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border: 1px solid #d4d4d4; border-radius: 3px;">
                <form method="get" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <select name="status" style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 3px;">
                        <option value="">Tüm Durumlar</option>
                        {% for value, label in status_choices %}
                        <option value="{{ value }}" {% if current_status == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                    <select name="floor" style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 3px;">
                        <option value="">Tüm Katlar</option>
                        {% for floor in floors %}
                        <option value="{{ floor.id }}" {% if current_floor == floor.id|stringformat:"s" %}selected{% endif %}>{{ floor.name }}</option>
                        {% endfor %}
                    </select>
                    <select name="room_type" style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 3px;">
                        <option value="">Tüm Oda Tipleri</option>
                        {% for room_type in room_types %}
                        <option value="{{ room_type.id }}" {% if current_room_type == room_type.id|stringformat:"s" %}selected{% endif %}>{{ room_type.name }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="vb-button secondary">Filtrele</button>
                    <a href="{% url 'reception:room_status' %}" class="vb-button default">Temizle</a>
                </form>
            </div>
            
            <!-- Durum İstatistikleri -->
            {% if status_counts %}
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
                {% for status_count in status_counts %}
                <div style="background: #f8f9fa; padding: 10px; border: 1px solid #d4d4d4; border-radius: 3px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #2c5f8d;">{{ status_count.count }}</div>
                    <div style="font-size: 12px; color: #666;">
                        {% for value, label in status_choices %}
                            {% if value == status_count.status %}{{ label }}{% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Oda Listesi -->
            {% if room_numbers %}
            <table class="vb-datagrid">
                <thead>
                    <tr>
                        <th>Oda No</th>
                        <th>Oda Tipi</th>
                        <th>Kat</th>
                        <th>Blok</th>
                        <th>Durum</th>
                        <th>Rezervasyon</th>
                        <th>Müşteri</th>
                        <th>Notlar</th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    {% for room_number in room_numbers %}
                    {% for res_id, res in room_reservations.items %}
                        {% if res_id == room_number.id %}
                            {% with reservation=res %}
                        {% endif %}
                    {% empty %}
                        {% with reservation=None %}
                    {% endfor %}
                    <tr>
                        <td style="font-weight: bold;">{{ room_number.number }}</td>
                        <td>{{ room_number.room.name }}</td>
                        <td>{{ room_number.floor.name|default:"-" }}</td>
                        <td>{{ room_number.block.name|default:"-" }}</td>
                        <td>
                            <span style="
                                padding: 4px 8px;
                                border-radius: 3px;
                                font-size: 12px;
                                background: {% if room_number.status == 'available' %}#d4edda{% elif room_number.status == 'occupied' %}#f8d7da{% elif room_number.status == 'maintenance' %}#fff3cd{% elif room_number.status == 'cleaning' %}#cfe2ff{% else %}#e2e3e5{% endif %};
                                color: {% if room_number.status == 'available' %}#155724{% elif room_number.status == 'occupied' %}#721c24{% elif room_number.status == 'maintenance' %}#856404{% elif room_number.status == 'cleaning' %}#004085{% else %}#383d41{% endif %};
                            ">
                                {{ room_number.get_status_display }}
                            </span>
                        </td>
                        <td>
                            {% if reservation %}
                                <a href="{% url 'reception:reservation_detail' reservation.pk %}">
                                    {{ reservation.reservation_code }}
                                </a>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if reservation %}
                                {{ reservation.customer.get_full_name }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>{{ room_number.notes|truncatewords:5|default:"-" }}</td>
                        <td>
                            <select onchange="updateRoomStatus({{ room_number.id }}, this.value)" 
                                    style="padding: 4px 8px; border: 1px solid #ced4da; border-radius: 3px; font-size: 12px;">
                                {% for value, label in status_choices %}
                                <option value="{{ value }}" {% if room_number.status == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </td>
                    </tr>
                    {% endwith %}
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p style="text-align: center; color: #999; padding: 40px;">
                <i class="fas fa-info-circle" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                Filtre kriterlerine uygun oda bulunamadı.
            </p>
            {% endif %}
        </div>
    </div>
</div>

<script>
function updateRoomStatus(roomNumberId, newStatus) {
    if (!confirm('Oda durumunu güncellemek istediğinize emin misiniz?')) {
        location.reload(); // Select'i eski değere döndür
        return;
    }
    
    fetch('/reception/api/room-status-update/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            room_number_id: roomNumberId,
            status: newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Oda durumu başarıyla güncellendi.');
            location.reload();
        } else {
            alert('Hata: ' + data.error);
            location.reload();
        }
    })
    .catch(error => {
        console.error('Hata:', error);
        alert('Oda durumu güncellenirken bir hata oluştu.');
        location.reload();
    });
}
</script>
{% endblock %}
