{% extends "tenant/base.html" %}
{% load static %}

{% block title %}Silinmiş Rezervasyonlar Arşivi{% endblock %}

{% block content %}
<div class="content-body">
    <div class="groupbox">
        <div class="groupbox-header">
            <i class="fas fa-archive"></i> Silinmiş Rezervasyonlar Arşivi
            <div style="float: right;">
                <a href="{% url 'reception:reservation_list' %}" class="vb-button">
                    <i class="fas fa-arrow-left"></i> Rezervasyon Listesi
                </a>
            </div>
        </div>
        <div class="groupbox-body">
            <!-- Filtreler -->
            <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border: 1px solid #d4d4d4; border-radius: 3px;">
                <form method="get" style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" name="search" placeholder="Ara..." value="{{ request.GET.search }}" 
                           style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 3px; flex: 1;">
                    <select name="status" style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 3px;">
                        <option value="">Tüm Durumlar</option>
                        {% for value, label in status_choices %}
                        <option value="{{ value }}" {% if request.GET.status == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="vb-button primary">Filtrele</button>
                    <a href="{% url 'reception:reservation_archived_list' %}" class="vb-button">Temizle</a>
                </form>
            </div>

            <!-- Rezervasyon Tablosu -->
            <div class="datagrid">
                <div class="vb-datagrid-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Rezervasyon Kodu</th>
                                <th>Müşteri</th>
                                <th>Oda</th>
                                <th>Check-in</th>
                                <th>Check-out</th>
                                <th>Gece</th>
                                <th>Tutar</th>
                                <th>Durum</th>
                                <th>Silen Kullanıcı</th>
                                <th>Silinme Tarihi</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reservation in reservations %}
                            <tr>
                                <td><strong>{{ reservation.reservation_code }}</strong></td>
                                <td>{{ reservation.customer.first_name }} {{ reservation.customer.last_name }}</td>
                                <td>{{ reservation.room.name }}{% if reservation.room_number %} - {{ reservation.room_number.number }}{% endif %}</td>
                                <td>{{ reservation.check_in_date|date:"d.m.Y" }}</td>
                                <td>{{ reservation.check_out_date|date:"d.m.Y" }}</td>
                                <td>{{ reservation.total_nights }}</td>
                                <td>{{ reservation.total_amount|floatformat:2 }} {{ reservation.currency }}</td>
                                <td>
                                    <span class="badge badge-{{ reservation.status }}">
                                        {{ reservation.get_status_display }}
                                    </span>
                                </td>
                                <td>{% if reservation.deleted_by %}{{ reservation.deleted_by.get_full_name }}{% else %}-{% endif %}</td>
                                <td>{% if reservation.deleted_at %}{{ reservation.deleted_at|date:"d.m.Y H:i" }}{% else %}-{% endif %}</td>
                                <td>
                                    <a href="{% url 'reception:reservation_detail' reservation.pk %}" class="vb-button small">Detay</a>
                                    <button class="vb-button small restore-btn" 
                                            data-reservation-id="{{ reservation.pk }}"
                                            data-reservation-code="{{ reservation.reservation_code }}"
                                            data-customer-name="{{ reservation.customer.first_name }} {{ reservation.customer.last_name }}"
                                            data-room-name="{{ reservation.room.name }}{% if reservation.room_number %} - {{ reservation.room_number.number }}{% endif %}"
                                            data-check-in="{{ reservation.check_in_date|date:"d.m.Y" }}"
                                            data-check-out="{{ reservation.check_out_date|date:"d.m.Y" }}"
                                            style="background: #28a745; color: white; border-color: #28a745;">
                                        <i class="fas fa-undo"></i> Geri Al
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="11" style="text-align: center; padding: 40px; color: #999;">
                                    <i class="fas fa-inbox" style="font-size: 32px; display: block; margin-bottom: 10px;"></i>
                                    Silinmiş rezervasyon bulunmamaktadır.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Sayfalama -->
            {% if reservations.has_other_pages %}
            <div style="margin-top: 15px; text-align: center;">
                {% if reservations.has_previous %}
                <a href="?page={{ reservations.previous_page_number }}" class="vb-button">Önceki</a>
                {% endif %}
                <span style="margin: 0 10px;">Sayfa {{ reservations.number }} / {{ reservations.paginator.num_pages }}</span>
                {% if reservations.has_next %}
                <a href="?page={{ reservations.next_page_number }}" class="vb-button">Sonraki</a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Geri Alma Modalı JavaScript -->
<script>
let currentRestoreReservationId = null;
let currentRestoreReservationCode = null;

// Modal CSS (eğer yoksa ekle)
if (!document.getElementById('restoreModalStyles')) {
    const style = document.createElement('style');
    style.id = 'restoreModalStyles';
    style.textContent = `
        .vb-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .vb-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }
        .vb-modal-content {
            position: relative;
            background: white;
            border: 2px solid #c0d4e0;
            border-radius: 3px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 10001;
            display: flex;
            flex-direction: column;
            max-height: 95vh;
            overflow-y: auto;
        }
        .vb-modal-header {
            background: #e8f4f8;
            border-bottom: 1px solid #c0d4e0;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .vb-modal-title {
            font-size: 16px;
            font-weight: bold;
            color: #2c5f8d;
            margin: 0;
        }
        .vb-modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: #666;
            cursor: pointer;
            padding: 5px 10px;
        }
        .vb-modal-close:hover {
            color: #000;
        }
        .vb-modal-body {
            padding: 20px;
            overflow-y: auto;
        }
    `;
    document.head.appendChild(style);
}

function openRestoreReservationModal(reservationId, reservationCode, customerName, roomName, checkIn, checkOut) {
    console.log('openRestoreReservationModal çağrıldı:', { reservationId, reservationCode });
    currentRestoreReservationId = reservationId;
    currentRestoreReservationCode = reservationCode;
    
    const modalHtml = `
        <div id="restoreReservationModal" class="vb-modal" style="display: flex;">
            <div class="vb-modal-overlay" onclick="closeRestoreModal()"></div>
            <div class="vb-modal-content" style="max-width: 500px;">
                <div class="vb-modal-header">
                    <h3 class="vb-modal-title">
                        <i class="fas fa-undo" style="color: #28a745;"></i> Rezervasyonu Geri Al
                    </h3>
                    <button type="button" class="vb-modal-close" onclick="closeRestoreModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="vb-modal-body">
                    <div id="restoreStep1">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <i class="fas fa-undo" style="font-size: 64px; color: #28a745; margin-bottom: 20px;"></i>
                            <h3 style="color: #28a745; margin-bottom: 15px;">Rezervasyonu Geri Al</h3>
                            <p style="font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
                                Bu rezervasyonu <strong>aktifleştirmek</strong> istediğinizden emin misiniz?
                            </p>
                            <div style="background: #d4edda; padding: 15px; border-radius: 5px; border-left: 4px solid #28a745; margin-bottom: 20px; text-align: left;">
                                <strong>Rezervasyon Bilgileri:</strong><br>
                                <strong>Kod:</strong> ${reservationCode}<br>
                                <strong>Müşteri:</strong> ${customerName}<br>
                                <strong>Oda:</strong> ${roomName}<br>
                                <strong>Tarih:</strong> ${checkIn} - ${checkOut}
                            </div>
                            <p style="color: #666; font-size: 14px;">
                                <i class="fas fa-info-circle"></i> Rezervasyon aktif hale gelecek ve normal rezervasyon listesinde görünecektir.
                            </p>
                        </div>
                        <div style="text-align: center; margin-top: 25px;">
                            <button onclick="proceedToRestoreStep2()" class="vb-button" style="background: #28a745; color: white; border-color: #28a745; padding: 12px 30px; font-size: 16px;">
                                <i class="fas fa-check"></i> Evet, Devam Et
                            </button>
                            <button onclick="closeRestoreModal()" class="vb-button" style="padding: 12px 30px; font-size: 16px; margin-left: 10px;">
                                <i class="fas fa-times"></i> İptal
                            </button>
                        </div>
                    </div>
                    <div id="restoreStep2" style="display: none;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <i class="fas fa-shield-alt" style="font-size: 64px; color: #28a745; margin-bottom: 20px;"></i>
                            <h3 style="color: #28a745; margin-bottom: 15px;">Son Onay</h3>
                            <p style="font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
                                Geri alma işlemini tamamlamak için aşağıdaki bilgileri girin:
                            </p>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 5px; margin-bottom: 20px; text-align: left;">
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">
                                        Rezervasyon Kodu:
                                    </label>
                                    <input type="text" id="restoreReservationCode" 
                                           placeholder="${reservationCode}" 
                                           style="width: 100%; padding: 10px; border: 2px solid #28a745; border-radius: 5px; font-size: 16px; text-align: center; font-weight: bold;"
                                           autocomplete="off">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">
                                        Onay Metni (RESTORE yazın):
                                    </label>
                                    <input type="text" id="restoreConfirmText" 
                                           placeholder="RESTORE" 
                                           style="width: 100%; padding: 10px; border: 2px solid #28a745; border-radius: 5px; font-size: 16px; text-align: center; font-weight: bold; text-transform: uppercase;"
                                           autocomplete="off">
                                </div>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 25px;">
                            <button onclick="confirmRestoreReservation()" id="confirmRestoreBtn" class="vb-button" style="background: #28a745; color: white; border-color: #28a745; padding: 12px 30px; font-size: 16px;" disabled>
                                <i class="fas fa-undo"></i> Geri Almayı Onayla
                            </button>
                            <button onclick="backToRestoreStep1()" class="vb-button" style="padding: 12px 30px; font-size: 16px; margin-left: 10px;">
                                <i class="fas fa-arrow-left"></i> Geri
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const oldModal = document.getElementById('restoreReservationModal');
    if (oldModal) {
        oldModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    document.body.style.overflow = 'hidden';
    
    // Modal'ın görünür olduğundan emin ol
    const modal = document.getElementById('restoreReservationModal');
    if (modal) {
        modal.style.display = 'flex';
        console.log('Modal oluşturuldu ve görünür hale getirildi');
    } else {
        console.error('Modal oluşturulamadı!');
    }
}

function closeRestoreModal() {
    const modal = document.getElementById('restoreReservationModal');
    if (modal) {
        modal.remove();
        document.body.style.overflow = '';
    }
    currentRestoreReservationId = null;
    currentRestoreReservationCode = null;
}

function proceedToRestoreStep2() {
    const step1 = document.getElementById('restoreStep1');
    const step2 = document.getElementById('restoreStep2');
    
    if (!step1 || !step2) {
        console.error('Restore modal adımları bulunamadı');
        return;
    }
    
    step1.style.display = 'none';
    step2.style.display = 'block';
    
    setTimeout(() => {
        const codeInput = document.getElementById('restoreReservationCode');
        if (codeInput) {
            codeInput.focus();
        }
    }, 100);
    
    const codeInput = document.getElementById('restoreReservationCode');
    const confirmInput = document.getElementById('restoreConfirmText');
    const confirmBtn = document.getElementById('confirmRestoreBtn');
    
    if (!codeInput || !confirmInput || !confirmBtn) {
        console.error('Restore modal input elementleri bulunamadı');
        return;
    }
    
    function checkInputs() {
        const codeValue = codeInput.value.trim();
        const confirmValue = confirmInput.value.trim().toUpperCase();
        const expectedCode = currentRestoreReservationCode || '';
        
        if (codeValue === expectedCode && confirmValue === 'RESTORE') {
            confirmBtn.disabled = false;
            confirmBtn.style.opacity = '1';
        } else {
            confirmBtn.disabled = true;
            confirmBtn.style.opacity = '0.5';
        }
    }
    
    // Eski listener'ları kaldır ve yenilerini ekle
    codeInput.removeEventListener('input', checkInputs);
    confirmInput.removeEventListener('input', checkInputs);
    codeInput.addEventListener('input', checkInputs);
    confirmInput.addEventListener('input', checkInputs);
    
    // İlk kontrolü yap
    checkInputs();
}

function backToRestoreStep1() {
    document.getElementById('restoreStep1').style.display = 'block';
    document.getElementById('restoreStep2').style.display = 'none';
    document.getElementById('restoreReservationCode').value = '';
    document.getElementById('restoreConfirmText').value = '';
    document.getElementById('confirmRestoreBtn').disabled = true;
}

function confirmRestoreReservation() {
    if (!currentRestoreReservationId) {
        alert('Rezervasyon ID bulunamadı.');
        console.error('currentRestoreReservationId:', currentRestoreReservationId);
        return;
    }
    
    const codeInput = document.getElementById('restoreReservationCode');
    const confirmInput = document.getElementById('restoreConfirmText');
    
    if (!codeInput || !confirmInput) {
        alert('Form elementleri bulunamadı.');
        console.error('Form elementleri bulunamadı');
        return;
    }
    
    const codeValue = codeInput.value.trim();
    const confirmValue = confirmInput.value.trim().toUpperCase();
    const expectedCode = currentRestoreReservationCode || '';
    
    if (codeValue !== expectedCode) {
        alert('Rezervasyon kodu eşleşmiyor!');
        codeInput.focus();
        return;
    }
    
    if (confirmValue !== 'RESTORE') {
        alert('Onay metni hatalı! Lütfen "RESTORE" yazın.');
        confirmInput.focus();
        return;
    }
    
    const confirmBtn = document.getElementById('confirmRestoreBtn');
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Geri Alınıyor...';
    
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                     document.cookie.match(/csrftoken=([^;]+)/)?.[1];
    
    const formData = new FormData();
    formData.append('confirm_step', '2');
    formData.append('reservation_code', codeValue);
    formData.append('final_confirm', confirmValue);
    
    fetch(`/reception/reservations/${currentRestoreReservationId}/restore/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message || 'Rezervasyon başarıyla geri alındı ve aktifleştirildi.');
            if (data.redirect_url) {
                window.location.href = data.redirect_url;
            } else {
                window.location.reload();
            }
        } else {
            alert(data.error || 'Rezervasyon geri alınırken bir hata oluştu.');
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '<i class="fas fa-undo"></i> Geri Almayı Onayla';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Rezervasyon geri alınırken bir hata oluştu.');
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = '<i class="fas fa-undo"></i> Geri Almayı Onayla';
    });
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeRestoreModal();
    }
});

// Geri Al butonları için event listener'lar
document.addEventListener('DOMContentLoaded', function() {
    const restoreButtons = document.querySelectorAll('.restore-btn');
    restoreButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            const reservationId = parseInt(this.getAttribute('data-reservation-id'));
            const reservationCode = this.getAttribute('data-reservation-code');
            const customerName = this.getAttribute('data-customer-name');
            const roomName = this.getAttribute('data-room-name');
            const checkIn = this.getAttribute('data-check-in');
            const checkOut = this.getAttribute('data-check-out');
            
            console.log('Geri Al butonu tıklandı:', {
                reservationId,
                reservationCode,
                customerName,
                roomName,
                checkIn,
                checkOut
            });
            
            openRestoreReservationModal(
                reservationId,
                reservationCode,
                customerName,
                roomName,
                checkIn,
                checkOut
            );
        });
    });
});
</script>
{% endblock %}

