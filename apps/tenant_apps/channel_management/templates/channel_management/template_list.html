{% extends "tenant/base.html" %}
{% load static %}

{% block title %}Kanal Şablonları{% endblock %}

{% block content %}
<div class="content-body">
    <div class="groupbox">
        <div class="groupbox-header">
            <i class="fas fa-list"></i> Kanal Şablonları
        </div>
        <div class="groupbox-body">
            <!-- Popüler Kanallar -->
            {% if popular_templates %}
            <h3 style="margin-bottom: 15px; color: #333; font-size: 14px; font-weight: bold;">Popüler Kanallar</h3>
            <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 30px; width: 100%; max-width: 100%; overflow-x: hidden;">
                {% for template in popular_templates %}
                <div style="background: #f8f9fa; border: 1px solid #d4d4d4; border-radius: 3px; padding: 10px; display: flex; flex-direction: column; min-width: 0;">
                    <div style="display: flex; align-items: center; margin-bottom: 8px; flex-shrink: 0;">
                        <i class="{{ template.icon }}" style="font-size: 18px; color: #2c5f8d; margin-right: 6px; flex-shrink: 0;"></i>
                        <h4 style="margin: 0; font-size: 12px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ template.name }}</h4>
                    </div>
                    <p style="font-size: 10px; color: #666; margin-bottom: 8px; line-height: 1.3; flex: 1; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">{{ template.description|truncatewords:15 }}</p>
                    <div style="display: flex; gap: 3px; flex-wrap: wrap; margin-bottom: 8px; flex-shrink: 0;">
                        {% if template.supports_pricing %}
                        <span style="display: inline-block; padding: 1px 4px; background: #28a745; color: white; border-radius: 2px; font-size: 9px;">Fiyat</span>
                        {% endif %}
                        {% if template.supports_availability %}
                        <span style="display: inline-block; padding: 1px 4px; background: #17a2b8; color: white; border-radius: 2px; font-size: 9px;">Müsaitlik</span>
                        {% endif %}
                        {% if template.supports_reservations %}
                        <span style="display: inline-block; padding: 1px 4px; background: #007bff; color: white; border-radius: 2px; font-size: 9px;">Rezervasyon</span>
                        {% endif %}
                        {% if template.supports_two_way %}
                        <span style="display: inline-block; padding: 1px 4px; background: #6c757d; color: white; border-radius: 2px; font-size: 9px;">İki Yönlü</span>
                        {% endif %}
                    </div>
                    <div style="display: flex; gap: 4px; flex-direction: column; flex-shrink: 0;">
                        <a href="{% url 'channel_management:template_detail' template.pk %}" class="vb-button" style="padding: 3px 6px; font-size: 10px; width: 100%; text-align: center; white-space: nowrap;">
                            <i class="fas fa-info-circle"></i> Detaylar
                        </a>
                        <button onclick="testConnection({{ template.pk }}, '{{ template.name }}')" class="vb-button" style="padding: 3px 6px; font-size: 10px; width: 100%; background: #17a2b8; color: white; border: none; cursor: pointer; white-space: nowrap;">
                            <i class="fas fa-plug"></i> Test
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Tüm Kanallar (Kategoriye Göre) -->
            {% for channel_type, type_templates in templates_by_type.items %}
            <h3 style="margin-bottom: 15px; color: #333; font-size: 14px; font-weight: bold; margin-top: 30px;">
                {{ type_templates.0.get_channel_type_display }}
            </h3>
            <div class="datagrid">
                <div class="vb-datagrid-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Kanal Adı</th>
                                <th>API Tipi</th>
                                <th>Özellikler</th>
                                <th>Varsayılan Komisyon</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for template in type_templates %}
                            <tr>
                                <td>
                                    <div style="display: flex; align-items: center;">
                                        <i class="{{ template.icon }}" style="margin-right: 8px; color: #2c5f8d;"></i>
                                        <strong>{{ template.name }}</strong>
                                    </div>
                                    {% if template.description %}
                                    <br><small style="color: #666; font-size: 11px;">{{ template.description|truncatewords:15 }}</small>
                                    {% endif %}
                                </td>
                                <td>{{ template.get_api_type_display|upper }}</td>
                                <td>
                                    <div style="display: flex; gap: 3px; flex-wrap: wrap;">
                                        {% if template.supports_pricing %}
                                        <span style="display: inline-block; padding: 2px 6px; background: #28a745; color: white; border-radius: 3px; font-size: 10px;">Fiyat</span>
                                        {% endif %}
                                        {% if template.supports_availability %}
                                        <span style="display: inline-block; padding: 2px 6px; background: #17a2b8; color: white; border-radius: 3px; font-size: 10px;">Müsaitlik</span>
                                        {% endif %}
                                        {% if template.supports_reservations %}
                                        <span style="display: inline-block; padding: 2px 6px; background: #007bff; color: white; border-radius: 3px; font-size: 10px;">Rezervasyon</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>{{ template.default_commission_rate }}%</td>
                                <td>
                                    <a href="{% url 'channel_management:template_detail' template.pk %}" class="vb-button" style="padding: 4px 8px; font-size: 11px; margin-right: 5px;">
                                        <i class="fas fa-info-circle"></i> Detay
                                    </a>
                                    <a href="{% url 'channel_management:configuration_create' %}?template_id={{ template.pk }}" class="vb-button primary" style="padding: 4px 8px; font-size: 11px; margin-right: 5px;">
                                        <i class="fas fa-plus"></i> Yapılandır
                                    </a>
                                    <button onclick="testConnection({{ template.pk }}, '{{ template.name }}')" class="vb-button" style="padding: 4px 8px; font-size: 11px; background: #17a2b8; color: white; border: none; cursor: pointer;">
                                        <i class="fas fa-plug"></i> Bağlantı Testi
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
function testConnection(templateId, templateName) {
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    
    // Butonu devre dışı bırak ve loading göster
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Test Ediliyor...';
    
    // AJAX isteği gönder
    fetch(`/channel-management/templates/${templateId}/test-connection/`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✓ ' + data.message);
            button.style.background = '#28a745';
            button.innerHTML = '<i class="fas fa-check"></i> Başarılı';
        } else {
            alert('✗ ' + data.message);
            button.style.background = '#dc3545';
            button.innerHTML = '<i class="fas fa-times"></i> Başarısız';
        }
        
        // 3 saniye sonra butonu eski haline getir
        setTimeout(() => {
            button.disabled = false;
            button.style.background = '#17a2b8';
            button.innerHTML = originalText;
        }, 3000);
    })
    .catch(error => {
        console.error('Bağlantı testi hatası:', error);
        alert('Bağlantı testi sırasında bir hata oluştu.');
        button.disabled = false;
        button.style.background = '#17a2b8';
        button.innerHTML = originalText;
    });
}
</script>
{% endblock %}

