{% extends "tenant/base.html" %}
{% load static %}

{% block title %}{{ configuration.name }} - Kanal Konfigürasyonu Detayı{% endblock %}

{% block content %}
<div class="content-body">
    <div class="groupbox">
        <div class="groupbox-header">
            <i class="fas fa-cog"></i> {{ configuration.name }} - Kanal Konfigürasyonu Detayı
            <div style="float: right;">
                <a href="{% url 'channel_management:configuration_list' %}" class="vb-button" style="margin-right: 10px;">
                    <i class="fas fa-arrow-left"></i> Geri
                </a>
                <a href="{% url 'channel_management:configuration_update' configuration.pk %}" class="vb-button" style="margin-right: 10px;">
                    <i class="fas fa-edit"></i> Düzenle
                </a>
                {% if configuration.sync_enabled %}
                <button onclick="triggerSync({{ configuration.pk }})" class="vb-button" style="background: #17a2b8; color: white; border-color: #138496;">
                    <i class="fas fa-sync"></i> Senkronize Et
                </button>
                {% endif %}
            </div>
        </div>
        <div class="groupbox-body">
            <!-- İstatistikler -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                <div style="background: #f8f9fa; border: 1px solid #d4d4d4; border-radius: 3px; padding: 15px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #2c5f8d;">{{ stats.total_syncs }}</div>
                    <div style="font-size: 12px; color: #666;">Toplam Senkronizasyon</div>
                </div>
                <div style="background: #f8f9fa; border: 1px solid #d4d4d4; border-radius: 3px; padding: 15px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #28a745;">{{ stats.successful_syncs }}</div>
                    <div style="font-size: 12px; color: #666;">Başarılı Senkronizasyon</div>
                </div>
                <div style="background: #f8f9fa; border: 1px solid #d4d4d4; border-radius: 3px; padding: 15px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #007bff;">{{ stats.total_reservations }}</div>
                    <div style="font-size: 12px; color: #666;">Toplam Rezervasyon</div>
                </div>
                <div style="background: #f8f9fa; border: 1px solid #d4d4d4; border-radius: 3px; padding: 15px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #ffc107;">{{ stats.pending_reservations }}</div>
                    <div style="font-size: 12px; color: #666;">Bekleyen Rezervasyon</div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                <!-- Sol Kolon -->
                <div>
                    <div class="form-groupbox" style="margin-bottom: 20px;">
                        <div class="groupbox-header">
                            <i class="fas fa-info-circle"></i> Temel Bilgiler
                        </div>
                        <div class="groupbox-body">
                            <div class="form-group">
                                <label><strong>Kanal Şablonu:</strong></label>
                                <p><i class="{{ configuration.template.icon }}"></i> {{ configuration.template.name }}</p>
                            </div>
                            {% if configuration.hotel %}
                            <div class="form-group">
                                <label><strong>Otel:</strong></label>
                                <p>{{ configuration.hotel.name }}</p>
                            </div>
                            {% endif %}
                            <div class="form-group">
                                <label><strong>Durum:</strong></label>
                                <p>
                                    {% if configuration.is_active %}
                                    <span style="display: inline-block; padding: 3px 8px; background: #28a745; color: white; border-radius: 3px; font-size: 11px; font-weight: bold;">Aktif</span>
                                    {% else %}
                                    <span style="display: inline-block; padding: 3px 8px; background: #6c757d; color: white; border-radius: 3px; font-size: 11px; font-weight: bold;">Pasif</span>
                                    {% endif %}
                                    {% if configuration.is_test_mode %}
                                    <span style="display: inline-block; padding: 3px 8px; background: #ffc107; color: #333; border-radius: 3px; font-size: 11px; font-weight: bold; margin-left: 5px;">Test Modu</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-groupbox" style="margin-bottom: 20px;">
                        <div class="groupbox-header">
                            <i class="fas fa-sync"></i> Senkronizasyon Ayarları
                        </div>
                        <div class="groupbox-body">
                            <div class="form-group">
                                <label><strong>Senkronizasyon:</strong></label>
                                <p>
                                    {% if configuration.sync_enabled %}
                                    <span style="display: inline-block; padding: 3px 8px; background: #17a2b8; color: white; border-radius: 3px; font-size: 11px; font-weight: bold;">Aktif</span>
                                    {% else %}
                                    <span style="display: inline-block; padding: 3px 8px; background: #6c757d; color: white; border-radius: 3px; font-size: 11px; font-weight: bold;">Pasif</span>
                                    {% endif %}
                                </p>
                            </div>
                            <div class="form-group">
                                <label><strong>Senkronizasyon Aralığı:</strong></label>
                                <p>{{ configuration.sync_interval }} dakika</p>
                            </div>
                            <div class="form-group">
                                <label><strong>Son Senkronizasyon:</strong></label>
                                <p>{{ configuration.last_sync_at|date:"d.m.Y H:i"|default:"-" }}</p>
                            </div>
                            <div class="form-group">
                                <label><strong>Sonraki Senkronizasyon:</strong></label>
                                <p>{{ configuration.next_sync_at|date:"d.m.Y H:i"|default:"-" }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-groupbox">
                        <div class="groupbox-header">
                            <i class="fas fa-percent"></i> Komisyon Ayarları
                        </div>
                        <div class="groupbox-body">
                            <div class="form-group">
                                <label><strong>Komisyon Oranı:</strong></label>
                                <p style="font-size: 18px; font-weight: bold; color: #2c5f8d;">{{ configuration.get_effective_commission_rate }}%</p>
                            </div>
                            <div class="form-group">
                                <label><strong>Komisyon Hesaplama:</strong></label>
                                <p>{{ configuration.get_commission_calculation_display }}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sağ Kolon -->
                <div>
                    <div class="form-groupbox" style="margin-bottom: 20px;">
                        <div class="groupbox-header">
                            <i class="fas fa-tags"></i> Fiyat Ayarları
                        </div>
                        <div class="groupbox-body">
                            <div class="form-group">
                                <label><strong>Otomatik Fiyat Senkronizasyonu:</strong></label>
                                <p>
                                    {% if configuration.auto_sync_pricing %}
                                    <span style="display: inline-block; padding: 3px 8px; background: #28a745; color: white; border-radius: 3px; font-size: 11px; font-weight: bold;">Aktif</span>
                                    {% else %}
                                    <span style="display: inline-block; padding: 3px 8px; background: #6c757d; color: white; border-radius: 3px; font-size: 11px; font-weight: bold;">Pasif</span>
                                    {% endif %}
                                </p>
                            </div>
                            <div class="form-group">
                                <label><strong>Otomatik Müsaitlik Senkronizasyonu:</strong></label>
                                <p>
                                    {% if configuration.auto_sync_availability %}
                                    <span style="display: inline-block; padding: 3px 8px; background: #28a745; color: white; border-radius: 3px; font-size: 11px; font-weight: bold;">Aktif</span>
                                    {% else %}
                                    <span style="display: inline-block; padding: 3px 8px; background: #6c757d; color: white; border-radius: 3px; font-size: 11px; font-weight: bold;">Pasif</span>
                                    {% endif %}
                                </p>
                            </div>
                            <div class="form-group">
                                <label><strong>Fiyat Artış Oranı:</strong></label>
                                <p>{{ configuration.price_markup_percent }}%</p>
                            </div>
                            <div class="form-group">
                                <label><strong>Fiyat Artış Tutarı:</strong></label>
                                <p>{{ configuration.price_markup_amount|floatformat:2 }} {{ configuration.currency|default:"TRY" }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-groupbox">
                        <div class="groupbox-header">
                            <i class="fas fa-calendar-check"></i> Rezervasyon Ayarları
                        </div>
                        <div class="groupbox-body">
                            <div class="form-group">
                                <label><strong>Otomatik Rezervasyon Onayı:</strong></label>
                                <p>
                                    {% if configuration.auto_confirm_reservations %}
                                    <span style="display: inline-block; padding: 3px 8px; background: #28a745; color: white; border-radius: 3px; font-size: 11px; font-weight: bold;">Aktif</span>
                                    {% else %}
                                    <span style="display: inline-block; padding: 3px 8px; background: #6c757d; color: white; border-radius: 3px; font-size: 11px; font-weight: bold;">Pasif</span>
                                    {% endif %}
                                </p>
                            </div>
                            <div class="form-group">
                                <label><strong>Rezervasyon Timeout:</strong></label>
                                <p>{{ configuration.reservation_timeout }} dakika</p>
                            </div>
                            <div class="form-group">
                                <label><strong>Değişikliklere İzin Ver:</strong></label>
                                <p>
                                    {% if configuration.allow_modifications %}
                                    <span style="display: inline-block; padding: 3px 8px; background: #28a745; color: white; border-radius: 3px; font-size: 11px; font-weight: bold;">Evet</span>
                                    {% else %}
                                    <span style="display: inline-block; padding: 3px 8px; background: #6c757d; color: white; border-radius: 3px; font-size: 11px; font-weight: bold;">Hayır</span>
                                    {% endif %}
                                </p>
                            </div>
                            <div class="form-group">
                                <label><strong>İptallere İzin Ver:</strong></label>
                                <p>
                                    {% if configuration.allow_cancellations %}
                                    <span style="display: inline-block; padding: 3px 8px; background: #28a745; color: white; border-radius: 3px; font-size: 11px; font-weight: bold;">Evet</span>
                                    {% else %}
                                    <span style="display: inline-block; padding: 3px 8px; background: #6c757d; color: white; border-radius: 3px; font-size: 11px; font-weight: bold;">Hayır</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Son Senkronizasyonlar -->
            {% if recent_syncs %}
            <div class="form-groupbox" style="margin-top: 20px;">
                <div class="groupbox-header">
                    <i class="fas fa-history"></i> Son Senkronizasyonlar
                    <div style="float: right;">
                        <a href="{% url 'channel_management:sync_list' configuration.pk %}" class="vb-button" style="padding: 4px 8px; font-size: 11px;">
                            <i class="fas fa-list"></i> Tümünü Gör
                        </a>
                    </div>
                </div>
                <div class="groupbox-body">
                    <div class="datagrid">
                        <div class="vb-datagrid-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Tarih</th>
                                        <th>Tip</th>
                                        <th>Yön</th>
                                        <th>Durum</th>
                                        <th>Süre</th>
                                        <th>Başarılı/Başarısız</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for sync in recent_syncs %}
                                    <tr>
                                        <td>{{ sync.created_at|date:"d.m.Y H:i" }}</td>
                                        <td>{{ sync.get_sync_type_display }}</td>
                                        <td>{{ sync.get_direction_display }}</td>
                                        <td>
                                            {% if sync.status == 'completed' %}
                                            <span style="display: inline-block; padding: 3px 8px; background: #28a745; color: white; border-radius: 3px; font-size: 11px; font-weight: bold;">Tamamlandı</span>
                                            {% elif sync.status == 'failed' %}
                                            <span style="display: inline-block; padding: 3px 8px; background: #dc3545; color: white; border-radius: 3px; font-size: 11px; font-weight: bold;">Başarısız</span>
                                            {% elif sync.status == 'running' %}
                                            <span style="display: inline-block; padding: 3px 8px; background: #17a2b8; color: white; border-radius: 3px; font-size: 11px; font-weight: bold;">Çalışıyor</span>
                                            {% else %}
                                            <span style="display: inline-block; padding: 3px 8px; background: #ffc107; color: #333; border-radius: 3px; font-size: 11px; font-weight: bold;">{{ sync.get_status_display }}</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ sync.duration_seconds|default:"-" }} sn</td>
                                        <td>{{ sync.successful_items }} / {{ sync.failed_items }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Son Rezervasyonlar -->
            {% if recent_reservations %}
            <div class="form-groupbox" style="margin-top: 20px;">
                <div class="groupbox-header">
                    <i class="fas fa-calendar-check"></i> Son Rezervasyonlar
                    <div style="float: right;">
                        <a href="{% url 'channel_management:reservation_list' %}?configuration={{ configuration.pk }}" class="vb-button" style="padding: 4px 8px; font-size: 11px;">
                            <i class="fas fa-list"></i> Tümünü Gör
                        </a>
                    </div>
                </div>
                <div class="groupbox-body">
                    <div class="datagrid">
                        <div class="vb-datagrid-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Rezervasyon Kodu</th>
                                        <th>Misafir</th>
                                        <th>Check-in</th>
                                        <th>Check-out</th>
                                        <th>Tutar</th>
                                        <th>Durum</th>
                                        <th>İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for reservation in recent_reservations %}
                                    <tr>
                                        <td><strong>{{ reservation.channel_reservation_code|default:reservation.channel_reservation_id }}</strong></td>
                                        <td>{{ reservation.guest_name }}</td>
                                        <td>{{ reservation.check_in_date|date:"d.m.Y" }}</td>
                                        <td>{{ reservation.check_out_date|date:"d.m.Y" }}</td>
                                        <td><strong>{{ reservation.total_amount|floatformat:2 }} {{ reservation.currency }}</strong></td>
                                        <td>
                                            {% if reservation.status == 'confirmed' %}
                                            <span style="display: inline-block; padding: 3px 8px; background: #28a745; color: white; border-radius: 3px; font-size: 11px; font-weight: bold;">Onaylandı</span>
                                            {% elif reservation.status == 'pending' %}
                                            <span style="display: inline-block; padding: 3px 8px; background: #ffc107; color: #333; border-radius: 3px; font-size: 11px; font-weight: bold;">Beklemede</span>
                                            {% else %}
                                            <span style="display: inline-block; padding: 3px 8px; background: #6c757d; color: white; border-radius: 3px; font-size: 11px; font-weight: bold;">{{ reservation.get_status_display }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <a href="{% url 'channel_management:reservation_detail' reservation.pk %}" class="vb-button" style="padding: 4px 8px; font-size: 11px;">
                                                <i class="fas fa-eye"></i> Detay
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function triggerSync(configId) {
    if (confirm('Senkronizasyonu başlatmak istediğinizden emin misiniz?')) {
        fetch(`/channel-management/configurations/${configId}/sync/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Senkronizasyon başlatıldı.');
                location.reload();
            } else {
                alert('Hata: ' + data.error);
            }
        })
        .catch(error => {
            alert('Senkronizasyon başlatılırken hata oluştu.');
        });
    }
}
</script>
{% endblock %}





