{% extends "tenant/base.html" %}
{% load static %}

{% block title %}Bungalov Rezervasyon Detayı - {{ reservation.reservation_code }}{% endblock %}

{% block content %}
<div class="content-body">
    <div class="groupbox">
        <div class="groupbox-header">
            <i class="fas fa-calendar-check"></i> Bungalov Rezervasyon Detayı: {{ reservation.reservation_code }}
            <div style="float: right;">
                {% if not reservation.is_deleted %}
                <a href="{% url 'bungalovs:reservation_update' reservation.pk %}" class="vb-button primary">
                    <i class="fas fa-edit"></i> Düzenle
                </a>
                {% if reservation.can_check_in %}
                <a href="{% url 'bungalovs:reservation_checkin' reservation.pk %}" class="vb-button success">
                    <i class="fas fa-sign-in-alt"></i> Check-in
                </a>
                {% endif %}
                {% if reservation.can_check_out %}
                <a href="{% url 'bungalovs:reservation_checkout' reservation.pk %}" class="vb-button warning">
                    <i class="fas fa-sign-out-alt"></i> Check-out
                </a>
                {% endif %}
                <button onclick="openDeleteReservationModal({{ reservation.pk }})" class="vb-button danger" style="background: #dc3545; color: white; border-color: #dc3545;">
                    <i class="fas fa-trash"></i> Sil
                </button>
                {% endif %}
                <a href="{% url 'bungalovs:reservation_list' %}" class="vb-button">
                    <i class="fas fa-arrow-left"></i> Geri
                </a>
            </div>
        </div>
        <div class="groupbox-body">
            <!-- Rezervasyon Bilgileri -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                <div class="form-groupbox">
                    <div class="groupbox-header">
                        <i class="fas fa-info-circle"></i> Temel Bilgiler
                    </div>
                    <div class="groupbox-body">
                        <div class="voucher-row">
                            <span class="voucher-label">Rezervasyon Kodu:</span>
                            <span class="voucher-value">{{ reservation.reservation_code }}</span>
                        </div>
                        <div class="voucher-row">
                            <span class="voucher-label">Durum:</span>
                            <span class="voucher-value">
                                <span class="badge badge-{% if reservation.status == 'checked_in' %}success{% elif reservation.status == 'confirmed' %}info{% elif reservation.status == 'cancelled' %}danger{% else %}warning{% endif %}">
                                    {{ reservation.get_status_display }}
                                </span>
                            </span>
                        </div>
                        <div class="voucher-row">
                            <span class="voucher-label">Kaynak:</span>
                            <span class="voucher-value">{{ reservation.get_source_display }}</span>
                        </div>
                        <div class="voucher-row">
                            <span class="voucher-label">Bungalov:</span>
                            <span class="voucher-value">{{ reservation.bungalov.code }} - {{ reservation.bungalov.name }}</span>
                        </div>
                        <div class="voucher-row">
                            <span class="voucher-label">Bungalov Tipi:</span>
                            <span class="voucher-value">{{ reservation.bungalov.bungalov_type.name }}</span>
                        </div>
                        <div class="voucher-row">
                            <span class="voucher-label">Oluşturulma:</span>
                            <span class="voucher-value">{{ reservation.created_at|date:"d.m.Y H:i" }}</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-groupbox">
                    <div class="groupbox-header">
                        <i class="fas fa-calendar"></i> Tarih Bilgileri
                    </div>
                    <div class="groupbox-body">
                        <div class="voucher-row">
                            <span class="voucher-label">Check-in:</span>
                            <span class="voucher-value">{{ reservation.check_in_date|date:"d.m.Y" }} {{ reservation.check_in_time|time:"H:i"|default:"" }}</span>
                        </div>
                        <div class="voucher-row">
                            <span class="voucher-label">Check-out:</span>
                            <span class="voucher-value">{{ reservation.check_out_date|date:"d.m.Y" }} {{ reservation.check_out_time|time:"H:i"|default:"" }}</span>
                        </div>
                        <div class="voucher-row">
                            <span class="voucher-label">Geceleme:</span>
                            <span class="voucher-value">{{ reservation.total_nights }} gece</span>
                        </div>
                        <div class="voucher-row">
                            <span class="voucher-label">Yetişkin:</span>
                            <span class="voucher-value">{{ reservation.adult_count }} kişi</span>
                        </div>
                        <div class="voucher-row">
                            <span class="voucher-label">Çocuk:</span>
                            <span class="voucher-value">{{ reservation.child_count }} kişi</span>
                        </div>
                        <div class="voucher-row">
                            <span class="voucher-label">Bebek:</span>
                            <span class="voucher-value">{{ reservation.infant_count }} kişi</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-groupbox">
                    <div class="groupbox-header">
                        <i class="fas fa-lira-sign"></i> Fiyat Bilgileri
                    </div>
                    <div class="groupbox-body">
                        <div class="voucher-row">
                            <span class="voucher-label">Gecelik Fiyat:</span>
                            <span class="voucher-value">{{ reservation.nightly_rate|floatformat:2 }} {{ reservation.currency }}</span>
                        </div>
                        {% if reservation.weekly_rate %}
                        <div class="voucher-row">
                            <span class="voucher-label">Haftalık Fiyat:</span>
                            <span class="voucher-value">{{ reservation.weekly_rate|floatformat:2 }} {{ reservation.currency }}</span>
                        </div>
                        {% endif %}
                        {% if reservation.monthly_rate %}
                        <div class="voucher-row">
                            <span class="voucher-label">Aylık Fiyat:</span>
                            <span class="voucher-value">{{ reservation.monthly_rate|floatformat:2 }} {{ reservation.currency }}</span>
                        </div>
                        {% endif %}
                        <div class="voucher-row">
                            <span class="voucher-label">Toplam Tutar:</span>
                            <span class="voucher-value" style="font-weight: bold; font-size: 16px;">{{ reservation.total_amount|floatformat:2 }} {{ reservation.currency }}</span>
                        </div>
                        {% if reservation.discount_amount > 0 %}
                        <div class="voucher-row">
                            <span class="voucher-label">İndirim:</span>
                            <span class="voucher-value" style="color: green;">-{{ reservation.discount_amount|floatformat:2 }} {{ reservation.currency }}</span>
                        </div>
                        {% endif %}
                        {% if reservation.cleaning_fee > 0 %}
                        <div class="voucher-row">
                            <span class="voucher-label">Temizlik Ücreti:</span>
                            <span class="voucher-value">{{ reservation.cleaning_fee|floatformat:2 }} {{ reservation.currency }}</span>
                        </div>
                        {% endif %}
                        <div class="voucher-row">
                            <span class="voucher-label">Ödenen:</span>
                            <span class="voucher-value">{{ total_paid|floatformat:2 }} {{ reservation.currency }}</span>
                        </div>
                        <div class="voucher-row">
                            <span class="voucher-label">Kalan:</span>
                            <span class="voucher-value" style="color: {% if reservation.get_remaining_amount > 0 %}red{% else %}green{% endif %}; font-weight: bold;">
                                {{ reservation.get_remaining_amount|floatformat:2 }} {{ reservation.currency }}
                            </span>
                        </div>
                        <div class="voucher-row">
                            <span class="voucher-label">Ödeme Durumu:</span>
                            <span class="voucher-value">
                                {% if reservation.is_paid %}
                                    <span style="color: green;"><i class="fas fa-check-circle"></i> Tamamlandı</span>
                                {% else %}
                                    <span style="color: orange;"><i class="fas fa-exclamation-triangle"></i> Kısmi/Kalan</span>
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Müşteri Bilgileri -->
            {% if reservation.customer %}
            <div class="form-groupbox" style="margin-bottom: 20px;">
                <div class="groupbox-header">
                    <i class="fas fa-user"></i> Müşteri Bilgileri
                </div>
                <div class="groupbox-body">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <div>
                            <strong>Ad Soyad:</strong><br>
                            {{ reservation.customer.first_name }} {{ reservation.customer.last_name }}
                        </div>
                        <div>
                            <strong>E-posta:</strong><br>
                            {{ reservation.customer.email|default:"-" }}
                        </div>
                        <div>
                            <strong>Telefon:</strong><br>
                            {{ reservation.customer.phone|default:"-" }}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Misafirler -->
            {% if guests %}
            <div class="form-groupbox" style="margin-bottom: 20px;">
                <div class="groupbox-header">
                    <i class="fas fa-users"></i> Misafir Bilgileri ({{ guests|length }})
                </div>
                <div class="groupbox-body">
                    <table class="vb-datagrid">
                        <thead>
                            <tr>
                                <th>Sıra</th>
                                <th>Ad Soyad</th>
                                <th>Tip</th>
                                <th>Yaş</th>
                                <th>Cinsiyet</th>
                                <th>TC/Pasaport</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for guest in guests %}
                            <tr>
                                <td>{{ guest.guest_order }}</td>
                                <td>{{ guest.first_name }} {{ guest.last_name }}</td>
                                <td>{{ guest.get_guest_type_display }}</td>
                                <td>{{ guest.age|default:"-" }}</td>
                                <td>{{ guest.get_gender_display|default:"-" }}</td>
                                <td>{{ guest.tc_no|default:guest.passport_no|default:"-" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
            
            <!-- Ödemeler -->
            {% if payments %}
            <div class="form-groupbox" style="margin-bottom: 20px;">
                <div class="groupbox-header">
                    <i class="fas fa-money-bill-wave"></i> Ödeme Geçmişi ({{ payments|length }})
                </div>
                <div class="groupbox-body">
                    <table class="vb-datagrid">
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>Tutar</th>
                                <th>Yöntem</th>
                                <th>Tip</th>
                                <th>Referans</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in payments %}
                            <tr>
                                <td>{{ payment.payment_date|date:"d.m.Y" }}</td>
                                <td><strong>{{ payment.payment_amount|floatformat:2 }} {{ payment.currency }}</strong></td>
                                <td>{{ payment.get_payment_method_display }}</td>
                                <td>{{ payment.get_payment_type_display }}</td>
                                <td>{{ payment.payment_reference|default:"-" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
            
            <!-- Özel İstekler ve Notlar -->
            {% if reservation.special_requests or reservation.internal_notes %}
            <div class="form-groupbox">
                <div class="groupbox-header">
                    <i class="fas fa-sticky-note"></i> Notlar
                </div>
                <div class="groupbox-body">
                    {% if reservation.special_requests %}
                    <div style="margin-bottom: 15px;">
                        <strong>Özel İstekler:</strong><br>
                        <div style="padding: 10px; background: #f8f9fa; border-radius: 3px; margin-top: 5px;">
                            {{ reservation.special_requests|linebreaks }}
                        </div>
                    </div>
                    {% endif %}
                    {% if reservation.internal_notes %}
                    <div>
                        <strong>İç Notlar:</strong><br>
                        <div style="padding: 10px; background: #fff3cd; border-radius: 3px; margin-top: 5px;">
                            {{ reservation.internal_notes|linebreaks }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Silme Modal -->
<div id="deleteReservationModal" class="vb-modal" style="display: none;">
    <div class="vb-modal-overlay" onclick="closeDeleteReservationModal()"></div>
    <div class="vb-modal-content" style="max-width: 600px;">
        <div class="vb-modal-header">
            <h3 class="vb-modal-title">Rezervasyon Sil</h3>
            <button type="button" class="vb-modal-close" onclick="closeDeleteReservationModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="vb-modal-body">
            {% if delete_check.has_payment and not delete_check.can_delete %}
            <div style="padding: 15px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 3px; margin-bottom: 15px;">
                <i class="fas fa-exclamation-triangle" style="color: #856404;"></i>
                <strong>Uyarı:</strong> Bu rezervasyon için {{ delete_check.total_paid|floatformat:2 }} {{ reservation.currency }} ödeme alınmış.
                <br><br>
                {{ delete_check.message }}
                {% if delete_check.refund_request %}
                <br><br>
                <a href="{% url 'refunds:refund_request_detail' delete_check.refund_request_id %}" class="vb-button small">
                    İade Talebini Görüntüle
                </a>
                {% elif delete_check.can_start_refund %}
                <br><br>
                <form method="post" action="{% url 'bungalovs:reservation_delete' reservation.pk %}" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="start_refund" value="1">
                    <button type="submit" class="vb-button small primary">
                        İade Sürecini Başlat
                    </button>
                </form>
                {% endif %}
            </div>
            {% endif %}
            
            <p>Bu rezervasyonu silmek istediğinizden emin misiniz?</p>
            <p><strong>Rezervasyon Kodu:</strong> {{ reservation.reservation_code }}</p>
            <p><strong>Müşteri:</strong> {{ reservation.customer.first_name }} {{ reservation.customer.last_name }}</p>
            <p><strong>Bungalov:</strong> {{ reservation.bungalov.code }} - {{ reservation.bungalov.name }}</p>
            
            <form method="post" action="{% url 'bungalovs:reservation_delete' reservation.pk %}" id="deleteReservationForm">
                {% csrf_token %}
                <div style="margin-top: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                        Onay için rezervasyon kodunu girin:
                    </label>
                    <input type="text" name="confirm_code" placeholder="{{ reservation.reservation_code }}" 
                           style="padding: 8px; border: 1px solid #ced4da; border-radius: 3px; width: 100%;" required>
                </div>
            </form>
        </div>
        <div class="vb-modal-footer">
            <button type="button" class="vb-button" onclick="closeDeleteReservationModal()">İptal</button>
            <button type="submit" form="deleteReservationForm" class="vb-button danger" style="background: #dc3545; color: white;">
                <i class="fas fa-trash"></i> Sil
            </button>
        </div>
    </div>
</div>

<script>
function openDeleteReservationModal(reservationId) {
    document.getElementById('deleteReservationModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeDeleteReservationModal() {
    document.getElementById('deleteReservationModal').style.display = 'none';
    document.body.style.overflow = '';
}
</script>
{% endblock %}

