services:
  # PostgreSQL Database (Multi-tenancy için gerekli)
  db:
    image: postgres:15-alpine
    container_name: saas2026_db
    environment:
      POSTGRES_DB: saas_db
      POSTGRES_USER: saas_user
      POSTGRES_PASSWORD: saas_password_2026
      POSTGRES_HOST_AUTH_METHOD: trust
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - saas_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U saas_user -d saas_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis (Cache & Celery broker)
  redis:
    image: redis:7-alpine
    container_name: saas2026_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - saas_network
    restart: unless-stopped
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Django Web Application
  web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: saas2026_web
    command: >
      sh -c "
      python manage.py wait_for_db &&
      python manage.py migrate_schemas --shared &&
      python manage.py migrate_schemas &&
      python manage.py collectstatic --noinput &&
      gunicorn config.wsgi:application --bind 0.0.0.0:8000 --workers 4 --timeout 120
      "
    volumes:
      - .:/app
      - static_volume:/app/staticfiles
      - media_volume:/app/media
    ports:
      - "8000:8000"
    environment:
      - DEBUG=True
      - SECRET_KEY=django-insecure-development-key-change-in-production
      - DATABASE_URL=postgresql://saas_user:saas_password_2026@db:5432/saas_db
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - ALLOWED_HOSTS=localhost,127.0.0.1,0.0.0.0
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - saas_network
    restart: unless-stopped

  # Celery Worker (Arka plan işleri)
  celery:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: saas2026_celery
    command: celery -A config worker -l info --concurrency=2
    volumes:
      - .:/app
    environment:
      - DEBUG=True
      - SECRET_KEY=django-insecure-development-key-change-in-production
      - DATABASE_URL=postgresql://saas_user:saas_password_2026@db:5432/saas_db
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    depends_on:
      - db
      - redis
      - web
    networks:
      - saas_network
    restart: unless-stopped

  # Celery Beat (Zamanlanmış görevler - Abonelik takibi)
  celery-beat:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: saas2026_celery_beat
    command: celery -A config beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
    volumes:
      - .:/app
    environment:
      - DEBUG=True
      - SECRET_KEY=django-insecure-development-key-change-in-production
      - DATABASE_URL=postgresql://saas_user:saas_password_2026@db:5432/saas_db
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    depends_on:
      - db
      - redis
      - web
    networks:
      - saas_network
    restart: unless-stopped

  # Nginx (Reverse Proxy & Static Files)
  nginx:
    image: nginx:alpine
    container_name: saas2026_nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - static_volume:/app/staticfiles:ro
      - media_volume:/app/media:ro
    depends_on:
      - web
    networks:
      - saas_network
    restart: unless-stopped
    command: >
      sh -c "
      cat > /etc/nginx/nginx.conf << 'EOF'
      user nginx;
      worker_processes auto;
      error_log /var/log/nginx/error.log warn;
      pid /var/run/nginx.pid;

      events {
          worker_connections 1024;
      }

      http {
          include /etc/nginx/mime.types;
          default_type application/octet-stream;

          log_format main '$$remote_addr - $$remote_user [$$time_local] \"$$request\" '
                          '$$status $$body_bytes_sent \"$$http_referer\" '
                          '\"$$http_user_agent\" \"$$http_x_forwarded_for\"';

          access_log /var/log/nginx/access.log main;

          sendfile on;
          tcp_nopush on;
          tcp_nodelay on;
          keepalive_timeout 65;
          types_hash_max_size 2048;

          gzip on;
          gzip_vary on;
          gzip_proxied any;
          gzip_comp_level 6;
          gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;

          upstream django {
              server web:8000;
          }

          server {
              listen 80;
              server_name _;
              client_max_body_size 50M;

              add_header X-Frame-Options \"SAMEORIGIN\" always;
              add_header X-Content-Type-Options \"nosniff\" always;
              add_header X-XSS-Protection \"1; mode=block\" always;

              location /static/ {
                  alias /app/staticfiles/;
                  expires 30d;
                  add_header Cache-Control \"public, immutable\";
              }

              location /media/ {
                  alias /app/media/;
                  expires 7d;
              }

              location / {
                  proxy_pass http://django;
                  proxy_set_header Host $$host;
                  proxy_set_header X-Real-IP $$remote_addr;
                  proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $$scheme;
                  proxy_redirect off;
                  proxy_connect_timeout 60s;
                  proxy_send_timeout 60s;
                  proxy_read_timeout 60s;
              }

              location /health/ {
                  access_log off;
                  return 200 \"OK\";
                  add_header Content-Type text/plain;
              }
          }
      }
      EOF
      nginx -g 'daemon off;'
      "

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  static_volume:
    driver: local
  media_volume:
    driver: local

networks:
  saas_network:
    driver: bridge



