{% extends "tenant/base.html" %}
{% load static %}

{% block title %}{% if room %}Oda Düzenle{% else %}Yeni Oda Ekle{% endif %} - Kiracı Üye Paneli{% endblock %}
{% block page_title %}{% if room %}Oda Düzenle{% else %}Yeni Oda Ekle{% endif %}{% endblock %}

{% block content %}
<div class="p-6">
    <!-- Geri Dön Butonu -->
    <div class="mb-4">
        <a href="{% url 'hotels:room_list' %}" class="text-vb-primary hover:text-blue-600">
            <i class="fas fa-arrow-left mr-2"></i>
            Oda Listesine Dön
        </a>
    </div>
    
    <!-- Oda Formu -->
    <div class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm">
        <h2 class="text-2xl font-bold text-vb-navy mb-6">
            <i class="fas fa-{% if room %}edit{% else %}plus{% endif %} mr-2 text-vb-primary"></i>
            {% if room %}Oda Düzenle{% else %}Yeni Oda Ekle{% endif %}
            {% if hotel %}<span class="text-sm font-normal text-gray-600 ml-2">- {{ hotel.name }}</span>{% endif %}
        </h2>
        
        <form method="post" enctype="multipart/form-data" class="space-y-6">
            {% csrf_token %}
            
            <!-- Temel Bilgiler -->
            <div class="border-b border-gray-200 pb-6">
<h3 class="vb-section-title text-gray-900 mb-4">Temel Bilgiler</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Oda Adı *</label>
                        {{ form.name }}
                        {% if form.name.errors %}
                        <p class="text-red-600 text-xs mt-1">{{ form.name.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Oda Kodu *</label>
                        {{ form.code }}
                        {% if form.code.errors %}
                        <p class="text-red-600 text-xs mt-1">{{ form.code.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Oda Tipi</label>
                        {{ form.room_type }}
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Pansiyon Tipi</label>
                        {{ form.board_type }}
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Oda Sayısı</label>
                        {{ form.room_count }}
                        <p class="text-xs text-gray-500 mt-1">Bu tip odadan kaç tane var</p>
                    </div>
                </div>
            </div>
            
            <!-- Kapasite -->
            <div class="border-b border-gray-200 pb-6">
<h3 class="vb-section-title text-gray-900 mb-4">Kapasite</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Maksimum Yetişkin</label>
                        {{ form.max_adults }}
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Maksimum Çocuk</label>
                        {{ form.max_children }}
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Maksimum Toplam Kapasite</label>
                        {{ form.max_total_capacity }}
                    </div>
                </div>
            </div>
            
            <!-- Oda Özellikleri -->
            <div class="border-b border-gray-200 pb-6">
<h3 class="vb-section-title text-gray-900 mb-4">Oda Özellikleri</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Oda Özellikleri</label>
                        {{ form.room_features }}
                        <p class="text-xs text-gray-500 mt-1">Ctrl tuşu ile birden fazla seçim yapabilirsiniz</p>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Metrekare</label>
                        {{ form.area_sqm }}
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Yatak Tipi</label>
                        {{ form.bed_type }}
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Yatak Sayısı</label>
                        {{ form.bed_count }}
                    </div>
                </div>
            </div>
            
            <!-- Görsel İçerik -->
            <div class="border-b border-gray-200 pb-6">
<h3 class="vb-section-title text-gray-900 mb-4">Görsel İçerik</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Ana Sayfa Resmi</label>
                        {{ form.main_image }}
                        {% if room and room.main_image %}
                        <div class="mt-2">
                            <img src="{{ room.main_image.url }}" alt="{{ room.name }}" class="w-32 h-32 object-cover rounded-lg">
                        </div>
                        {% endif %}
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Video URL (YouTube)</label>
                        {{ form.video_url }}
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Video Dosyası</label>
                        {{ form.video_file }}
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">3D Virtual Tour URL</label>
                        {{ form.virtual_3d_url }}
                    </div>
                </div>
            </div>
            
            <!-- Galeri -->
            {% if room %}
            <div class="border-b border-gray-200 pb-6">
<h3 class="vb-section-title text-gray-900 mb-4">Oda Galerisi</h3>
                <div id="room-gallery-container" data-room-id="{{ room.pk }}">
                    <!-- Drag & Drop Zone -->
                    <div id="room-gallery-dropzone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-4 hover:border-vb-primary transition-colors cursor-pointer">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600 font-semibold mb-1">Resimleri buraya sürükleyip bırakın</p>
                        <p class="text-gray-500 text-sm mb-3">veya</p>
                        <label for="room-gallery-upload" class="inline-block px-4 py-2 bg-vb-primary text-white rounded-lg hover:bg-blue-600 transition-colors cursor-pointer">
                            <i class="fas fa-folder-open mr-2"></i>
                            Dosya Seç
                        </label>
                        <input type="file" id="room-gallery-upload" multiple accept="image/*" class="hidden">
                        <p class="text-xs text-gray-400 mt-2">JPG, PNG, GIF formatları desteklenir (Maksimum 10MB)</p>
                    </div>
                    
                    <!-- Galeri Grid -->
                    <div id="room-gallery-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                        {% for image in gallery_images %}
                        <div class="gallery-item relative group" data-image-id="{{ image.pk }}">
                            <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden border-2 border-gray-200">
                                <img src="{{ image.image.url }}" alt="{{ image.title|default:image.image.name }}" class="w-full h-full object-cover">
                            </div>
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 transition-all rounded-lg flex items-center justify-center opacity-0 group-hover:opacity-100">
                                <div class="flex space-x-2">
                                    <button type="button" class="gallery-edit-btn px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700" data-image-id="{{ image.pk }}" title="Düzenle">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="gallery-delete-btn px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700" data-image-id="{{ image.pk }}" title="Sil">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="absolute top-1 left-1 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded cursor-move" title="Sürükle">
                                <i class="fas fa-grip-vertical"></i>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Upload Progress -->
                    <div id="room-gallery-progress" class="hidden mt-4">
                        <div class="bg-gray-200 rounded-full h-2">
                            <div id="room-gallery-progress-bar" class="bg-vb-primary h-2 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                        <p id="room-gallery-progress-text" class="text-sm text-gray-600 mt-2 text-center"></p>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Detay -->
            <div class="border-b border-gray-200 pb-6">
<h3 class="vb-section-title text-gray-900 mb-4">Detay</h3>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Detay Açıklama</label>
                    {{ form.description }}
                </div>
            </div>
            
            <!-- Durum -->
            <div class="pb-6">
<h3 class="vb-section-title text-gray-900 mb-4">Durum</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="flex items-center">
                        {{ form.is_active }}
                        <label class="ml-2 text-sm font-semibold text-gray-700">Aktif mi?</label>
                    </div>
                    <div class="flex items-center">
                        {{ form.is_featured }}
                        <label class="ml-2 text-sm font-semibold text-gray-700">Öne Çıkan mı?</label>
                    </div>
                    <div class="flex items-center">
                        {{ form.is_homepage_visible }}
                        <label class="ml-2 text-sm font-semibold text-gray-700">Anasayfada Görünür mü?</label>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Sıralama</label>
                        {{ form.sort_order }}
                    </div>
                </div>
            </div>
            
            <!-- Butonlar -->
            <div class="flex justify-end space-x-3 pt-4">
                <a href="{% url 'hotels:room_list' %}" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors font-semibold">
                    İptal
                </a>
                <button type="submit" class="px-6 py-2 bg-vb-primary text-white rounded-lg hover:bg-blue-600 transition-colors font-semibold">
                    <i class="fas fa-save mr-2"></i>
                    {% if room %}Güncelle{% else %}Kaydet{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extrajs %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script src="{% static 'js/gallery_manager.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    {% if room %}
    // Oda galeri yönetimi
    const roomGallery = new GalleryManager({
        containerId: 'room-gallery-container',
        dropzoneId: 'room-gallery-dropzone',
        uploadInputId: 'room-gallery-upload',
        gridId: 'room-gallery-grid',
        progressId: 'room-gallery-progress',
        progressBarId: 'room-gallery-progress-bar',
        progressTextId: 'room-gallery-progress-text',
        uploadUrl: '{% url "hotels:api_room_image_upload" room.pk %}',
        deleteUrl: '{% url "hotels:api_room_image_delete" 0 %}'.replace('0', ''),
        updateUrl: '{% url "hotels:api_room_image_update" 0 %}'.replace('0', ''),
        reorderUrl: '{% url "hotels:api_room_images_reorder" %}',
        csrfToken: '{{ csrf_token }}',
        type: 'room'
    });
    roomGallery.init();
    {% endif %}
});
</script>
{% endblock %}

{% block extrastyle %}
<link rel="stylesheet" href="{% static 'css/gallery_manager.css' %}">
<style>
    .form-control {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        background-color: #ffffff;
        color: #1f2937;
        font-size: 0.875rem;
    }
    .form-control:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    textarea.form-control {
        resize: vertical;
    }
</style>
{% endblock %}

