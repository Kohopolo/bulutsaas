{% extends "tenant/base.html" %}
{% load static %}
{% load dict_filters %}

{% block title %}Oda Durumu - {{ hotel.name }}{% endblock %}

{% block content %}
<div class="content-body">
    <div class="groupbox">
        <div class="groupbox-header">
            <i class="fas fa-list"></i> Oda Durumu - {{ hotel.name }}
            <div style="float: right;">
                <a href="{% url 'reception:room_plan' %}" class="vb-button">
                    <i class="fas fa-building"></i> Oda Planı
                </a>
                <a href="{% url 'reception:dashboard' %}" class="vb-button">
                    <i class="fas fa-arrow-left"></i> Dashboard
                </a>
            </div>
        </div>
        <div class="groupbox-body">
            <!-- Filtreler -->
            <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border: 1px solid #d4d4d4; border-radius: 3px;">
                <form method="get" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <select name="status" style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 3px;">
                        <option value="">Tüm Durumlar</option>
                        {% for value, label in status_choices %}
                        <option value="{{ value }}" {% if current_status == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                    <select name="floor" style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 3px;">
                        <option value="">Tüm Katlar</option>
                        {% for floor in floors %}
                        <option value="{{ floor.id }}" {% if current_floor == floor.id|stringformat:"s" %}selected{% endif %}>{{ floor.name }}</option>
                        {% endfor %}
                    </select>
                    <select name="room_type" style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 3px;">
                        <option value="">Tüm Oda Tipleri</option>
                        {% for room_type in room_types %}
                        <option value="{{ room_type.id }}" {% if current_room_type == room_type.id|stringformat:"s" %}selected{% endif %}>{{ room_type.name }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="vb-button primary">Filtrele</button>
                    <a href="{% url 'reception:room_status' %}" class="vb-button">Temizle</a>
                </form>
            </div>
            
            <!-- Durum İstatistikleri -->
            {% if status_counts %}
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
                {% for status_count in status_counts %}
                <div style="background: #f8f9fa; padding: 10px; border: 1px solid #d4d4d4; border-radius: 3px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #2c5f8d;">{{ status_count.count }}</div>
                    <div style="font-size: 12px; color: #666;">
                        {% for value, label in status_choices %}
                            {% if value == status_count.status %}{{ label }}{% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Oda Listesi -->
            <div class="datagrid">
                <div class="vb-datagrid-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Oda No</th>
                                <th>Oda Tipi</th>
                                <th>Kat</th>
                                <th>Blok</th>
                                <th>Durum</th>
                                <th>Rezervasyon</th>
                                <th>Müşteri</th>
                                <th>Notlar</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for room_number in room_numbers %}
                            {% with reservation=room_reservations|get_item:room_number.id %}
                            <tr>
                                <td><strong>{{ room_number.number }}</strong></td>
                                <td>{% if room_number.room %}{{ room_number.room.name }}{% else %}Oda Tipi Yok{% endif %}</td>
                                <td>{% if room_number.floor %}{{ room_number.floor.name }}{% else %}-{% endif %}</td>
                                <td>{% if room_number.block %}{{ room_number.block.name }}{% else %}-{% endif %}</td>
                                <td>
                                    <span class="badge badge-{{ room_number.status }}">
                                        {{ room_number.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    {% if reservation %}
                                        <a href="{% url 'reception:reservation_detail' reservation.pk %}">
                                            {{ reservation.reservation_code }}
                                        </a>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if reservation %}
                                        {{ reservation.customer.get_full_name }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>{{ room_number.notes|truncatewords:5|default:"-" }}</td>
                                <td>
                                    <select onchange="updateRoomStatus({{ room_number.id }}, this.value)" 
                                            class="vb-select small"
                                            data-room-id="{{ room_number.id }}"
                                            id="status-select-{{ room_number.id }}">
                                        {% for value, label in status_choices %}
                                        <option value="{{ value }}" {% if room_number.status == value %}selected{% endif %}>{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                            </tr>
                            {% endwith %}
                            {% empty %}
                            <tr>
                                <td colspan="9" style="text-align: center; padding: 40px; color: #999;">
                                    <i class="fas fa-inbox" style="font-size: 32px; display: block; margin-bottom: 10px;"></i>
                                    Filtre kriterlerine uygun oda bulunamadı.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function updateRoomStatus(roomNumberId, newStatus) {
    // CSRF token'ı al
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                      document.querySelector('input[name="csrfmiddlewaretoken"]')?.value ||
                      getCookie('csrftoken');
    
    if (!csrfToken) {
        alert('CSRF token bulunamadı. Sayfayı yenileyin.');
        return;
    }
    
    // Select elementini bul (reload için)
    const selectElement = event?.target || document.querySelector(`select[onchange*="${roomNumberId}"]`);
    const oldValue = selectElement?.value;
    
    // Loading göster
    if (selectElement) {
        selectElement.disabled = true;
        selectElement.style.opacity = '0.5';
    }
    
    fetch('/reception/api/room-status-update/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin',
        body: JSON.stringify({
            room_number_id: roomNumberId,
            status: newStatus
        })
    })
    .then(response => {
        // Response tipini kontrol et
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            return response.text().then(text => {
                console.error('JSON olmayan response:', text);
                throw new Error('Sunucudan JSON yanıt alınamadı. HTML yanıt alındı.');
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Başarılı - sayfayı yenile
            location.reload();
        } else {
            // Hata - select'i eski değere döndür
            if (selectElement) {
                selectElement.value = oldValue;
                selectElement.disabled = false;
                selectElement.style.opacity = '1';
            }
            alert('Hata: ' + (data.error || 'Bilinmeyen hata'));
        }
    })
    .catch(error => {
        console.error('Oda durumu güncelleme hatası:', error);
        // Select'i eski değere döndür
        if (selectElement) {
            selectElement.value = oldValue;
            selectElement.disabled = false;
            selectElement.style.opacity = '1';
        }
        alert('Oda durumu güncellenirken bir hata oluştu: ' + error.message);
    });
}

// CSRF token cookie'den alma fonksiyonu
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
