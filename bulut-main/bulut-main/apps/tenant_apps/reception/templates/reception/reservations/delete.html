{% extends "tenant/base.html" %}
{% load static %}

{% block title %}Rezervasyon Sil{% endblock %}

{% block content %}
<!-- Silme Modalı (İki Aşamalı) -->
<div id="deleteReservationModal" class="vb-modal" style="display: none;">
    <div class="vb-modal-overlay" onclick="closeDeleteModal()"></div>
    <div class="vb-modal-content" style="max-width: 500px;">
        <div class="vb-modal-header">
            <h3 class="vb-modal-title">
                <i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i> Rezervasyon Sil
            </h3>
            <button type="button" class="vb-modal-close" onclick="closeDeleteModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="vb-modal-body">
            <!-- İlk Aşama -->
            <div id="deleteStep1">
                <div style="text-align: center; margin-bottom: 20px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 64px; color: #dc3545; margin-bottom: 20px;"></i>
                    <h3 style="color: #dc3545; margin-bottom: 15px;">Dikkat!</h3>
                    <p style="font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
                        Bu rezervasyonu silmek istediğinizden <strong>emin misiniz?</strong>
                    </p>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 5px; border-left: 4px solid #ffc107; margin-bottom: 20px; text-align: left;">
                        <strong>Rezervasyon Bilgileri:</strong><br>
                        <strong>Kod:</strong> {{ reservation.reservation_code }}<br>
                        <strong>Müşteri:</strong> {{ reservation.customer.first_name }} {{ reservation.customer.last_name }}<br>
                        <strong>Oda:</strong> {{ reservation.room.name }}{% if reservation.room_number %} - {{ reservation.room_number.number }}{% endif %}<br>
                        <strong>Tarih:</strong> {{ reservation.check_in_date|date:"d.m.Y" }} - {{ reservation.check_out_date|date:"d.m.Y" }}
                    </div>
                    <p style="color: #666; font-size: 14px;">
                        <i class="fas fa-info-circle"></i> Rezervasyon silinecek ve arşive eklenecektir. Bu işlem geri alınamaz.
                    </p>
                </div>
                <div style="text-align: center; margin-top: 25px;">
                    <button onclick="proceedToDeleteStep2()" class="vb-button danger" style="padding: 12px 30px; font-size: 16px;">
                        <i class="fas fa-check"></i> Evet, Devam Et
                    </button>
                    <button onclick="closeDeleteModal()" class="vb-button" style="padding: 12px 30px; font-size: 16px; margin-left: 10px;">
                        <i class="fas fa-times"></i> İptal
                    </button>
                </div>
            </div>
            
            <!-- İkinci Aşama -->
            <div id="deleteStep2" style="display: none;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <i class="fas fa-shield-alt" style="font-size: 64px; color: #dc3545; margin-bottom: 20px;"></i>
                    <h3 style="color: #dc3545; margin-bottom: 15px;">Son Onay</h3>
                    <p style="font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
                        Silme işlemini tamamlamak için aşağıdaki bilgileri girin:
                    </p>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 5px; margin-bottom: 20px; text-align: left;">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">
                                Rezervasyon Kodu:
                            </label>
                            <input type="text" id="deleteReservationCode" 
                                   placeholder="{{ reservation.reservation_code }}" 
                                   style="width: 100%; padding: 10px; border: 2px solid #dc3545; border-radius: 5px; font-size: 16px; text-align: center; font-weight: bold;"
                                   autocomplete="off">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">
                                Onay Metni (DELETE yazın):
                            </label>
                            <input type="text" id="deleteConfirmText" 
                                   placeholder="DELETE" 
                                   style="width: 100%; padding: 10px; border: 2px solid #dc3545; border-radius: 5px; font-size: 16px; text-align: center; font-weight: bold; text-transform: uppercase;"
                                   autocomplete="off">
                        </div>
                    </div>
                    
                    <p style="color: #dc3545; font-size: 14px; font-weight: bold;">
                        <i class="fas fa-exclamation-circle"></i> Bu işlem geri alınamaz!
                    </p>
                </div>
                <div style="text-align: center; margin-top: 25px;">
                    <button onclick="confirmDeleteReservation()" id="confirmDeleteBtn" class="vb-button danger" style="padding: 12px 30px; font-size: 16px;" disabled>
                        <i class="fas fa-trash"></i> Silmeyi Onayla
                    </button>
                    <button onclick="backToDeleteStep1()" class="vb-button" style="padding: 12px 30px; font-size: 16px; margin-left: 10px;">
                        <i class="fas fa-arrow-left"></i> Geri
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentDeleteReservationId = null;

function openDeleteReservationModal(reservationId) {
    currentDeleteReservationId = reservationId;
    const modal = document.getElementById('deleteReservationModal');
    if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        // İlk aşamaya dön
        document.getElementById('deleteStep1').style.display = 'block';
        document.getElementById('deleteStep2').style.display = 'none';
        // Input'ları temizle
        document.getElementById('deleteReservationCode').value = '';
        document.getElementById('deleteConfirmText').value = '';
        document.getElementById('confirmDeleteBtn').disabled = true;
    }
}

function closeDeleteModal() {
    const modal = document.getElementById('deleteReservationModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = '';
    }
    currentDeleteReservationId = null;
}

function proceedToDeleteStep2() {
    document.getElementById('deleteStep1').style.display = 'none';
    document.getElementById('deleteStep2').style.display = 'block';
    
    // Input'lara odaklan
    setTimeout(() => {
        document.getElementById('deleteReservationCode').focus();
    }, 100);
    
    // Input değişikliklerini dinle
    const codeInput = document.getElementById('deleteReservationCode');
    const confirmInput = document.getElementById('deleteConfirmText');
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    
    function checkInputs() {
        const codeValue = codeInput.value.trim();
        const confirmValue = confirmInput.value.trim().toUpperCase();
        const expectedCode = '{{ reservation.reservation_code }}';
        
        if (codeValue === expectedCode && confirmValue === 'DELETE') {
            confirmBtn.disabled = false;
            confirmBtn.style.opacity = '1';
        } else {
            confirmBtn.disabled = true;
            confirmBtn.style.opacity = '0.5';
        }
    }
    
    codeInput.addEventListener('input', checkInputs);
    confirmInput.addEventListener('input', checkInputs);
}

function backToDeleteStep1() {
    document.getElementById('deleteStep1').style.display = 'block';
    document.getElementById('deleteStep2').style.display = 'none';
    document.getElementById('deleteReservationCode').value = '';
    document.getElementById('deleteConfirmText').value = '';
    document.getElementById('confirmDeleteBtn').disabled = true;
}

function confirmDeleteReservation() {
    if (!currentDeleteReservationId) {
        alert('Rezervasyon ID bulunamadı.');
        return;
    }
    
    const codeInput = document.getElementById('deleteReservationCode');
    const confirmInput = document.getElementById('deleteConfirmText');
    const codeValue = codeInput.value.trim();
    const confirmValue = confirmInput.value.trim().toUpperCase();
    const expectedCode = '{{ reservation.reservation_code }}';
    
    // Client-side doğrulama
    if (codeValue !== expectedCode) {
        alert('Rezervasyon kodu eşleşmiyor!');
        codeInput.focus();
        return;
    }
    
    if (confirmValue !== 'DELETE') {
        alert('Onay metni hatalı! Lütfen "DELETE" yazın.');
        confirmInput.focus();
        return;
    }
    
    // Butonu devre dışı bırak
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Siliniyor...';
    
    // CSRF token al
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                     document.cookie.match(/csrftoken=([^;]+)/)?.[1];
    
    // FormData oluştur
    const formData = new FormData();
    formData.append('confirm_step', '2');
    formData.append('reservation_code', codeValue);
    formData.append('final_confirm', confirmValue);
    
    // AJAX isteği gönder
    fetch(`/reception/reservations/${currentDeleteReservationId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Başarılı
            alert(data.message || 'Rezervasyon başarıyla silindi ve arşivlendi.');
            if (data.redirect_url) {
                window.location.href = data.redirect_url;
            } else {
                window.location.reload();
            }
        } else {
            // Hata
            alert(data.error || 'Rezervasyon silinirken bir hata oluştu.');
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '<i class="fas fa-trash"></i> Silmeyi Onayla';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Rezervasyon silinirken bir hata oluştu.');
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = '<i class="fas fa-trash"></i> Silmeyi Onayla';
    });
}

// ESC tuşu ile modal'ı kapat
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeDeleteModal();
    }
});
</script>
{% endblock %}
