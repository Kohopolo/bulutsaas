{% extends "tenant/base.html" %}
{% load static %}

{% block title %}Rezervasyon Listesi{% endblock %}

{% block content %}
<div class="content-body">
    <div class="groupbox">
        <div class="groupbox-header">
            <i class="fas fa-list"></i> Rezervasyon Listesi
            <div style="float: right;">
                <a href="{% url 'reception:reservation_archived_list' %}" class="vb-button" style="margin-right: 10px;">
                    <i class="fas fa-archive"></i> Silinmiş Rezervasyonlar Arşivi
                </a>
                <button onclick="openReservationModalLocal()" class="vb-button primary">
                    <i class="fas fa-plus"></i> Yeni Rezervasyon
                </button>
            </div>
        </div>
        <div class="groupbox-body">
            <!-- Gelişmiş Filtreler -->
            <div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border: 1px solid #d4d4d4; border-radius: 3px;">
                <form method="get" id="filterForm">
                    <!-- İlk Satır: Arama ve Temel Filtreler -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto auto; gap: 10px; margin-bottom: 10px; align-items: end;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: bold;">Ara</label>
                            <input type="text" name="search" placeholder="Rezervasyon kodu, müşteri adı, email, telefon..." 
                                   value="{{ request.GET.search }}" 
                                   style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 3px; width: 100%; font-size: 13px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: bold;">Durum</label>
                            <select name="status" style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 3px; width: 100%; font-size: 13px;">
                                <option value="">Tüm Durumlar</option>
                                {% for value, label in status_choices %}
                                <option value="{{ value }}" {% if request.GET.status == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: bold;">Kaynak</label>
                            <select name="source" style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 3px; width: 100%; font-size: 13px;">
                                <option value="">Tüm Kaynaklar</option>
                                {% for value, label in source_choices %}
                                <option value="{{ value }}" {% if request.GET.source == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: bold;">Oda Tipi</label>
                            <select name="room" style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 3px; width: 100%; font-size: 13px;">
                                <option value="">Tüm Oda Tipleri</option>
                                {% for room in rooms %}
                                <option value="{{ room.id }}" {% if request.GET.room == room.id|stringformat:"s" %}selected{% endif %}>{{ room.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <button type="submit" class="vb-button primary" style="width: 100%;">
                                <i class="fas fa-filter"></i> Filtrele
                            </button>
                        </div>
                        <div>
                            <a href="{% url 'reception:reservation_list' %}" class="vb-button" style="width: 100%;">
                                <i class="fas fa-times"></i> Temizle
                            </a>
                        </div>
                    </div>
                    
                    <!-- İkinci Satır: Tarih Filtreleri -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr) auto auto; gap: 10px; margin-bottom: 10px; align-items: end;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: bold;">Check-in Başlangıç</label>
                            <input type="date" name="check_in_from" value="{{ request.GET.check_in_from }}" 
                                   style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 3px; width: 100%; font-size: 13px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: bold;">Check-in Bitiş</label>
                            <input type="date" name="check_in_to" value="{{ request.GET.check_in_to }}" 
                                   style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 3px; width: 100%; font-size: 13px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: bold;">Check-out Başlangıç</label>
                            <input type="date" name="check_out_from" value="{{ request.GET.check_out_from }}" 
                                   style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 3px; width: 100%; font-size: 13px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: bold;">Check-out Bitiş</label>
                            <input type="date" name="check_out_to" value="{{ request.GET.check_out_to }}" 
                                   style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 3px; width: 100%; font-size: 13px;">
                        </div>
                        <div style="grid-column: span 2;"></div>
                    </div>
                    
                    <!-- Üçüncü Satır: Durum Filtreleri -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr) auto auto; gap: 10px; align-items: end;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: bold;">Check-in Durumu</label>
                            <select name="check_in_status" style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 3px; width: 100%; font-size: 13px;">
                                <option value="">Tümü</option>
                                <option value="yes" {% if request.GET.check_in_status == 'yes' %}selected{% endif %}>Yapıldı</option>
                                <option value="no" {% if request.GET.check_in_status == 'no' %}selected{% endif %}>Yapılmadı</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: bold;">Check-out Durumu</label>
                            <select name="check_out_status" style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 3px; width: 100%; font-size: 13px;">
                                <option value="">Tümü</option>
                                <option value="yes" {% if request.GET.check_out_status == 'yes' %}selected{% endif %}>Yapıldı</option>
                                <option value="no" {% if request.GET.check_out_status == 'no' %}selected{% endif %}>Yapılmadı</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: bold;">Ödeme Durumu</label>
                            <select name="payment_status" style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 3px; width: 100%; font-size: 13px;">
                                <option value="">Tümü</option>
                                <option value="paid" {% if request.GET.payment_status == 'paid' %}selected{% endif %}>Tamamlandı</option>
                                <option value="partial" {% if request.GET.payment_status == 'partial' %}selected{% endif %}>Kısmi</option>
                                <option value="unpaid" {% if request.GET.payment_status == 'unpaid' %}selected{% endif %}>Ödenmedi</option>
                            </select>
                        </div>
                        <div style="grid-column: span 2;"></div>
                    </div>
                </form>
            </div>

            <!-- Rezervasyon Tablosu -->
            <div class="datagrid">
                <div class="vb-datagrid-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Rezervasyon Kodu</th>
                                <th>Müşteri</th>
                                <th>Oda</th>
                                <th>Check-in</th>
                                <th>Check-out</th>
                                <th>Gece</th>
                                <th>Tutar</th>
                                <th>Durum</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reservation in reservations %}
                            <tr>
                                <td><strong>{{ reservation.reservation_code }}</strong></td>
                                <td>{{ reservation.customer.first_name }} {{ reservation.customer.last_name }}</td>
                                <td>{{ reservation.room.name }}{% if reservation.room_number %} - {{ reservation.room_number.number }}{% endif %}</td>
                                <td>{{ reservation.check_in_date|date:"d.m.Y" }}</td>
                                <td>{{ reservation.check_out_date|date:"d.m.Y" }}</td>
                                <td>{{ reservation.total_nights }}</td>
                                <td>{{ reservation.total_amount|floatformat:2 }} {{ reservation.currency }}</td>
                                <td>
                                    <span class="badge badge-{{ reservation.status }}">
                                        {{ reservation.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    <a href="{% url 'reception:reservation_detail' reservation.pk %}" class="vb-button small">Detay</a>
                                    <button onclick="openReservationEditModal({{ reservation.pk }})" class="vb-button small">Düzenle</button>
                                    <button onclick="changeReservationStatus({{ reservation.pk }})" class="vb-button small">Durum</button>
                                    <a href="{% url 'reception:reservation_voucher_create' reservation.pk %}" class="vb-button small">Voucher</a>
                                    <button onclick="refundReservation({{ reservation.pk }})" class="vb-button small">İade</button>
                                    <button onclick="openDeleteReservationModal({{ reservation.pk }}, '{{ reservation.reservation_code }}', '{{ reservation.customer.first_name }} {{ reservation.customer.last_name }}', '{{ reservation.room.name }}{% if reservation.room_number %} - {{ reservation.room_number.number }}{% endif %}', '{{ reservation.check_in_date|date:"d.m.Y" }}', '{{ reservation.check_out_date|date:"d.m.Y" }}')" class="vb-button small danger" style="background: #dc3545; color: white; border-color: #dc3545;">
                                        <i class="fas fa-trash"></i> Sil
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="9" style="text-align: center; padding: 40px; color: #999;">
                                    <i class="fas fa-inbox" style="font-size: 32px; display: block; margin-bottom: 10px;"></i>
                                    Henüz rezervasyon bulunmamaktadır.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Sayfalama -->
            {% if reservations.has_other_pages %}
            <div style="margin-top: 15px; text-align: center;">
                {% if reservations.has_previous %}
                <a href="?page={{ reservations.previous_page_number }}" class="vb-button">Önceki</a>
                {% endif %}
                <span style="margin: 0 10px;">Sayfa {{ reservations.number }} / {{ reservations.paginator.num_pages }}</span>
                {% if reservations.has_next %}
                <a href="?page={{ reservations.next_page_number }}" class="vb-button">Sonraki</a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Rezervasyon Modal -->
<!-- Form her zaman context'te olmalı, ama yine de kontrol edelim -->
{% if form %}
{% include 'reception/reservations/form_modal.html' %}
{% else %}
<!-- Form context'te yok, placeholder modal (bu durumda olmamalı) -->
<div id="reservationModal" class="vb-modal" style="display: none;">
    <div class="vb-modal-overlay" onclick="closeReservationModal()"></div>
    <div class="vb-modal-content">
        <div class="vb-modal-header">
            <h3 class="vb-modal-title">Yeni Rezervasyon</h3>
            <button type="button" class="vb-modal-close" onclick="closeReservationModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="vb-modal-body">
            <p style="text-align: center; padding: 40px; color: #666;">
                <i class="fas fa-exclamation-triangle" style="font-size: 48px; display: block; margin-bottom: 20px; color: #ff9800;"></i>
                Form yüklenemedi. Lütfen sayfayı yenileyin.
            </p>
        </div>
    </div>
</div>
{% endif %}

<script>
// Modal açma/kapama fonksiyonları
window.openReservationModalLocal = function() {
    console.log('openReservationModalLocal çağrıldı');
    
    // Flag'i sıfırla (yeni modal açıldığında veriler tekrar yüklensin)
    window.loadReservationDataExecuted = false;
    
    // Önce düzenleme modal container'ını temizle
    const editContainer = document.getElementById('reservationEditModalContainer');
    if (editContainer) {
        editContainer.innerHTML = '';
    }
    
    // Modal'ı bul - tüm sayfada ara (belki başka bir yerde render edilmiş)
    let modal = document.getElementById('reservationModal');
    console.log('Modal bulundu:', modal);
    
    // Eğer modal yoksa, form_modal.html include edilmemiş demektir
    if (!modal) {
        console.error('reservationModal elementi bulunamadı! Form modal render edilmemiş olabilir.');
        // Modal'ı dinamik olarak oluşturmayı dene
        console.warn('Modal bulunamadı, sayfayı yenileyin veya form context\'ini kontrol edin.');
        alert('Rezervasyon formu yüklenemedi. Lütfen sayfayı yenileyin.');
        return;
    }
    
    // Modal'ı göster
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    // Form'u resetle (yeni rezervasyon için)
    const form = document.getElementById('reservationForm');
    if (form) {
        form.reset();
        // Form action'ı yeni rezervasyon için ayarla
        const currentAction = form.action;
        if (currentAction.includes('/edit/')) {
            form.action = currentAction.replace(/\/\d+\/edit\//, '/create/');
        } else if (!currentAction.includes('/create/')) {
            // Eğer action'da create yoksa, doğru URL'i set et
            form.action = '{% url "reception:reservation_create" %}';
        }
        console.log('Form action:', form.action);
    } else {
        console.error('reservationForm elementi bulunamadı!');
    }
    
    // Event listener'ları bağla (eğer reception_reservation_form.js yüklendiyse)
    setTimeout(() => {
        if (typeof attachEventListeners === 'function') {
            attachEventListeners();
        }
        
        // İlk hesaplamaları yap
        if (typeof calculateNights === 'function') {
            calculateNights();
        }
        if (typeof updateGuestForms === 'function') {
            updateGuestForms();
        }
    }, 100);
};

window.closeReservationModalLocal = function() {
    // Flag'i sıfırla (modal kapatıldığında)
    window.loadReservationDataExecuted = false;
    
    // Tüm modal'ları kapat
    const modals = document.querySelectorAll('#reservationModal');
    modals.forEach(modal => {
        modal.style.display = 'none';
    });
    
    // Container'ı temizle (düzenleme modal'ı için)
    const container = document.getElementById('reservationEditModalContainer');
    if (container) {
        container.innerHTML = '';
    }
    
    // Body overflow'u düzelt
    document.body.style.overflow = '';
};

// Global fonksiyonları tanımla
// Eğer reception_reservation_form.js yüklenmişse, onun fonksiyonlarını kullan
// Değilse, local fonksiyonları kullan
if (typeof window.openReservationModal === 'undefined') {
    window.openReservationModal = window.openReservationModalLocal;
}
if (typeof window.closeReservationModal === 'undefined') {
    window.closeReservationModal = window.closeReservationModalLocal;
}

// ESC tuşu ile modal'ı kapat
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        if (typeof window.closeReservationModal === 'function') {
            window.closeReservationModal();
        }
    }
});

// Rezervasyon düzenleme modal'ını aç
function openReservationEditModal(reservationId) {
    // Flag'i sıfırla (yeni modal açıldığında veriler tekrar yüklensin)
    window.loadReservationDataExecuted = false;
    
    // Önce tüm mevcut modal'ları kapat ve DOM'dan kaldır
    const existingModals = document.querySelectorAll('#reservationModal');
    existingModals.forEach(modal => {
        if (modal.parentNode) {
            // Modal'ı DOM'dan tamamen kaldır (sadece gizlemek yeterli değil)
            modal.parentNode.removeChild(modal);
        }
    });
    
    // Container'ı temizle
    let container = document.getElementById('reservationEditModalContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'reservationEditModalContainer';
        document.body.appendChild(container);
    } else {
        container.innerHTML = '';
    }
    
    // AJAX ile formu yükle
    fetch(`/reception/reservations/${reservationId}/edit/`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        // Content-Type kontrolü
        const contentType = response.headers.get('content-type');
        
        // JSON response ise (yetki hatası)
        if (contentType && contentType.includes('application/json')) {
            return response.json().then(data => {
                throw new Error(data.error || 'Yetki hatası');
            });
        }
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        return response.text();
    })
    .then(html => {
        // HTML sayfası döndüyse (redirect veya hata sayfası)
        if (html.trim().startsWith('<!DOCTYPE') || html.trim().startsWith('<html')) {
            console.error('HTML sayfası döndü (muhtemelen yetki hatası veya redirect):', html.substring(0, 300));
            alert('Rezervasyon düzenleme formu yüklenirken bir hata oluştu. Lütfen sayfayı yenileyin ve tekrar deneyin.');
            return;
        }
        
        // Yeni modal'ı ekle
        container.innerHTML = html;
        
        // Modal'ı göster
        const modal = document.getElementById('reservationModal');
        if (modal) {
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // Tarih formatını düzelt (dd/mm/yyyy -> yyyy-MM-dd)
            const checkInDateField = document.getElementById('id_check_in_date');
            const checkOutDateField = document.getElementById('id_check_out_date');
            
            if (checkInDateField && checkInDateField.value) {
                const dateValue = checkInDateField.value;
                if (dateValue.includes('/')) {
                    const parts = dateValue.split('/');
                    if (parts.length === 3) {
                        const day = parts[0].padStart(2, '0');
                        const month = parts[1].padStart(2, '0');
                        const year = parts[2];
                        checkInDateField.value = `${year}-${month}-${day}`;
                    }
                }
            }
            
            if (checkOutDateField && checkOutDateField.value) {
                const dateValue = checkOutDateField.value;
                if (dateValue.includes('/')) {
                    const parts = dateValue.split('/');
                    if (parts.length === 3) {
                        const day = parts[0].padStart(2, '0');
                        const month = parts[1].padStart(2, '0');
                        const year = parts[2];
                        checkOutDateField.value = `${year}-${month}-${day}`;
                    }
                }
            }
            
            // Script'leri manuel olarak çalıştır (innerHTML script'leri çalıştırmaz)
            const scripts = container.querySelectorAll('script');
            scripts.forEach(script => {
                const newScript = document.createElement('script');
                if (script.src) {
                    // External script
                    newScript.src = script.src;
                    newScript.onload = () => {
                        // Script yüklendikten sonra verileri yükle
                        setTimeout(() => {
                            if (typeof window.loadReservationData === 'function') {
                                window.loadReservationData();
                            }
                        }, 300);
                    };
                    document.head.appendChild(newScript);
                } else {
                    // Inline script
                    newScript.textContent = script.textContent;
                    document.head.appendChild(newScript);
                    // Script çalıştıktan sonra verileri yükle
                    setTimeout(() => {
                        if (typeof window.loadReservationData === 'function') {
                            window.loadReservationData();
                        }
                    }, 300);
                }
            });
            
            // Script'lerin yüklenmesi için kısa bir gecikme
            setTimeout(() => {
                // Event listener'ları bağla
                if (typeof attachEventListeners === 'function') {
                    attachEventListeners();
                }
                
                // İlk hesaplamaları yap
                if (typeof calculateNights === 'function') {
                    calculateNights();
                    calculateTotalAmount();
                    updateRemainingAmount();
                }
                if (typeof updateGuestForms === 'function') {
                    updateGuestForms();
                }
                
                // Rezervasyon verilerini yükle (müşteri, misafir, ödeme)
                if (typeof window.loadReservationData === 'function') {
                    window.loadReservationData();
                }
            }, 800);
        } else {
            console.error('Modal bulunamadı! HTML:', html.substring(0, 200));
        }
    })
    .catch(error => {
        console.error('Modal yükleme hatası:', error);
        alert('Rezervasyon düzenleme formu yüklenirken bir hata oluştu.');
    });
}

// Form submit handler (hem yeni rezervasyon hem de düzenleme için)
document.addEventListener('submit', function(e) {
    const form = e.target;
    if (form.id === 'reservationForm') {
        e.preventDefault();
        
        // Form verilerini hazırla
        const formData = new FormData(form);
        
        // Formset management form alanlarını ekle (eğer varsa)
        const totalForms = document.querySelector('input[name="guests-TOTAL_FORMS"]')?.value;
        const initialForms = document.querySelector('input[name="guests-INITIAL_FORMS"]')?.value;
        const minNumForms = document.querySelector('input[name="guests-MIN_NUM_FORMS"]')?.value;
        const maxNumForms = document.querySelector('input[name="guests-MAX_NUM_FORMS"]')?.value;
        
        if (totalForms !== undefined && totalForms !== null) {
            formData.set('guests-TOTAL_FORMS', totalForms);
        }
        if (initialForms !== undefined && initialForms !== null) {
            formData.set('guests-INITIAL_FORMS', initialForms);
        }
        if (minNumForms !== undefined && minNumForms !== null) {
            formData.set('guests-MIN_NUM_FORMS', minNumForms);
        }
        if (maxNumForms !== undefined && maxNumForms !== null) {
            formData.set('guests-MAX_NUM_FORMS', maxNumForms);
        }
        
        // Misafir bilgilerini formData'ya ekle (JavaScript ile oluşturulan alanlar)
        const adultCount = parseInt(document.getElementById('id_adult_count')?.value) || 0;
        const childCount = parseInt(document.getElementById('id_child_count')?.value) || 0;
        
        // Formset kullanılıyor mu kontrol et
        const isFormsetMode = totalForms !== undefined && totalForms !== null;
        
        if (isFormsetMode) {
            // Formset modunda, formset alanlarını FormData'ya ekle (zaten form içinde olmalı)
            // FormData zaten form'dan alındığı için formset alanları otomatik eklenmiş olmalı
            // Ancak, formset içindeki tüm alanların gönderildiğinden emin olmak için kontrol et
            console.log('Formset modu aktif, management form alanları:', {
                totalForms,
                initialForms,
                minNumForms,
                maxNumForms
            });
            
            // Formset içindeki tüm form alanlarını kontrol et ve eksik olanları ekle
            const formsetFormCount = parseInt(totalForms) || 0;
            for (let i = 0; i < formsetFormCount; i++) {
                // Eğer nationality alanı yoksa, varsayılan değeri ekle
                const nationalityField = document.querySelector(`input[name="guests-${i}-nationality"]`);
                if (!nationalityField || !nationalityField.value) {
                    formData.set(`guests-${i}-nationality`, 'Türkiye');
                }
            }
        } else {
            // Dinamik form modunda, management form alanlarını oluştur
            const totalGuests = adultCount + childCount;
            formData.set('guests-TOTAL_FORMS', totalGuests.toString());
            formData.set('guests-INITIAL_FORMS', '0');
            formData.set('guests-MIN_NUM_FORMS', '0');
            formData.set('guests-MAX_NUM_FORMS', '1000');
            
            // Dinamik form alanlarını formset formatına çevir
            let formsetIndex = 0;
            
            // Yetişkin misafir bilgilerini formset formatına ekle
            for (let i = 1; i <= adultCount; i++) {
                const firstName = document.querySelector(`input[name="adult_guest_${i}_first_name"]`)?.value;
                const lastName = document.querySelector(`input[name="adult_guest_${i}_last_name"]`)?.value;
                const tcNo = document.querySelector(`input[name="adult_guest_${i}_tc_no"]`)?.value;
                const idSerial = document.querySelector(`input[name="adult_guest_${i}_id_serial_no"]`)?.value;
                const gender = document.querySelector(`select[name="adult_guest_${i}_gender"]`)?.value;
                const passportNo = document.querySelector(`input[name="adult_guest_${i}_passport_no"]`)?.value;
                
                if (firstName || lastName) {
                    if (firstName) formData.append(`guests-${formsetIndex}-first_name`, firstName);
                    if (lastName) formData.append(`guests-${formsetIndex}-last_name`, lastName);
                    if (tcNo) formData.append(`guests-${formsetIndex}-tc_no`, tcNo);
                    if (idSerial) formData.append(`guests-${formsetIndex}-id_serial_no`, idSerial);
                    if (gender) formData.append(`guests-${formsetIndex}-gender`, gender);
                    if (passportNo) formData.append(`guests-${formsetIndex}-passport_no`, passportNo);
                    // nationality alanını ekle (varsayılan: Türkiye)
                    const nationality = document.querySelector(`input[name="adult_guest_${i}_nationality"]`)?.value || 'Türkiye';
                    formData.append(`guests-${formsetIndex}-nationality`, nationality);
                    formData.append(`guests-${formsetIndex}-guest_type`, 'adult');
                    formData.append(`guests-${formsetIndex}-guest_order`, formsetIndex + 1);
                    formsetIndex++;
                }
            }
            
            // Çocuk misafir bilgilerini formset formatına ekle
            for (let i = 1; i <= childCount; i++) {
                const firstName = document.querySelector(`input[name="child_guest_${i}_first_name"]`)?.value;
                const lastName = document.querySelector(`input[name="child_guest_${i}_last_name"]`)?.value;
                const age = document.querySelector(`input[name="child_guest_${i}_age"]`)?.value;
                const gender = document.querySelector(`select[name="child_guest_${i}_gender"]`)?.value;
                const tcNo = document.querySelector(`input[name="child_guest_${i}_tc_no"]`)?.value;
                const passportNo = document.querySelector(`input[name="child_guest_${i}_passport_no"]`)?.value;
                const passportSerial = document.querySelector(`input[name="child_guest_${i}_passport_serial_no"]`)?.value;
                
                if (firstName || lastName) {
                    if (firstName) formData.append(`guests-${formsetIndex}-first_name`, firstName);
                    if (lastName) formData.append(`guests-${formsetIndex}-last_name`, lastName);
                    if (age) formData.append(`guests-${formsetIndex}-age`, age);
                    if (gender) formData.append(`guests-${formsetIndex}-gender`, gender);
                    if (tcNo) formData.append(`guests-${formsetIndex}-tc_no`, tcNo);
                    if (passportNo) formData.append(`guests-${formsetIndex}-passport_no`, passportNo);
                    if (passportSerial) formData.append(`guests-${formsetIndex}-passport_serial_no`, passportSerial);
                    // nationality alanını ekle (varsayılan: Türkiye)
                    const nationality = document.querySelector(`input[name="child_guest_${i}_nationality"]`)?.value || 'Türkiye';
                    formData.append(`guests-${formsetIndex}-nationality`, nationality);
                    formData.append(`guests-${formsetIndex}-guest_type`, 'child');
                    formData.append(`guests-${formsetIndex}-guest_order`, formsetIndex + 1);
                    formsetIndex++;
                }
            }
            
            // TOTAL_FORMS'u güncelle
            formData.set('guests-TOTAL_FORMS', formsetIndex.toString());
        }
        
        // Ödeme bilgilerini ekle
        const advancePayment = document.getElementById('advance_payment')?.value;
        const paymentMethod = document.getElementById('payment_method')?.value;
        if (advancePayment) formData.append('advance_payment', advancePayment);
        if (paymentMethod) formData.append('payment_method', paymentMethod);
        
        // Müşteri bilgilerini ekle (form'da olmayabilir)
        const customerFirstName = document.getElementById('customer_first_name')?.value;
        const customerLastName = document.getElementById('customer_last_name')?.value;
        const customerPhone = document.getElementById('customer_phone')?.value;
        const customerEmail = document.getElementById('customer_email')?.value;
        const customerAddress = document.getElementById('customer_address')?.value;
        const customerTcNo = document.getElementById('customer_tc_no')?.value;
        const customerNationality = document.getElementById('customer_nationality')?.value;
        
        if (customerFirstName) formData.append('customer_first_name', customerFirstName);
        if (customerLastName) formData.append('customer_last_name', customerLastName);
        if (customerPhone) formData.append('customer_phone', customerPhone);
        if (customerEmail) formData.append('customer_email', customerEmail);
        if (customerAddress) formData.append('customer_address', customerAddress);
        if (customerTcNo) formData.append('customer_tc_no', customerTcNo);
        if (customerNationality) formData.append('customer_nationality', customerNationality);
        
        console.log('Form gönderiliyor:', form.action);
        console.log('Misafir sayıları:', { adultCount, childCount });
        console.log('Ödeme bilgileri:', { advancePayment, paymentMethod });
        
        // AJAX ile formu gönder
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Response headers:', Object.fromEntries(response.headers.entries()));
            
            const contentType = response.headers.get('content-type');
            console.log('Content-Type:', contentType);
            
            if (contentType && contentType.includes('application/json')) {
                return response.json().then(data => {
                    console.log('JSON Response:', data);
                    return data;
                });
            } else {
                return response.text().then(text => {
                    console.log('Text Response length:', text.length);
                    console.log('Text Response preview:', text.substring(0, 200));
                    
                    // HTML döndüyse (redirect veya hata sayfası)
                    if (text.trim().startsWith('<!DOCTYPE') || text.trim().startsWith('<html')) {
                        throw new Error('HTML sayfası döndü (muhtemelen redirect veya hata)');
                    }
                    // JSON parse edilebilir mi dene
                    try {
                        const parsed = JSON.parse(text);
                        console.log('Parsed JSON:', parsed);
                        return parsed;
                    } catch (e) {
                        console.error('JSON parse hatası:', e);
                        throw new Error('Geçersiz response formatı: ' + text.substring(0, 100));
                    }
                });
            }
        })
        .then(data => {
            if (data.success) {
                // Başarılı, sayfayı yenile veya yönlendir
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else if (data.reservation_id) {
                    window.location.href = `/reception/reservations/${data.reservation_id}/`;
                } else {
                    window.location.reload();
                }
            } else {
                // Hata var, formu güncelle
                console.error('Form hataları:', data.errors);
                console.error('Tam hata response:', data);
                console.error('Hata mesajı (tam):', data.message);
                
                // Hata mesajlarını topla
                let errorMessages = [];
                if (data.message) {
                    errorMessages.push(data.message);
                }
                if (data.errors) {
                    if (typeof data.errors === 'object') {
                        Object.keys(data.errors).forEach(key => {
                            const errorValue = data.errors[key];
                            console.log(`Hata alanı ${key}:`, errorValue);
                            if (Array.isArray(errorValue)) {
                                errorValue.forEach(err => {
                                    console.log(`  - ${err}`);
                                    errorMessages.push(`${key}: ${err}`);
                                });
                            } else if (typeof errorValue === 'string') {
                                errorMessages.push(`${key}: ${errorValue}`);
                            } else {
                                errorMessages.push(`${key}: ${JSON.stringify(errorValue)}`);
                            }
                        });
                    } else {
                        errorMessages.push(String(data.errors));
                    }
                }
                
                const errorText = errorMessages.length > 0 
                    ? errorMessages.join('\n') 
                    : 'Bilinmeyen hata';
                
                console.error('Toplanan hata mesajları:', errorMessages);
                alert('Form gönderilirken hatalar oluştu:\n\n' + errorText);
            }
        })
        .catch(error => {
            console.error('Form gönderme hatası:', error);
            alert('Form gönderilirken bir hata oluştu: ' + error.message);
        });
    }
});
</script>

<!-- Rezervasyon Düzenleme Modal Container -->
<div id="reservationEditModalContainer"></div>

<script>
// Rezervasyon durum değiştirme
function changeReservationStatus(reservationId) {
    if (confirm('Rezervasyon durumunu değiştirmek istediğinize emin misiniz?')) {
        window.location.href = `/reception/reservations/${reservationId}/status-change/`;
    }
}

// Rezervasyon iadesi
function refundReservation(reservationId) {
    if (confirm('Rezervasyon iadesi yapmak istediğinize emin misiniz?')) {
        window.location.href = `/reception/reservations/${reservationId}/refund/`;
    }
}

// Rezervasyon silme modalı
let currentDeleteReservationId = null;
let currentDeleteReservationCode = null;

function openDeleteReservationModal(reservationId, reservationCode, customerName, roomName, checkIn, checkOut) {
    currentDeleteReservationId = reservationId;
    currentDeleteReservationCode = reservationCode;
    
    // Modal HTML'ini dinamik olarak oluştur
    const modalHtml = `
        <div id="deleteReservationModal" class="vb-modal" style="display: flex;">
            <div class="vb-modal-overlay" onclick="closeDeleteModal()"></div>
            <div class="vb-modal-content" style="max-width: 500px;">
                <div class="vb-modal-header">
                    <h3 class="vb-modal-title">
                        <i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i> Rezervasyon Sil
                    </h3>
                    <button type="button" class="vb-modal-close" onclick="closeDeleteModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="vb-modal-body">
                    <div id="deleteStep1">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 64px; color: #dc3545; margin-bottom: 20px;"></i>
                            <h3 style="color: #dc3545; margin-bottom: 15px;">Dikkat!</h3>
                            <p style="font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
                                Bu rezervasyonu silmek istediğinizden <strong>emin misiniz?</strong>
                            </p>
                            <div style="background: #fff3cd; padding: 15px; border-radius: 5px; border-left: 4px solid #ffc107; margin-bottom: 20px; text-align: left;">
                                <strong>Rezervasyon Bilgileri:</strong><br>
                                <strong>Kod:</strong> ${reservationCode}<br>
                                <strong>Müşteri:</strong> ${customerName}<br>
                                <strong>Oda:</strong> ${roomName}<br>
                                <strong>Tarih:</strong> ${checkIn} - ${checkOut}
                            </div>
                            <p style="color: #666; font-size: 14px;">
                                <i class="fas fa-info-circle"></i> Rezervasyon silinecek ve arşive eklenecektir. Bu işlem geri alınamaz.
                            </p>
                        </div>
                        <div style="text-align: center; margin-top: 25px;">
                            <button onclick="proceedToDeleteStep2()" class="vb-button danger" style="padding: 12px 30px; font-size: 16px;">
                                <i class="fas fa-check"></i> Evet, Devam Et
                            </button>
                            <button onclick="closeDeleteModal()" class="vb-button" style="padding: 12px 30px; font-size: 16px; margin-left: 10px;">
                                <i class="fas fa-times"></i> İptal
                            </button>
                        </div>
                    </div>
                    <div id="deleteStep2" style="display: none;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <i class="fas fa-shield-alt" style="font-size: 64px; color: #dc3545; margin-bottom: 20px;"></i>
                            <h3 style="color: #dc3545; margin-bottom: 15px;">Son Onay</h3>
                            <p style="font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
                                Silme işlemini tamamlamak için aşağıdaki bilgileri girin:
                            </p>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 5px; margin-bottom: 20px; text-align: left;">
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">
                                        Rezervasyon Kodu:
                                    </label>
                                    <input type="text" id="deleteReservationCode" 
                                           placeholder="${reservationCode}" 
                                           style="width: 100%; padding: 10px; border: 2px solid #dc3545; border-radius: 5px; font-size: 16px; text-align: center; font-weight: bold;"
                                           autocomplete="off">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">
                                        Onay Metni (DELETE yazın):
                                    </label>
                                    <input type="text" id="deleteConfirmText" 
                                           placeholder="DELETE" 
                                           style="width: 100%; padding: 10px; border: 2px solid #dc3545; border-radius: 5px; font-size: 16px; text-align: center; font-weight: bold; text-transform: uppercase;"
                                           autocomplete="off">
                                </div>
                            </div>
                            <p style="color: #dc3545; font-size: 14px; font-weight: bold;">
                                <i class="fas fa-exclamation-circle"></i> Bu işlem geri alınamaz!
                            </p>
                        </div>
                        <div style="text-align: center; margin-top: 25px;">
                            <button onclick="confirmDeleteReservation()" id="confirmDeleteBtn" class="vb-button danger" style="padding: 12px 30px; font-size: 16px;" disabled>
                                <i class="fas fa-trash"></i> Silmeyi Onayla
                            </button>
                            <button onclick="backToDeleteStep1()" class="vb-button" style="padding: 12px 30px; font-size: 16px; margin-left: 10px;">
                                <i class="fas fa-arrow-left"></i> Geri
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Eski modal'ı kaldır
    const oldModal = document.getElementById('deleteReservationModal');
    if (oldModal) {
        oldModal.remove();
    }
    
    // Yeni modal'ı ekle
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    document.body.style.overflow = 'hidden';
}

function closeDeleteModal() {
    const modal = document.getElementById('deleteReservationModal');
    if (modal) {
        modal.remove();
        document.body.style.overflow = '';
    }
    currentDeleteReservationId = null;
    currentDeleteReservationCode = null;
}

function proceedToDeleteStep2() {
    document.getElementById('deleteStep1').style.display = 'none';
    document.getElementById('deleteStep2').style.display = 'block';
    
    setTimeout(() => {
        document.getElementById('deleteReservationCode').focus();
    }, 100);
    
    const codeInput = document.getElementById('deleteReservationCode');
    const confirmInput = document.getElementById('deleteConfirmText');
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    
    function checkInputs() {
        const codeValue = codeInput.value.trim();
        const confirmValue = confirmInput.value.trim().toUpperCase();
        const expectedCode = currentDeleteReservationCode || '';
        
        if (codeValue === expectedCode && confirmValue === 'DELETE') {
            confirmBtn.disabled = false;
            confirmBtn.style.opacity = '1';
        } else {
            confirmBtn.disabled = true;
            confirmBtn.style.opacity = '0.5';
        }
    }
    
    codeInput.addEventListener('input', checkInputs);
    confirmInput.addEventListener('input', checkInputs);
}

function backToDeleteStep1() {
    document.getElementById('deleteStep1').style.display = 'block';
    document.getElementById('deleteStep2').style.display = 'none';
    document.getElementById('deleteReservationCode').value = '';
    document.getElementById('deleteConfirmText').value = '';
    document.getElementById('confirmDeleteBtn').disabled = true;
}

function confirmDeleteReservation() {
    if (!currentDeleteReservationId) {
        alert('Rezervasyon ID bulunamadı.');
        return;
    }
    
    const codeInput = document.getElementById('deleteReservationCode');
    const confirmInput = document.getElementById('deleteConfirmText');
    const codeValue = codeInput.value.trim();
    const confirmValue = confirmInput.value.trim().toUpperCase();
    const expectedCode = currentDeleteReservationCode || '';
    
    if (codeValue !== expectedCode) {
        alert('Rezervasyon kodu eşleşmiyor!');
        codeInput.focus();
        return;
    }
    
    if (confirmValue !== 'DELETE') {
        alert('Onay metni hatalı! Lütfen "DELETE" yazın.');
        confirmInput.focus();
        return;
    }
    
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Siliniyor...';
    
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                     document.cookie.match(/csrftoken=([^;]+)/)?.[1];
    
    const formData = new FormData();
    formData.append('confirm_step', '2');
    formData.append('reservation_code', codeValue);
    formData.append('final_confirm', confirmValue);
    
    fetch(`/reception/reservations/${currentDeleteReservationId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message || 'Rezervasyon başarıyla silindi ve arşivlendi.');
            if (data.redirect_url) {
                window.location.href = data.redirect_url;
            } else {
                window.location.reload();
            }
        } else {
            alert(data.error || 'Rezervasyon silinirken bir hata oluştu.');
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '<i class="fas fa-trash"></i> Silmeyi Onayla';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Rezervasyon silinirken bir hata oluştu.');
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = '<i class="fas fa-trash"></i> Silmeyi Onayla';
    });
}
</script>
{% endblock %}
