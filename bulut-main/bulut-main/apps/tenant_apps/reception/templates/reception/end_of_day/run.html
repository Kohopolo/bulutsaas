{% extends "tenant/base.html" %}
{% load static %}

{% block title %}Gün Sonu İşlemini Çalıştır - {{ hotel.name }}{% endblock %}

{% block content %}
<div class="content-body">
    <div class="groupbox">
        <div class="groupbox-header">
            <i class="fas fa-play"></i> Gün Sonu İşlemini Çalıştır - {{ hotel.name }}
            <div style="float: right;">
                {% if accessible_hotels|length > 1 %}
                <select id="hotelSelect" onchange="changeHotel()" class="vb-button" style="margin-right: 10px; padding: 8px 15px;">
                    {% for h in accessible_hotels %}
                    <option value="{{ h.id }}" {% if h.id == hotel.id %}selected{% endif %}>{{ h.name }}</option>
                    {% endfor %}
                </select>
                {% endif %}
                <a href="{% url 'reception:end_of_day_dashboard' %}?hotel_id={{ hotel.id }}" class="vb-button">
                    <i class="fas fa-arrow-left"></i> Geri
                </a>
            </div>
        </div>
        <div class="groupbox-body">
            <!-- Otel Bilgisi -->
            <div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border: 1px solid #90caf9; border-radius: 3px;">
                <h3 style="margin: 0; color: #1976d2;">
                    <i class="fas fa-hotel"></i> {{ hotel.name }}
                </h3>
                <p style="margin: 5px 0 0 0; color: #666; font-size: 13px;">
                    Gün sonu işlemi bu otel için yapılacaktır.
                </p>
            </div>

            <!-- Mevcut İşlem Uyarısı -->
            {% if existing_operation %}
            <div class="form-groupbox" style="margin-bottom: 20px; background: {% if existing_operation.status == 'completed' %}#d4edda{% elif existing_operation.status == 'failed' %}#f8d7da{% else %}#fff3cd{% endif %}; border: 1px solid {% if existing_operation.status == 'completed' %}#c3e6cb{% elif existing_operation.status == 'failed' %}#f5c6cb{% else %}#ffc107{% endif %};">
                <div class="groupbox-body">
                    <h4 style="margin: 0 0 10px 0; color: {% if existing_operation.status == 'completed' %}#155724{% elif existing_operation.status == 'failed' %}#721c24{% else %}#856404{% endif %};">
                        <i class="fas fa-{% if existing_operation.status == 'completed' %}check-circle{% elif existing_operation.status == 'failed' %}exclamation-triangle{% else %}clock{% endif %}"></i>
                        Mevcut İşlem Bulundu
                    </h4>
                    <p style="margin: 0; color: {% if existing_operation.status == 'completed' %}#155724{% elif existing_operation.status == 'failed' %}#721c24{% else %}#856404{% endif %};">
                        <strong>Tarih:</strong> {{ existing_operation.operation_date|date:"d.m.Y" }}<br>
                        <strong>Durum:</strong> {{ existing_operation.get_status_display }}<br>
                        {% if existing_operation.started_at %}
                        <strong>Başlangıç:</strong> {{ existing_operation.started_at|date:"d.m.Y H:i" }}<br>
                        {% endif %}
                        {% if existing_operation.completed_at %}
                        <strong>Bitiş:</strong> {{ existing_operation.completed_at|date:"d.m.Y H:i" }}<br>
                        {% endif %}
                    </p>
                    <div style="margin-top: 15px;">
                        <a href="{% url 'reception:end_of_day_operation_detail' existing_operation.pk %}" class="vb-button">
                            <i class="fas fa-eye"></i> İşlem Detayını Görüntüle
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Ayarlar Özeti -->
            <div class="form-groupbox" style="margin-bottom: 20px;">
                <div class="groupbox-header">
                    <i class="fas fa-cog"></i> Mevcut Ayarlar
                </div>
                <div class="groupbox-body">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div>
                            <strong>Pre-Audit Kontrolleri:</strong>
                            <ul style="margin: 5px 0; padding-left: 20px;">
                                <li>Oda Fiyatı Sıfır Kontrolü: {% if settings.stop_if_room_price_zero %}<span style="color: green;">✓ Aktif</span>{% else %}<span style="color: red;">✗ Pasif</span>{% endif %}</li>
                                <li>Peşin Folyo Balansı Kontrolü: {% if settings.stop_if_advance_folio_balance_not_zero %}<span style="color: green;">✓ Aktif</span>{% else %}<span style="color: red;">✗ Pasif</span>{% endif %}</li>
                                <li>Checkout Folyoları Kontrolü: {% if settings.check_checkout_folios %}<span style="color: green;">✓ Aktif</span>{% else %}<span style="color: red;">✗ Pasif</span>{% endif %}</li>
                            </ul>
                        </div>
                        <div>
                            <strong>Otomatik İşlemler:</strong>
                            <ul style="margin: 5px 0; padding-left: 20px;">
                                <li>No-Show İptal: {% if settings.cancel_no_show_reservations %}<span style="color: green;">✓ Aktif</span>{% else %}<span style="color: red;">✗ Pasif</span>{% endif %}</li>
                                <li>Checkout Olmamışları Uzat: {% if settings.extend_non_checkout_reservations %}<span style="color: green;">✓ Aktif</span>{% else %}<span style="color: red;">✗ Pasif</span>{% endif %}</li>
                                <li>Oda Değişim Planlarını İptal: {% if settings.cancel_room_change_plans %}<span style="color: green;">✓ Aktif</span>{% else %}<span style="color: red;">✗ Pasif</span>{% endif %}</li>
                            </ul>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                        <a href="{% url 'reception:end_of_day_settings_hotel' hotel.id %}" class="vb-button">
                            <i class="fas fa-edit"></i> Ayarları Düzenle
                        </a>
                    </div>
                </div>
            </div>

            <!-- İşlem Başlatma -->
            {% if can_run %}
            <div class="form-groupbox" style="margin-bottom: 20px;">
                <div class="groupbox-header">
                    <i class="fas fa-play-circle"></i> İşlemi Başlat
                </div>
                <div class="groupbox-body">
                    <form method="post" id="runForm">
                        {% csrf_token %}
                        <div style="padding: 20px; background: #f8f9fa; border-radius: 3px; margin-bottom: 15px;">
                            <p style="margin: 0 0 10px 0; font-weight: bold;">Gün sonu işlemini başlatmak istediğinizden emin misiniz?</p>
                            <p style="margin: 0; color: #666; font-size: 13px;">
                                Bu işlem şunları yapacaktır:
                            </p>
                            <ul style="margin: 10px 0 0 20px; color: #666; font-size: 13px;">
                                <li>Pre-audit kontrollerini çalıştıracak</li>
                                <li>Folyo kontrollerini yapacak</li>
                                <li>No-show rezervasyonları işleyecek</li>
                                <li>Oda fiyatlarını güncelleyecek</li>
                                <li>Gelir dağılımını yapacak</li>
                                <li>Muhasebe fişlerini oluşturacak</li>
                                <li>Raporları oluşturacak</li>
                                <li>Sistem tarihini güncelleyecek</li>
                            </ul>
                        </div>
                        <div style="text-align: right;">
                            <button type="submit" class="vb-button primary" style="font-size: 16px; padding: 12px 30px;">
                                <i class="fas fa-play"></i> İşlemi Başlat
                            </button>
                            <a href="{% url 'reception:end_of_day_dashboard' %}?hotel_id={{ hotel.id }}" class="vb-button">
                                <i class="fas fa-times"></i> İptal
                            </a>
                        </div>
                    </form>
                </div>
            </div>
            {% else %}
            <div class="form-groupbox" style="margin-bottom: 20px; background: #fff3cd; border: 1px solid #ffc107;">
                <div class="groupbox-body" style="text-align: center; padding: 20px;">
                    <i class="fas fa-info-circle" style="font-size: 48px; color: #ffc107; margin-bottom: 10px;"></i>
                    <h3 style="margin: 10px 0; color: #856404;">Bugün için gün sonu işlemi zaten tamamlanmış</h3>
                    <p style="color: #856404; margin-bottom: 15px;">Yeni bir işlem başlatmak için lütfen yarını bekleyin veya mevcut işlemi görüntüleyin.</p>
                    <a href="{% url 'reception:end_of_day_operation_detail' existing_operation.pk %}" class="vb-button primary">
                        <i class="fas fa-eye"></i> Mevcut İşlemi Görüntüle
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function changeHotel() {
    const hotelId = document.getElementById('hotelSelect').value;
    window.location.href = '{% url "reception:end_of_day_run_hotel" 0 %}'.replace('0', hotelId);
}

// Form gönderilirken loading göster
document.getElementById('runForm').addEventListener('submit', function() {
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> İşlem Başlatılıyor...';
});
</script>
{% endblock %}

