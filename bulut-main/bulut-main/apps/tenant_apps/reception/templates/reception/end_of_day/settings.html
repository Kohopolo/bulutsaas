{% extends "tenant/base.html" %}
{% load static %}

{% block title %}Gün Sonu Ayarları - {{ hotel.name }}{% endblock %}

{% block content %}
<div class="content-body">
    <div class="groupbox">
        <div class="groupbox-header">
            <i class="fas fa-cog"></i> Gün Sonu Ayarları - {{ hotel.name }}
            <div style="float: right;">
                {% if accessible_hotels|length > 1 %}
                <select id="hotelSelect" onchange="changeHotel()" class="vb-button" style="margin-right: 10px; padding: 8px 15px;">
                    {% for h in accessible_hotels %}
                    <option value="{{ h.id }}" {% if h.id == hotel.id %}selected{% endif %}>{{ h.name }}</option>
                    {% endfor %}
                </select>
                {% endif %}
                <a href="{% url 'reception:end_of_day_dashboard' %}?hotel_id={{ hotel.id }}" class="vb-button">
                    <i class="fas fa-arrow-left"></i> Geri
                </a>
            </div>
        </div>
        <div class="groupbox-body">
            <form method="post">
                {% csrf_token %}
                
                <!-- Pre-Audit Kontrol Ayarları -->
                <div class="form-groupbox" style="margin-bottom: 20px;">
                    <div class="groupbox-header">
                        <i class="fas fa-shield-alt"></i> Pre-Audit Kontrol Ayarları
                    </div>
                    <div class="groupbox-body">
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                {{ form.stop_if_room_price_zero }}
                                <span style="margin-left: 10px;">
                                    <strong>{{ form.stop_if_room_price_zero.label }}</strong>
                                    <br>
                                    <small style="color: #666;">{{ form.stop_if_room_price_zero.help_text }}</small>
                                </span>
                            </label>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                {{ form.stop_if_advance_folio_balance_not_zero }}
                                <span style="margin-left: 10px;">
                                    <strong>{{ form.stop_if_advance_folio_balance_not_zero.label }}</strong>
                                    <br>
                                    <small style="color: #666;">{{ form.stop_if_advance_folio_balance_not_zero.help_text }}</small>
                                </span>
                            </label>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                {{ form.check_checkout_folios }}
                                <span style="margin-left: 10px;">
                                    <strong>{{ form.check_checkout_folios.label }}</strong>
                                    <br>
                                    <small style="color: #666;">{{ form.check_checkout_folios.help_text }}</small>
                                </span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Otomatik İşlem Ayarları -->
                <div class="form-groupbox" style="margin-bottom: 20px;">
                    <div class="groupbox-header">
                        <i class="fas fa-robot"></i> Otomatik İşlem Ayarları
                    </div>
                    <div class="groupbox-body">
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                {{ form.cancel_no_show_reservations }}
                                <span style="margin-left: 10px;">
                                    <strong>{{ form.cancel_no_show_reservations.label }}</strong>
                                    <br>
                                    <small style="color: #666;">{{ form.cancel_no_show_reservations.help_text }}</small>
                                </span>
                            </label>
                        </div>
                        {% if form.cancel_no_show_reservations.value %}
                        <div style="margin-left: 30px; margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">
                                <strong>{{ form.no_show_action.label }}</strong>
                            </label>
                            {{ form.no_show_action }}
                            <small style="color: #666; display: block; margin-top: 5px;">{{ form.no_show_action.help_text }}</small>
                        </div>
                        {% endif %}
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                {{ form.extend_non_checkout_reservations }}
                                <span style="margin-left: 10px;">
                                    <strong>{{ form.extend_non_checkout_reservations.label }}</strong>
                                    <br>
                                    <small style="color: #666;">{{ form.extend_non_checkout_reservations.help_text }}</small>
                                </span>
                            </label>
                        </div>
                        {% if form.extend_non_checkout_reservations.value %}
                        <div style="margin-left: 30px; margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">
                                <strong>{{ form.extend_days.label }}</strong>
                            </label>
                            {{ form.extend_days }}
                            <small style="color: #666; display: block; margin-top: 5px;">{{ form.extend_days.help_text }}</small>
                        </div>
                        {% endif %}
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                {{ form.cancel_room_change_plans }}
                                <span style="margin-left: 10px;">
                                    <strong>{{ form.cancel_room_change_plans.label }}</strong>
                                    <br>
                                    <small style="color: #666;">{{ form.cancel_room_change_plans.help_text }}</small>
                                </span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Otomasyon Ayarları -->
                <div class="form-groupbox" style="margin-bottom: 20px;">
                    <div class="groupbox-header">
                        <i class="fas fa-clock"></i> Otomasyon Ayarları
                    </div>
                    <div class="groupbox-body">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">
                                <strong>{{ form.automation_type.label }}</strong>
                            </label>
                            {{ form.automation_type }}
                            <small style="color: #666; display: block; margin-top: 5px;">{{ form.automation_type.help_text }}</small>
                        </div>
                        {% if form.automation_type.value == 'scheduled' %}
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">
                                <strong>{{ form.auto_run_time.label }}</strong>
                            </label>
                            {{ form.auto_run_time }}
                            <small style="color: #666; display: block; margin-top: 5px;">{{ form.auto_run_time.help_text }}</small>
                        </div>
                        {% endif %}
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                {{ form.is_active }}
                                <span style="margin-left: 10px;">
                                    <strong>{{ form.is_active.label }}</strong>
                                </span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Genel Ayarlar -->
                <div class="form-groupbox" style="margin-bottom: 20px;">
                    <div class="groupbox-header">
                        <i class="fas fa-sliders-h"></i> Genel Ayarlar
                    </div>
                    <div class="groupbox-body">
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                {{ form.enable_rollback }}
                                <span style="margin-left: 10px;">
                                    <strong>{{ form.enable_rollback.label }}</strong>
                                    <br>
                                    <small style="color: #666;">{{ form.enable_rollback.help_text }}</small>
                                </span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Notlar -->
                <div class="form-groupbox" style="margin-bottom: 20px;">
                    <div class="groupbox-header">
                        <i class="fas fa-sticky-note"></i> Notlar
                    </div>
                    <div class="groupbox-body">
                        {{ form.notes }}
                    </div>
                </div>

                <!-- Form Hataları -->
                {% if form.errors %}
                <div style="margin-bottom: 20px; padding: 15px; background: #fee; border: 1px solid #fcc; border-radius: 3px;">
                    <strong style="color: #c00;">Lütfen aşağıdaki hataları düzeltin:</strong>
                    <ul style="margin: 10px 0 0 20px; color: #c00;">
                        {% for field, errors in form.errors.items %}
                        {% for error in errors %}
                        <li>{{ field }}: {{ error }}</li>
                        {% endfor %}
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- Kaydet Butonu -->
                <div style="text-align: right; margin-top: 20px;">
                    <button type="submit" class="vb-button primary">
                        <i class="fas fa-save"></i> Ayarları Kaydet
                    </button>
                    <a href="{% url 'reception:end_of_day_dashboard' %}?hotel_id={{ hotel.id }}" class="vb-button">
                        <i class="fas fa-times"></i> İptal
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function changeHotel() {
    const hotelId = document.getElementById('hotelSelect').value;
    window.location.href = '{% url "reception:end_of_day_settings_hotel" 0 %}'.replace('0', hotelId);
}

// Checkbox değişikliklerinde ilgili alanları göster/gizle
document.addEventListener('DOMContentLoaded', function() {
    const cancelNoShow = document.getElementById('id_cancel_no_show_reservations');
    const noShowAction = document.getElementById('id_no_show_action').closest('div');
    const extendNonCheckout = document.getElementById('id_extend_non_checkout_reservations');
    const extendDays = document.getElementById('id_extend_days').closest('div');
    const automationType = document.getElementById('id_automation_type');
    const autoRunTime = document.getElementById('id_auto_run_time').closest('div');

    function toggleFields() {
        if (cancelNoShow.checked) {
            noShowAction.style.display = 'block';
        } else {
            noShowAction.style.display = 'none';
        }

        if (extendNonCheckout.checked) {
            extendDays.style.display = 'block';
        } else {
            extendDays.style.display = 'none';
        }

        if (automationType.value === 'scheduled') {
            autoRunTime.style.display = 'block';
        } else {
            autoRunTime.style.display = 'none';
        }
    }

    cancelNoShow.addEventListener('change', toggleFields);
    extendNonCheckout.addEventListener('change', toggleFields);
    automationType.addEventListener('change', toggleFields);
    toggleFields();
});
</script>
{% endblock %}

